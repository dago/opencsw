From a3f705dbf1e546b6564415a8694f975757b3f19e Mon Sep 17 00:00:00 2001
From: Dagobert Michelsen <daÂm@opencsw.org>
Date: Tue, 24 Apr 2012 23:27:33 +0200
Subject: [PATCH] Various Solaris fixes

---
 configure.ac           |    2 +-
 src/crypto/base64.h    |    2 +-
 src/crypto/byteorder.h |   26 ++++++++++++++++++++++++++
 src/crypto/crypto.cc   |    3 ++-
 src/crypto/crypto.h    |    5 +++++
 src/crypto/ocb.cc      |    9 ++++++++-
 src/crypto/prng.h      |    5 +++++
 src/terminal/parser.cc |    3 ++-
 8 files changed, 50 insertions(+), 5 deletions(-)

diff --git a/configure.ac b/configure.ac
index 2e03605..b526d59 100644
--- a/configure.ac
+++ b/configure.ac
@@ -157,7 +157,7 @@ AC_CHECK_DECL([htobe64],
   [AC_CHECK_DECL([OSSwapHostToBigInt64],
      [AC_DEFINE([HAVE_OSX_SWAP], [1],
         [Define if OSSwapHostToBigInt64 and friends exist.])],
-     [AC_MSG_ERROR([Unable to find byte swapping functions])],
+     [],
      [[#include <libkern/OSByteOrder.h>]])],
   [[#include <endian.h>]])
 
diff --git a/src/crypto/base64.h b/src/crypto/base64.h
index 7593e59..46eab7a 100644
--- a/src/crypto/base64.h
+++ b/src/crypto/base64.h
@@ -27,7 +27,7 @@
 # include <stddef.h>
 
 /* Get bool. */
-# include <stdbool.h>
+/* # include <stdbool.h> */
 
 /* This uses that the expression (n+(k-1))/k means the smallest
    integer >= n/k, i.e., the ceiling of n/k.  */
diff --git a/src/crypto/byteorder.h b/src/crypto/byteorder.h
index f0c7f06..14a03de 100644
--- a/src/crypto/byteorder.h
+++ b/src/crypto/byteorder.h
@@ -31,4 +31,30 @@
 # define be16toh OSSwapBigToHostInt16
 #endif
 
+/* Taken from http://licq.sourcearchive.com/documentation/1.3.8/licq__byteorder_8h-source.html */ 
+
+// Solaris header for endian and byte swap
+#if defined(__sun) || defined(sun)
+# include <sys/byteorder.h>
+
+// Solaris defines endian by setting _LITTLE_ENDIAN or _BIG_ENDIAN
+# ifdef _BIG_ENDIAN
+#  define IS_BIG_ENDIAN
+# endif
+# ifdef _LITTLE_ENDIAN
+#  define IS_LITTLE_ENDIAN
+# endif
+
+// Solaris 10 defines bswap functions: BSWAP_16, BSWAP_32, BSWAP_64
+// Solaris 10 defines conversion functions: BE_16, BE_32, BE_64, LE_16, LE_32, LE_64
+// BSD defines conversion functions: betoh16, betoh32, betoh64, letoh16, letoh32, letoh64
+# define betoh64(x) BE_64(x)
+# define letoh64(x) LE_64(x)
+
+#define htobe64(x) BE_64(x)
+#define be64toh(x) BE_64(x)
+
+#endif
+
+
 #endif
diff --git a/src/crypto/crypto.cc b/src/crypto/crypto.cc
index e4f928f..497c6ea 100644
--- a/src/crypto/crypto.cc
+++ b/src/crypto/crypto.cc
@@ -263,7 +263,8 @@ Message Session::decrypt( string ciphertext )
     exit( 1 );
   }
 
-  Nonce __attribute__((__aligned__ (16))) nonce( str, 8 );
+  /* Nonce __attribute__((__aligned__ (16))) nonce( str, 8 ); */
+  Nonce nonce( str, 8 );
   char *body = (char *)aligned_alloc( body_len );
   memcpy( body, str + 8, body_len );
 
diff --git a/src/crypto/crypto.h b/src/crypto/crypto.h
index 1a2d897..20a4a76 100644
--- a/src/crypto/crypto.h
+++ b/src/crypto/crypto.h
@@ -22,7 +22,12 @@
 #include "ae.h"
 #include <string>
 #include <string.h>
+
+#if defined( HAVE_STDINT_H )
 #include <stdint.h>
+#elsif defined( HAVE_INTTYPES_H )
+  #include <inttypes.h>
+#endif
 
 using std::string;
 
diff --git a/src/crypto/ocb.cc b/src/crypto/ocb.cc
index 8176896..790d96a 100644
--- a/src/crypto/ocb.cc
+++ b/src/crypto/ocb.cc
@@ -74,6 +74,9 @@
 #include <stdlib.h>
 #include <string.h>
 
+#include "config.h"
+#include <inttypes.h>
+
 /* Define standard sized integers                                          */
 #if defined(_MSC_VER) && (_MSC_VER < 1600)
 	typedef unsigned __int8  uint8_t;
@@ -81,7 +84,11 @@
 	typedef unsigned __int64 uint64_t;
 	typedef          __int64 int64_t;
 #else
-	#include <stdint.h>
+#if HAVE_STDINT_H
+#include <stdint.h>
+#elsif HAVE_INTTYPES_H
+  #include <inttypes.h>
+#endif
 #endif
 
 /* Compiler-specific intrinsics and fixes: bswap64, ntz                    */
diff --git a/src/crypto/prng.h b/src/crypto/prng.h
index fdaf48e..0d89d79 100644
--- a/src/crypto/prng.h
+++ b/src/crypto/prng.h
@@ -23,7 +23,12 @@
 #include <stdio.h>
 #include <errno.h>
 #include <string.h>
+
+#if defined( HAVE_STDINT_H )
 #include <stdint.h>
+#elsif defined( HAVE_INTTYPES_H )
+  #include <inttypes.h>
+#endif
 
 #include "crypto.h"
 
diff --git a/src/terminal/parser.cc b/src/terminal/parser.cc
index 227763f..0de6ff4 100644
--- a/src/terminal/parser.cc
+++ b/src/terminal/parser.cc
@@ -20,7 +20,8 @@
 #include <typeinfo>
 #include <errno.h>
 #include <wchar.h>
-#include <stdint.h>
+/* #include <stdint.h> */
+#include <inttypes.h>
 
 #include "parser.h"
 
-- 
1.7.10

