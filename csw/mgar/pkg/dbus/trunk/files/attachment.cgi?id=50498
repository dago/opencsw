From bf6bd403c7d74b2bc9e7bef53bce3d69d47870ac Mon Sep 17 00:00:00 2001
From: Simon McVittie <simon.mcvittie@collabora.co.uk>
Date: Tue, 23 Aug 2011 16:14:21 +0100
Subject: [PATCH 2/2] Add a semi-automatic test for _dbus_system_log

---
 test/Makefile.am        |    5 ++
 test/internals/syslog.c |  100 +++++++++++++++++++++++++++++++++++++++++++++++
 2 files changed, 105 insertions(+), 0 deletions(-)
 create mode 100644 test/internals/syslog.c

diff --git a/test/Makefile.am b/test/Makefile.am
index e5fd756..54ba823 100644
--- a/test/Makefile.am
+++ b/test/Makefile.am
@@ -101,6 +101,10 @@ test_refs_SOURCES = internals/refs.c
 test_refs_CPPFLAGS = -DDBUS_STATIC_BUILD $(GLIB_CFLAGS)
 test_refs_LDADD = libdbus-testutils.la $(GLIB_LIBS) $(TEST_LIBS)
 
+test_syslog_SOURCES = internals/syslog.c
+test_syslog_CPPFLAGS = -DDBUS_STATIC_BUILD $(GLIB_CFLAGS)
+test_syslog_LDADD = libdbus-testutils.la $(GLIB_LIBS) $(TEST_LIBS)
+
 EXTRA_DIST = dbus-test-runner
 
 testexecdir = $(libdir)/dbus-1.0/test
@@ -114,6 +118,7 @@ installable_tests = \
 	test-marshal \
 	test-refs \
 	test-relay \
+	test-syslog \
 	$(NULL)
 
 installcheck_tests =
diff --git a/test/internals/syslog.c b/test/internals/syslog.c
new file mode 100644
index 0000000..4f6b7c2
--- /dev/null
+++ b/test/internals/syslog.c
@@ -0,0 +1,100 @@
+/* Manual regression test for syslog support
+ *
+ * Author: Simon McVittie <simon.mcvittie@collabora.co.uk>
+ * Copyright Â© 2011 Nokia Corporation
+ *
+ * Permission is hereby granted, free of charge, to any person
+ * obtaining a copy of this software and associated documentation files
+ * (the "Software"), to deal in the Software without restriction,
+ * including without limitation the rights to use, copy, modify, merge,
+ * publish, distribute, sublicense, and/or sell copies of the Software,
+ * and to permit persons to whom the Software is furnished to do so,
+ * subject to the following conditions:
+ *
+ * The above copyright notice and this permission notice shall be
+ * included in all copies or substantial portions of the Software.
+ *
+ * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
+ * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
+ * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
+ * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS
+ * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN
+ * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
+ * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
+ * SOFTWARE.
+ */
+
+#include <config.h>
+
+#include <stdlib.h>
+
+#include <glib.h>
+
+#define DBUS_COMPILATION    /* this test uses libdbus-internal */
+#include <dbus/dbus.h>
+#include <dbus/dbus-sysdeps.h>
+
+typedef struct {
+    int dummy;
+} Fixture;
+
+static void
+setup (Fixture *f,
+    gconstpointer data)
+{
+}
+
+/* hopefully clear enough that people don't think these messages in syslog
+ * are a bug */
+#define MESSAGE "regression test for _dbus_system_log(): "
+
+static void
+test_syslog (Fixture *f,
+    gconstpointer data)
+{
+  if (g_test_trap_fork (0, 0))
+    {
+      _dbus_init_system_log ();
+      _dbus_system_log (DBUS_SYSTEM_LOG_FATAL, MESSAGE "%d", 23);
+      /* should not be reached: exit 0 so the assertion in the main process
+       * will fail */
+      exit (0);
+    }
+
+  g_test_trap_assert_failed ();
+  g_test_trap_assert_stderr ("*" MESSAGE "23\n*");
+
+  if (g_test_trap_fork (0, 0))
+    {
+      _dbus_init_system_log ();
+      _dbus_system_log (DBUS_SYSTEM_LOG_INFO, MESSAGE "%d", 42);
+      _dbus_system_log (DBUS_SYSTEM_LOG_SECURITY, MESSAGE "%d", 666);
+      exit (0);
+    }
+
+  g_test_trap_assert_passed ();
+  g_test_trap_assert_stderr ("*" MESSAGE "42\n*" MESSAGE "666\n*");
+
+  /* manual test (this is the best we can do on Windows) */
+  _dbus_init_system_log ();
+  _dbus_system_log (DBUS_SYSTEM_LOG_INFO, MESSAGE "%d", 42);
+  _dbus_system_log (DBUS_SYSTEM_LOG_SECURITY, MESSAGE "%d", 666);
+}
+
+static void
+teardown (Fixture *f,
+    gconstpointer data)
+{
+}
+
+int
+main (int argc,
+    char **argv)
+{
+  g_test_init (&argc, &argv, NULL);
+  g_test_bug_base ("https://bugs.freedesktop.org/show_bug.cgi?id=");
+
+  g_test_add ("/syslog", Fixture, NULL, setup, test_syslog, teardown);
+
+  return g_test_run ();
+}
-- 
1.7.5.4

