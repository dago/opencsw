NAME = findutils
VERSION = 4.4.2
CATEGORIES = utils

DESCRIPTION = A set of utilities for searching a filesystem
define BLURB
  The findutils package consists of three programs. `find' is a program which
  searches a directory tree to find a file or group of files. It walks the
  directory tree and reports all occurences of a file matching the user's
  specifications. `locate' scans one or more databases of filenames and
  displays any matches. `xargs' builds and executes command lines by gathering
  together arguments it reads on the standard input. Most often, these
  arguments are lists of file names generated by `find'.
endef

CHECKPKG_OVERRIDES_CSWfindutils += file-with-bad-content|/usr/local|root/opt/csw/share/info/find.info
CHECKPKG_OVERRIDES_CSWfindutils += file-collision|/opt/csw/gnu/oldfind|CSWfindutils|CSWgnulinks
CHECKPKG_OVERRIDES_CSWfindutils += file-collision|/opt/csw/gnu/xargs|CSWfindutils|CSWgnulinks
CHECKPKG_OVERRIDES_CSWfindutils += file-collision|/opt/csw/gnu/find|CSWfindutils|CSWgnulinks
CHECKPKG_OVERRIDES_CSWfindutils += file-collision|/opt/csw/gnu/locate|CSWfindutils|CSWgnulinks
CHECKPKG_OVERRIDES_CSWfindutils += file-collision|/opt/csw/gnu/updatedb|CSWfindutils|CSWgnulinks


MASTER_SITES = $(GNU_MIRROR)
DISTFILES  = $(NAME)-$(VERSION).tar.gz
DISTFILES += CSWfindutils.postinstall
DISTFILES += CSWfindutils.cswreleasenotes

RUNTIME_DEP_PKGS = CSWlibintl8

# We define upstream file regex so we can be notifed of new upstream software release
UFILES_REGEX = $(NAME)-(\d+(?:\.\d+)*).tar.gz

EXTRA_MERGE_EXCLUDE_FILES  = /opt/csw/lib/charset.alias 
EXTRA_MERGE_EXCLUDE_FILES += /opt/csw/share/info/dir

CONFIGURE_ARGS  = $(DIRPATHS)
CONFIGURE_ARGS += --program-prefix=g
CONFIGURE_ARGS += --localstatedir=/var/opt/csw

# Use OPT_FLAGS_SOS instead instead of CFLAGS_EXTRA, because we want -fast
# to be first, and to have portions of it overridden by the ISA specific
# items per modulation.  Otherwise, we end up with everything being 'native',
# because that's what -fast does if it's last in the list.
OPT_FLAGS_SOS = -fast -xnolibmopt


# Test target requires GNU diff
TEST_TARGET = check
TEST_ARGS = "PATH=/opt/csw/gnu:$$PATH"

# 12 of the tests fail:
# iregex1.old-O0
# iregex1.new-O0
# iregex1.old-O1
# iregex1.new-O1
# iregex1.old-O2
# iregex1.new-O2
# iregex1.old-O3
# iregex1.new-O3
# 
# FAIL: parent.old-O0, /home/gmarler/svnwork/findutils/trunk/work/solaris9-sparc/build-isa-sparcv8/findutils-4.4.2/find/testsuite/../oldfind: .: Permission denied
# FAIL: parent.old-O1, /home/gmarler/svnwork/findutils/trunk/work/solaris9-sparc/build-isa-sparcv8/findutils-4.4.2/find/testsuite/../oldfind: .: Permission denied
# FAIL: parent.old-O2, /home/gmarler/svnwork/findutils/trunk/work/solaris9-sparc/build-isa-sparcv8/findutils-4.4.2/find/testsuite/../oldfind: .: Permission denied
# FAIL: parent.old-O3, /home/gmarler/svnwork/findutils/trunk/work/solaris9-sparc/build-isa-sparcv8/findutils-4.4.2/find/testsuite/../oldfind: .: Permission denied

# Skip tests until the following is resolved, or we can backport the fixes as patches
#   https://savannah.gnu.org/bugs/?30883
SKIPTEST ?= 1

include gar/category.mk

# ./configure determines to add a second -R/opt/csw/lib (libtool?), strip it
#
# configure:37145: checking how to link with libiconv
# configure:37147: result: /opt/csw/lib/libiconv.so -R/opt/csw/lib
# ...
# configure:37775: checking how to link with libintl
# configure:37777: result: /opt/csw/lib/libintl.so -R/opt/csw/lib
#

post-configure-modulated:
	@perl -pi -e 's|-R/opt/csw/lib||' $(WORKSRC)/*/Makefile
	@$(MAKECOOKIE)

#
# Provide /opt/csw/gnu links via this target
#
post-install-modulated:
	ginstall -d $(DESTDIR)$(prefix)/gnu
	$(foreach G,$(notdir $(wildcard $(DESTDIR)$(bindir)/*)),ln -s ../bin/$G $(DESTDIR)$(prefix)/gnu/$(patsubst g%,%,$G);)
	@$(MAKECOOKIE)

