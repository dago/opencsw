#
# Long-term TODO:
# See branches/sync-pkgname for an attempt to sync the CSW pkg name to
# the upstream name and split off a devel pkg.
#
GARNAME = libiconv
GARVERSION = 1.13.1
CATEGORIES = lib

DESCRIPTION = GNU iconv library
define BLURB
  Some programs, like mailers and web browsers, must be able to convert
  between a given text encoding and the user's encoding. Other programs
  internally store strings in Unicode, to facilitate internal processing,
  and need to convert between internal string representation (Unicode) and
  external string representation (a traditional encoding) when they are
  doing I/O. GNU libiconv is a conversion library for both kinds of
  applications. 
endef

MASTER_SITES = $(GNU_MIRROR)
DISTFILES = $(GARNAME)-$(GARVERSION).tar.gz
UFILES_REGEX = $(GARNAME)-(\d+(?:\.\d+)*).tar.gz

# Package naming is a bit unfortunate CSWiconv vs. libiconv :/ but
# that's not something i want to change right now. CSWiconv has
# heaps of dependents.
PACKAGES = CSWiconv
CATALOGNAME_CSWiconv = libiconv

# The current 1.12 only has a 32-Bit iconv binary, leave it that way
EXTRA_MERGE_EXCLUDE_FILES = /opt/csw/bin/.*/iconv
NOISAEXEC = 1
BUILD64 = 1

# Optimize. -fast causes ./configure on Sparc to hang on the stdbool.h test.
# Patch the stdbool test away, stdbool is only available in C99 anyway.
#
# See the following posts for details
# - http://lists.opencsw.org/pipermail/maintainers/2009-July/003152.html
# - http://forums.sun.com/thread.jspa?threadID=5397065&tstart=0
OPT_FLAGS_SOS = -fast -xnolibmopt
PATCHFILES += patch-configure-stdbool.diff

# 'gmake test' shows three errors of coredumping printf's
#
#   ./check-translitfailure . TranslitFail1 ISO-8859-1 ASCII
#   ./check-subst
#   Segmentation Fault - core dumped
#   Segmentation Fault - core dumped
#   Segmentation Fault - core dumped
#   ./test-shiftseq
#
# This is due to bug #6550204
#   http://sunsolve.sun.com/search/document.do?assetkey=1-1-6550204-1
# and can safely be ignored as it is a failure in the testsuite.
TEST_TARGET = check

CONFIGURE_ARGS = $(DIRPATHS)
CONFIGURE_ARGS += --disable-rpath

include gar/category.mk

post-install-modulated: DOCDEST=$(DESTDIR)$(docdir)/$(GARNAME)
post-install-modulated:
	ginstall -d $(DOCDEST)
	cp $(FILEDIR)/changelog.CSW $(DOCDEST)
	ginstall -D $(WORKSRC)/srcm4/iconv.m4 \
		$(DESTDIR)$(datadir)/aclocal/iconv.m4
	@$(MAKECOOKIE)
