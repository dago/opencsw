#!/bin/sh
#
# Copyright (c) 1992 - 2001 by Sun Microsystems, Inc.
# All rights reserved.
#
#ident  "@(#)nrpe       1.19    01/12/05 SMI"
# Modified for CSW by Alex Moore 2005-12-03
# 2007-08-18 Add pid file support.
# 2007-08-19 Fix nagios uid used for pgrep.  Thanks to Will McDonald for this.

CONFIG_FILE=/etc/opt/csw/nrpe.cfg
if [ ! -f $CONFIG_FILE ] ; then
    CONFIG_FILE=/opt/csw/nagios/etc/nrpe.cfg
fi
BIN_FILE="/opt/csw/bin/nrpe"
pidfile=`grep '^pid_file' $CONFIG_FILE |awk '{ FS = "=" } {print $2;}'`
NRPE_USER=`awk -F'=' '/nrpe_user/ { print $NF }' $CONFIG_FILE`

case "$1" in
'restart')
        [ -n "`pgrep -x -u 0,1,$NRPE_USER nrpe`" ] && /usr/bin/kill `head -1 $pidfile`
        # remove pid file
        if [ -f "$pidfile" ]; then
            rm "$pidfile"
        fi
        if [ -f $CONFIG_FILE ]; then
            wait 1
            $BIN_FILE -c $CONFIG_FILE -d
        fi
        ;;

'start')
        if [ -f $CONFIG_FILE ]; then
            $BIN_FILE -c $CONFIG_FILE -d
        fi
        ;;

'stop') 
        [ -n "`pgrep -x -u 0,1,$NRPE_USER nrpe`" ] && /usr/bin/kill `head -1 $pidfile`
        # remove pid file
        if [ -f "$pidfile" ]; then
            rm "$pidfile"
        fi
        ;;

*)
        echo "Usage: $0 { start | stop | restart }"
        exit 1
        ;;
esac
exit 0
