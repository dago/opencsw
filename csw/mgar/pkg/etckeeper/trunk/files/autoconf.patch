diff --git a/.gitignore b/.gitignore
new file mode 100644
index 0000000..a831c89
--- /dev/null
+++ b/.gitignore
@@ -0,0 +1,10 @@
+configure
+autom4te.cache
+Makefile
+config.log
+config.status
+etckeeper
+etckeeper.conf
+Makefile
+Makefile.in
+etckeeper.8
diff --git a/Makefile b/Makefile
deleted file mode 100644
index b2d6565..0000000
--- a/Makefile
+++ /dev/null
@@ -1,48 +0,0 @@
-# You should configure etckeeper.conf for your distribution before
-# installing etckeeper.
-CONFFILE=etckeeper.conf
-include $(CONFFILE)
-
-DESTDIR?=
-prefix=/usr
-sbindir=${prefix}/sbin
-etcdir=/etc
-mandir=${prefix}/share/man
-vardir=/var
-
-INSTALL=install 
-INSTALL_EXE=${INSTALL} -D
-INSTALL_DATA=${INSTALL} -m 0644 -D
-
-build: etckeeper.spec
-	-./etckeeper-bzr/__init__.py build || echo "** bzr support not built"
-	
-install:
-	mkdir -p $(DESTDIR)$(etcdir)/etckeeper/ $(DESTDIR)$(vardir)/cache/etckeeper/
-	cp -a *.d $(DESTDIR)$(etcdir)/etckeeper/
-	$(INSTALL_DATA) $(CONFFILE) $(DESTDIR)$(etcdir)/etckeeper/etckeeper.conf
-	$(INSTALL_EXE) etckeeper $(DESTDIR)$(sbindir)/etckeeper
-	$(INSTALL_DATA) etckeeper.8 $(DESTDIR)$(mandir)/man8/etckeeper.8
-	$(INSTALL_DATA) bash_completion $(DESTDIR)$(etcdir)/bash_completion.d/etckeeper
-ifeq ($(HIGHLEVEL_PACKAGE_MANAGER),apt)
-	$(INSTALL_DATA) apt.conf $(DESTDIR)$(etcdir)/apt/apt.conf.d/05etckeeper
-	mkdir -p $(DESTDIR)$(etcdir)/cruft/filters-unex
-	$(INSTALL_DATA) cruft_filter $(DESTDIR)$(etcdir)/cruft/filters-unex/etckeeper
-endif
-ifeq ($(LOWLEVEL_PACKAGE_MANAGER),pacman-g2)
-	$(INSTALL_DATA) pacman-g2.hook $(DESTDIR)$(etcdir)/pacman-g2/hooks/etckeeper
-endif
-ifeq ($(HIGHLEVEL_PACKAGE_MANAGER),yum)
-	$(INSTALL_DATA) yum-etckeeper.py $(DESTDIR)$(prefix)/lib/yum-plugins/etckeeper.py
-	$(INSTALL_DATA) yum-etckeeper.conf $(DESTDIR)$(etcdir)/yum/pluginconf.d/etckeeper.conf
-endif
-	-./etckeeper-bzr/__init__.py install --root=$(DESTDIR) || echo "** bzr support not installed"
-	echo "** installation successful"
-
-clean: etckeeper.spec
-	rm -rf build
-
-etckeeper.spec:
-	sed -i "s/Version:.*/Version: $$(perl -e '$$_=<>;print m/\((.*?)\)/'<debian/changelog)/" etckeeper.spec
-
-.PHONY: etckeeper.spec
diff --git a/Makefile.am b/Makefile.am
new file mode 100644
index 0000000..1418a4f
--- /dev/null
+++ b/Makefile.am
@@ -0,0 +1,84 @@
+sysconfdirdir = $(sysconfdir)/$(PACKAGE)
+sbin_SCRIPTS = etckeeper
+man_MANS = etckeeper.8
+sysconfdir_DATA = etckeeper.conf
+
+KEEPERSCRIPTS = $(wildcard *.d)
+KSFILES = $(foreach KD,$(KEEPERSCRIPTS),$(wildcard $(KD)/*))
+KSINPUTS = $(filter %.in,$(KSFILES))
+KSINPUTTRANS = $(patsubst %.in,%,$(KSINPUTS))
+KSNONINPUTS = $(filter-out %.in,$(KSFILES))
+
+APTFILES = apt.conf
+YUMFILES = yum-etckeeper.py yum-etckeeper.conf
+PACMANFILES = pacman-g2.hook
+BASHFILES = bash_completion
+CRUFTFILES = cruft_filter
+
+OPTS =
+if INST_BASH_COMPLETION
+OPTS += inst-bash
+endif
+if INST_CRUFT_FILTER
+OPTS += inst-cruft
+endif
+
+EXTRA_DIST = $(NEED_SUBST) $(APTFILES) $(YUMFILES) $(PACMANFILES) $(KEEPERSCRIPTFILES) $(BASHFILES) $(CRUFTFILES) $(KSINPUTS)
+
+CLEANFILES = $(sbin_SCRIPTS) $(man8_MANS) $(sysconfdir_DATA) $(KSINPUTTRANS)
+
+NEED_SUBST = etckeeper.in etckeeper.conf.in etckeeper.8.in $(KSINPUTS)
+
+# files that need autoconf-ish substitutions.
+REQ_SUBST = $(NEED_SUBST:.in=)
+
+do_subst = sed \
+		-e 's|@datadir[@]|$(pkgdatadir)|g' \
+		-e 's|@prefix[@]|$(prefix)|g' \
+		-e 's|@sysconfdir[@]|$(sysconfdir)|g' \
+		-e 's|@docdir[@]|$(docdir)|g' \
+		-e 's|@HIGHLEVEL[@]|$(HIGHLEVEL)|g' \
+		-e 's|@LOWLEVEL[@]|$(LOWLEVEL)|g' \
+		-e 's|@VCS[@]|$(VCS)|g' \
+		-e 's|@SHELLPATH[@]|$(SHELLPATH)|g'
+
+$(REQ_SUBST): % : %.in Makefile
+	$(do_subst) < $(srcdir)/$< > $@
+
+high-apt: apt.conf
+	$(MKDIR_P) $(DESTDIR)/$(sysconfdir)/apt/apt.conf.d
+	$(INSTALL_DATA) apt.conf $(DESTDIR)/$(sysconfdir)/apt/apt.conf.d/05etckeeper
+
+low-dpkg:
+	/bin/true
+
+high-yum: yum-etckeeper.py yum-etckeeper.conf
+	$(MKDIR_P) $(DESTDIR)$(libdir)/yum-plugins $(DESTDIR)$(sysconfdir)/yum
+	$(INSTALL_DATA) yum-etckeeper.py $(DESTDIR)$(libdir)/yum-plugins/
+	$(INSTALL_DATA) yum-etckeeper.conf $(DESTDIR)$(sysconfdir)/yum/
+
+low-rpm:
+	/bin/true
+
+high-pacman-g2:
+	/bin/true
+
+low-pacman-g2:
+	$(MKDIR_P) $(DESTDIR)$(sysconfdir)/pacman-g2/hooks
+	$(INSTALL_DATA)  pacman-g2.hook $(DESTDIR)/$(sysconfdir)/pacman-g2/hook/
+
+inst-bash:
+	$(MKDIR_P) $(DESTDIR)$(sysconfdir)/bash_completion.d
+	$(INSTALL_DATA) bash_completion $(DESTDIR)$(sysconfdir)/bash_completion.d/etckeeper
+
+inst-cruft:
+	$(MKDIR_P) $(DESTDIR)$(sysconfdir)/cruft/filters-unex
+	$(INSTALL_DATA) cruft_filter $(DESTDIR)$(sysconfdir)/cruft/filters-unex/etckeeper
+
+$(KEEPERSCRIPTS): $(KSINPUTTRANS)
+	$(MKDIR_P) $(DESTDIR)$(sysconfdirdir)/$@
+	$(INSTALL_SCRIPT) $(filter $@/%,$(KSINPUTTRANS)) $(DESTDIR)$(sysconfdirdir)/$@
+	$(if $(filter $@/%,$(KSNONINPUTS)),$(INSTALL_DATA) $(filter $@/%,$(KSNONINPUTS)) $(DESTDIR)$(sysconfdirdir)/$@)
+
+install-data-local: $(KEEPERSCRIPTS) high-$(HIGHLEVEL) low-$(LOWLEVEL) $(OPTS)
+
diff --git a/aclocal.m4 b/aclocal.m4
new file mode 100644
index 0000000..9d33cbe
--- /dev/null
+++ b/aclocal.m4
@@ -0,0 +1,589 @@
+# generated automatically by aclocal 1.10.2 -*- Autoconf -*-
+
+# Copyright (C) 1996, 1997, 1998, 1999, 2000, 2001, 2002, 2003, 2004,
+# 2005, 2006, 2007, 2008  Free Software Foundation, Inc.
+# This file is free software; the Free Software Foundation
+# gives unlimited permission to copy and/or distribute it,
+# with or without modifications, as long as this notice is preserved.
+
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
+# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
+# PARTICULAR PURPOSE.
+
+m4_ifndef([AC_AUTOCONF_VERSION],
+  [m4_copy([m4_PACKAGE_VERSION], [AC_AUTOCONF_VERSION])])dnl
+m4_if(m4_defn([AC_AUTOCONF_VERSION]), [2.63],,
+[m4_warning([this file was generated for autoconf 2.63.
+You have another version of autoconf.  It may work, but is not guaranteed to.
+If you have problems, you may need to regenerate the build system entirely.
+To do so, use the procedure documented by the package, typically `autoreconf'.])])
+
+# Copyright (C) 2002, 2003, 2005, 2006, 2007, 2008  Free Software Foundation, Inc.
+#
+# This file is free software; the Free Software Foundation
+# gives unlimited permission to copy and/or distribute it,
+# with or without modifications, as long as this notice is preserved.
+
+# AM_AUTOMAKE_VERSION(VERSION)
+# ----------------------------
+# Automake X.Y traces this macro to ensure aclocal.m4 has been
+# generated from the m4 files accompanying Automake X.Y.
+# (This private macro should not be called outside this file.)
+AC_DEFUN([AM_AUTOMAKE_VERSION],
+[am__api_version='1.10'
+dnl Some users find AM_AUTOMAKE_VERSION and mistake it for a way to
+dnl require some minimum version.  Point them to the right macro.
+m4_if([$1], [1.10.2], [],
+      [AC_FATAL([Do not call $0, use AM_INIT_AUTOMAKE([$1]).])])dnl
+])
+
+# _AM_AUTOCONF_VERSION(VERSION)
+# -----------------------------
+# aclocal traces this macro to find the Autoconf version.
+# This is a private macro too.  Using m4_define simplifies
+# the logic in aclocal, which can simply ignore this definition.
+m4_define([_AM_AUTOCONF_VERSION], [])
+
+# AM_SET_CURRENT_AUTOMAKE_VERSION
+# -------------------------------
+# Call AM_AUTOMAKE_VERSION and AM_AUTOMAKE_VERSION so they can be traced.
+# This function is AC_REQUIREd by AM_INIT_AUTOMAKE.
+AC_DEFUN([AM_SET_CURRENT_AUTOMAKE_VERSION],
+[AM_AUTOMAKE_VERSION([1.10.2])dnl
+m4_ifndef([AC_AUTOCONF_VERSION],
+  [m4_copy([m4_PACKAGE_VERSION], [AC_AUTOCONF_VERSION])])dnl
+_AM_AUTOCONF_VERSION(m4_defn([AC_AUTOCONF_VERSION]))])
+
+# AM_AUX_DIR_EXPAND                                         -*- Autoconf -*-
+
+# Copyright (C) 2001, 2003, 2005  Free Software Foundation, Inc.
+#
+# This file is free software; the Free Software Foundation
+# gives unlimited permission to copy and/or distribute it,
+# with or without modifications, as long as this notice is preserved.
+
+# For projects using AC_CONFIG_AUX_DIR([foo]), Autoconf sets
+# $ac_aux_dir to `$srcdir/foo'.  In other projects, it is set to
+# `$srcdir', `$srcdir/..', or `$srcdir/../..'.
+#
+# Of course, Automake must honor this variable whenever it calls a
+# tool from the auxiliary directory.  The problem is that $srcdir (and
+# therefore $ac_aux_dir as well) can be either absolute or relative,
+# depending on how configure is run.  This is pretty annoying, since
+# it makes $ac_aux_dir quite unusable in subdirectories: in the top
+# source directory, any form will work fine, but in subdirectories a
+# relative path needs to be adjusted first.
+#
+# $ac_aux_dir/missing
+#    fails when called from a subdirectory if $ac_aux_dir is relative
+# $top_srcdir/$ac_aux_dir/missing
+#    fails if $ac_aux_dir is absolute,
+#    fails when called from a subdirectory in a VPATH build with
+#          a relative $ac_aux_dir
+#
+# The reason of the latter failure is that $top_srcdir and $ac_aux_dir
+# are both prefixed by $srcdir.  In an in-source build this is usually
+# harmless because $srcdir is `.', but things will broke when you
+# start a VPATH build or use an absolute $srcdir.
+#
+# So we could use something similar to $top_srcdir/$ac_aux_dir/missing,
+# iff we strip the leading $srcdir from $ac_aux_dir.  That would be:
+#   am_aux_dir='\$(top_srcdir)/'`expr "$ac_aux_dir" : "$srcdir//*\(.*\)"`
+# and then we would define $MISSING as
+#   MISSING="\${SHELL} $am_aux_dir/missing"
+# This will work as long as MISSING is not called from configure, because
+# unfortunately $(top_srcdir) has no meaning in configure.
+# However there are other variables, like CC, which are often used in
+# configure, and could therefore not use this "fixed" $ac_aux_dir.
+#
+# Another solution, used here, is to always expand $ac_aux_dir to an
+# absolute PATH.  The drawback is that using absolute paths prevent a
+# configured tree to be moved without reconfiguration.
+
+AC_DEFUN([AM_AUX_DIR_EXPAND],
+[dnl Rely on autoconf to set up CDPATH properly.
+AC_PREREQ([2.50])dnl
+# expand $ac_aux_dir to an absolute path
+am_aux_dir=`cd $ac_aux_dir && pwd`
+])
+
+# AM_CONDITIONAL                                            -*- Autoconf -*-
+
+# Copyright (C) 1997, 2000, 2001, 2003, 2004, 2005, 2006
+# Free Software Foundation, Inc.
+#
+# This file is free software; the Free Software Foundation
+# gives unlimited permission to copy and/or distribute it,
+# with or without modifications, as long as this notice is preserved.
+
+# serial 8
+
+# AM_CONDITIONAL(NAME, SHELL-CONDITION)
+# -------------------------------------
+# Define a conditional.
+AC_DEFUN([AM_CONDITIONAL],
+[AC_PREREQ(2.52)dnl
+ ifelse([$1], [TRUE],  [AC_FATAL([$0: invalid condition: $1])],
+	[$1], [FALSE], [AC_FATAL([$0: invalid condition: $1])])dnl
+AC_SUBST([$1_TRUE])dnl
+AC_SUBST([$1_FALSE])dnl
+_AM_SUBST_NOTMAKE([$1_TRUE])dnl
+_AM_SUBST_NOTMAKE([$1_FALSE])dnl
+if $2; then
+  $1_TRUE=
+  $1_FALSE='#'
+else
+  $1_TRUE='#'
+  $1_FALSE=
+fi
+AC_CONFIG_COMMANDS_PRE(
+[if test -z "${$1_TRUE}" && test -z "${$1_FALSE}"; then
+  AC_MSG_ERROR([[conditional "$1" was never defined.
+Usually this means the macro was only invoked conditionally.]])
+fi])])
+
+# Do all the work for Automake.                             -*- Autoconf -*-
+
+# Copyright (C) 1996, 1997, 1998, 1999, 2000, 2001, 2002, 2003, 2004,
+# 2005, 2006, 2008 Free Software Foundation, Inc.
+#
+# This file is free software; the Free Software Foundation
+# gives unlimited permission to copy and/or distribute it,
+# with or without modifications, as long as this notice is preserved.
+
+# serial 13
+
+# This macro actually does too much.  Some checks are only needed if
+# your package does certain things.  But this isn't really a big deal.
+
+# AM_INIT_AUTOMAKE(PACKAGE, VERSION, [NO-DEFINE])
+# AM_INIT_AUTOMAKE([OPTIONS])
+# -----------------------------------------------
+# The call with PACKAGE and VERSION arguments is the old style
+# call (pre autoconf-2.50), which is being phased out.  PACKAGE
+# and VERSION should now be passed to AC_INIT and removed from
+# the call to AM_INIT_AUTOMAKE.
+# We support both call styles for the transition.  After
+# the next Automake release, Autoconf can make the AC_INIT
+# arguments mandatory, and then we can depend on a new Autoconf
+# release and drop the old call support.
+AC_DEFUN([AM_INIT_AUTOMAKE],
+[AC_PREREQ([2.60])dnl
+dnl Autoconf wants to disallow AM_ names.  We explicitly allow
+dnl the ones we care about.
+m4_pattern_allow([^AM_[A-Z]+FLAGS$])dnl
+AC_REQUIRE([AM_SET_CURRENT_AUTOMAKE_VERSION])dnl
+AC_REQUIRE([AC_PROG_INSTALL])dnl
+if test "`cd $srcdir && pwd`" != "`pwd`"; then
+  # Use -I$(srcdir) only when $(srcdir) != ., so that make's output
+  # is not polluted with repeated "-I."
+  AC_SUBST([am__isrc], [' -I$(srcdir)'])_AM_SUBST_NOTMAKE([am__isrc])dnl
+  # test to see if srcdir already configured
+  if test -f $srcdir/config.status; then
+    AC_MSG_ERROR([source directory already configured; run "make distclean" there first])
+  fi
+fi
+
+# test whether we have cygpath
+if test -z "$CYGPATH_W"; then
+  if (cygpath --version) >/dev/null 2>/dev/null; then
+    CYGPATH_W='cygpath -w'
+  else
+    CYGPATH_W=echo
+  fi
+fi
+AC_SUBST([CYGPATH_W])
+
+# Define the identity of the package.
+dnl Distinguish between old-style and new-style calls.
+m4_ifval([$2],
+[m4_ifval([$3], [_AM_SET_OPTION([no-define])])dnl
+ AC_SUBST([PACKAGE], [$1])dnl
+ AC_SUBST([VERSION], [$2])],
+[_AM_SET_OPTIONS([$1])dnl
+dnl Diagnose old-style AC_INIT with new-style AM_AUTOMAKE_INIT.
+m4_if(m4_ifdef([AC_PACKAGE_NAME], 1)m4_ifdef([AC_PACKAGE_VERSION], 1), 11,,
+  [m4_fatal([AC_INIT should be called with package and version arguments])])dnl
+ AC_SUBST([PACKAGE], ['AC_PACKAGE_TARNAME'])dnl
+ AC_SUBST([VERSION], ['AC_PACKAGE_VERSION'])])dnl
+
+_AM_IF_OPTION([no-define],,
+[AC_DEFINE_UNQUOTED(PACKAGE, "$PACKAGE", [Name of package])
+ AC_DEFINE_UNQUOTED(VERSION, "$VERSION", [Version number of package])])dnl
+
+# Some tools Automake needs.
+AC_REQUIRE([AM_SANITY_CHECK])dnl
+AC_REQUIRE([AC_ARG_PROGRAM])dnl
+AM_MISSING_PROG(ACLOCAL, aclocal-${am__api_version})
+AM_MISSING_PROG(AUTOCONF, autoconf)
+AM_MISSING_PROG(AUTOMAKE, automake-${am__api_version})
+AM_MISSING_PROG(AUTOHEADER, autoheader)
+AM_MISSING_PROG(MAKEINFO, makeinfo)
+AM_PROG_INSTALL_SH
+AM_PROG_INSTALL_STRIP
+AC_REQUIRE([AM_PROG_MKDIR_P])dnl
+# We need awk for the "check" target.  The system "awk" is bad on
+# some platforms.
+AC_REQUIRE([AC_PROG_AWK])dnl
+AC_REQUIRE([AC_PROG_MAKE_SET])dnl
+AC_REQUIRE([AM_SET_LEADING_DOT])dnl
+_AM_IF_OPTION([tar-ustar], [_AM_PROG_TAR([ustar])],
+              [_AM_IF_OPTION([tar-pax], [_AM_PROG_TAR([pax])],
+	      		     [_AM_PROG_TAR([v7])])])
+_AM_IF_OPTION([no-dependencies],,
+[AC_PROVIDE_IFELSE([AC_PROG_CC],
+                  [_AM_DEPENDENCIES(CC)],
+                  [define([AC_PROG_CC],
+                          defn([AC_PROG_CC])[_AM_DEPENDENCIES(CC)])])dnl
+AC_PROVIDE_IFELSE([AC_PROG_CXX],
+                  [_AM_DEPENDENCIES(CXX)],
+                  [define([AC_PROG_CXX],
+                          defn([AC_PROG_CXX])[_AM_DEPENDENCIES(CXX)])])dnl
+AC_PROVIDE_IFELSE([AC_PROG_OBJC],
+                  [_AM_DEPENDENCIES(OBJC)],
+                  [define([AC_PROG_OBJC],
+                          defn([AC_PROG_OBJC])[_AM_DEPENDENCIES(OBJC)])])dnl
+])
+])
+
+
+# When config.status generates a header, we must update the stamp-h file.
+# This file resides in the same directory as the config header
+# that is generated.  The stamp files are numbered to have different names.
+
+# Autoconf calls _AC_AM_CONFIG_HEADER_HOOK (when defined) in the
+# loop where config.status creates the headers, so we can generate
+# our stamp files there.
+AC_DEFUN([_AC_AM_CONFIG_HEADER_HOOK],
+[# Compute $1's index in $config_headers.
+_am_arg=$1
+_am_stamp_count=1
+for _am_header in $config_headers :; do
+  case $_am_header in
+    $_am_arg | $_am_arg:* )
+      break ;;
+    * )
+      _am_stamp_count=`expr $_am_stamp_count + 1` ;;
+  esac
+done
+echo "timestamp for $_am_arg" >`AS_DIRNAME(["$_am_arg"])`/stamp-h[]$_am_stamp_count])
+
+# Copyright (C) 2001, 2003, 2005  Free Software Foundation, Inc.
+#
+# This file is free software; the Free Software Foundation
+# gives unlimited permission to copy and/or distribute it,
+# with or without modifications, as long as this notice is preserved.
+
+# AM_PROG_INSTALL_SH
+# ------------------
+# Define $install_sh.
+AC_DEFUN([AM_PROG_INSTALL_SH],
+[AC_REQUIRE([AM_AUX_DIR_EXPAND])dnl
+install_sh=${install_sh-"\$(SHELL) $am_aux_dir/install-sh"}
+AC_SUBST(install_sh)])
+
+# Copyright (C) 2003, 2005  Free Software Foundation, Inc.
+#
+# This file is free software; the Free Software Foundation
+# gives unlimited permission to copy and/or distribute it,
+# with or without modifications, as long as this notice is preserved.
+
+# serial 2
+
+# Check whether the underlying file-system supports filenames
+# with a leading dot.  For instance MS-DOS doesn't.
+AC_DEFUN([AM_SET_LEADING_DOT],
+[rm -rf .tst 2>/dev/null
+mkdir .tst 2>/dev/null
+if test -d .tst; then
+  am__leading_dot=.
+else
+  am__leading_dot=_
+fi
+rmdir .tst 2>/dev/null
+AC_SUBST([am__leading_dot])])
+
+# Fake the existence of programs that GNU maintainers use.  -*- Autoconf -*-
+
+# Copyright (C) 1997, 1999, 2000, 2001, 2003, 2004, 2005
+# Free Software Foundation, Inc.
+#
+# This file is free software; the Free Software Foundation
+# gives unlimited permission to copy and/or distribute it,
+# with or without modifications, as long as this notice is preserved.
+
+# serial 5
+
+# AM_MISSING_PROG(NAME, PROGRAM)
+# ------------------------------
+AC_DEFUN([AM_MISSING_PROG],
+[AC_REQUIRE([AM_MISSING_HAS_RUN])
+$1=${$1-"${am_missing_run}$2"}
+AC_SUBST($1)])
+
+
+# AM_MISSING_HAS_RUN
+# ------------------
+# Define MISSING if not defined so far and test if it supports --run.
+# If it does, set am_missing_run to use it, otherwise, to nothing.
+AC_DEFUN([AM_MISSING_HAS_RUN],
+[AC_REQUIRE([AM_AUX_DIR_EXPAND])dnl
+AC_REQUIRE_AUX_FILE([missing])dnl
+test x"${MISSING+set}" = xset || MISSING="\${SHELL} $am_aux_dir/missing"
+# Use eval to expand $SHELL
+if eval "$MISSING --run true"; then
+  am_missing_run="$MISSING --run "
+else
+  am_missing_run=
+  AC_MSG_WARN([`missing' script is too old or missing])
+fi
+])
+
+# Copyright (C) 2003, 2004, 2005, 2006  Free Software Foundation, Inc.
+#
+# This file is free software; the Free Software Foundation
+# gives unlimited permission to copy and/or distribute it,
+# with or without modifications, as long as this notice is preserved.
+
+# AM_PROG_MKDIR_P
+# ---------------
+# Check for `mkdir -p'.
+AC_DEFUN([AM_PROG_MKDIR_P],
+[AC_PREREQ([2.60])dnl
+AC_REQUIRE([AC_PROG_MKDIR_P])dnl
+dnl Automake 1.8 to 1.9.6 used to define mkdir_p.  We now use MKDIR_P,
+dnl while keeping a definition of mkdir_p for backward compatibility.
+dnl @MKDIR_P@ is magic: AC_OUTPUT adjusts its value for each Makefile.
+dnl However we cannot define mkdir_p as $(MKDIR_P) for the sake of
+dnl Makefile.ins that do not define MKDIR_P, so we do our own
+dnl adjustment using top_builddir (which is defined more often than
+dnl MKDIR_P).
+AC_SUBST([mkdir_p], ["$MKDIR_P"])dnl
+case $mkdir_p in
+  [[\\/$]]* | ?:[[\\/]]*) ;;
+  */*) mkdir_p="\$(top_builddir)/$mkdir_p" ;;
+esac
+])
+
+# Helper functions for option handling.                     -*- Autoconf -*-
+
+# Copyright (C) 2001, 2002, 2003, 2005, 2008  Free Software Foundation, Inc.
+#
+# This file is free software; the Free Software Foundation
+# gives unlimited permission to copy and/or distribute it,
+# with or without modifications, as long as this notice is preserved.
+
+# serial 4
+
+# _AM_MANGLE_OPTION(NAME)
+# -----------------------
+AC_DEFUN([_AM_MANGLE_OPTION],
+[[_AM_OPTION_]m4_bpatsubst($1, [[^a-zA-Z0-9_]], [_])])
+
+# _AM_SET_OPTION(NAME)
+# ------------------------------
+# Set option NAME.  Presently that only means defining a flag for this option.
+AC_DEFUN([_AM_SET_OPTION],
+[m4_define(_AM_MANGLE_OPTION([$1]), 1)])
+
+# _AM_SET_OPTIONS(OPTIONS)
+# ----------------------------------
+# OPTIONS is a space-separated list of Automake options.
+AC_DEFUN([_AM_SET_OPTIONS],
+[m4_foreach_w([_AM_Option], [$1], [_AM_SET_OPTION(_AM_Option)])])
+
+# _AM_IF_OPTION(OPTION, IF-SET, [IF-NOT-SET])
+# -------------------------------------------
+# Execute IF-SET if OPTION is set, IF-NOT-SET otherwise.
+AC_DEFUN([_AM_IF_OPTION],
+[m4_ifset(_AM_MANGLE_OPTION([$1]), [$2], [$3])])
+
+# Check to make sure that the build environment is sane.    -*- Autoconf -*-
+
+# Copyright (C) 1996, 1997, 2000, 2001, 2003, 2005
+# Free Software Foundation, Inc.
+#
+# This file is free software; the Free Software Foundation
+# gives unlimited permission to copy and/or distribute it,
+# with or without modifications, as long as this notice is preserved.
+
+# serial 4
+
+# AM_SANITY_CHECK
+# ---------------
+AC_DEFUN([AM_SANITY_CHECK],
+[AC_MSG_CHECKING([whether build environment is sane])
+# Just in case
+sleep 1
+echo timestamp > conftest.file
+# Do `set' in a subshell so we don't clobber the current shell's
+# arguments.  Must try -L first in case configure is actually a
+# symlink; some systems play weird games with the mod time of symlinks
+# (eg FreeBSD returns the mod time of the symlink's containing
+# directory).
+if (
+   set X `ls -Lt $srcdir/configure conftest.file 2> /dev/null`
+   if test "$[*]" = "X"; then
+      # -L didn't work.
+      set X `ls -t $srcdir/configure conftest.file`
+   fi
+   rm -f conftest.file
+   if test "$[*]" != "X $srcdir/configure conftest.file" \
+      && test "$[*]" != "X conftest.file $srcdir/configure"; then
+
+      # If neither matched, then we have a broken ls.  This can happen
+      # if, for instance, CONFIG_SHELL is bash and it inherits a
+      # broken ls alias from the environment.  This has actually
+      # happened.  Such a system could not be considered "sane".
+      AC_MSG_ERROR([ls -t appears to fail.  Make sure there is not a broken
+alias in your environment])
+   fi
+
+   test "$[2]" = conftest.file
+   )
+then
+   # Ok.
+   :
+else
+   AC_MSG_ERROR([newly created file is older than distributed files!
+Check your system clock])
+fi
+AC_MSG_RESULT(yes)])
+
+# Copyright (C) 2001, 2003, 2005  Free Software Foundation, Inc.
+#
+# This file is free software; the Free Software Foundation
+# gives unlimited permission to copy and/or distribute it,
+# with or without modifications, as long as this notice is preserved.
+
+# AM_PROG_INSTALL_STRIP
+# ---------------------
+# One issue with vendor `install' (even GNU) is that you can't
+# specify the program used to strip binaries.  This is especially
+# annoying in cross-compiling environments, where the build's strip
+# is unlikely to handle the host's binaries.
+# Fortunately install-sh will honor a STRIPPROG variable, so we
+# always use install-sh in `make install-strip', and initialize
+# STRIPPROG with the value of the STRIP variable (set by the user).
+AC_DEFUN([AM_PROG_INSTALL_STRIP],
+[AC_REQUIRE([AM_PROG_INSTALL_SH])dnl
+# Installed binaries are usually stripped using `strip' when the user
+# run `make install-strip'.  However `strip' might not be the right
+# tool to use in cross-compilation environments, therefore Automake
+# will honor the `STRIP' environment variable to overrule this program.
+dnl Don't test for $cross_compiling = yes, because it might be `maybe'.
+if test "$cross_compiling" != no; then
+  AC_CHECK_TOOL([STRIP], [strip], :)
+fi
+INSTALL_STRIP_PROGRAM="\$(install_sh) -c -s"
+AC_SUBST([INSTALL_STRIP_PROGRAM])])
+
+# Copyright (C) 2006  Free Software Foundation, Inc.
+#
+# This file is free software; the Free Software Foundation
+# gives unlimited permission to copy and/or distribute it,
+# with or without modifications, as long as this notice is preserved.
+
+# _AM_SUBST_NOTMAKE(VARIABLE)
+# ---------------------------
+# Prevent Automake from outputting VARIABLE = @VARIABLE@ in Makefile.in.
+# This macro is traced by Automake.
+AC_DEFUN([_AM_SUBST_NOTMAKE])
+
+# Check how to create a tarball.                            -*- Autoconf -*-
+
+# Copyright (C) 2004, 2005  Free Software Foundation, Inc.
+#
+# This file is free software; the Free Software Foundation
+# gives unlimited permission to copy and/or distribute it,
+# with or without modifications, as long as this notice is preserved.
+
+# serial 2
+
+# _AM_PROG_TAR(FORMAT)
+# --------------------
+# Check how to create a tarball in format FORMAT.
+# FORMAT should be one of `v7', `ustar', or `pax'.
+#
+# Substitute a variable $(am__tar) that is a command
+# writing to stdout a FORMAT-tarball containing the directory
+# $tardir.
+#     tardir=directory && $(am__tar) > result.tar
+#
+# Substitute a variable $(am__untar) that extract such
+# a tarball read from stdin.
+#     $(am__untar) < result.tar
+AC_DEFUN([_AM_PROG_TAR],
+[# Always define AMTAR for backward compatibility.
+AM_MISSING_PROG([AMTAR], [tar])
+m4_if([$1], [v7],
+     [am__tar='${AMTAR} chof - "$$tardir"'; am__untar='${AMTAR} xf -'],
+     [m4_case([$1], [ustar],, [pax],,
+              [m4_fatal([Unknown tar format])])
+AC_MSG_CHECKING([how to create a $1 tar archive])
+# Loop over all known methods to create a tar archive until one works.
+_am_tools='gnutar m4_if([$1], [ustar], [plaintar]) pax cpio none'
+_am_tools=${am_cv_prog_tar_$1-$_am_tools}
+# Do not fold the above two line into one, because Tru64 sh and
+# Solaris sh will not grok spaces in the rhs of `-'.
+for _am_tool in $_am_tools
+do
+  case $_am_tool in
+  gnutar)
+    for _am_tar in tar gnutar gtar;
+    do
+      AM_RUN_LOG([$_am_tar --version]) && break
+    done
+    am__tar="$_am_tar --format=m4_if([$1], [pax], [posix], [$1]) -chf - "'"$$tardir"'
+    am__tar_="$_am_tar --format=m4_if([$1], [pax], [posix], [$1]) -chf - "'"$tardir"'
+    am__untar="$_am_tar -xf -"
+    ;;
+  plaintar)
+    # Must skip GNU tar: if it does not support --format= it doesn't create
+    # ustar tarball either.
+    (tar --version) >/dev/null 2>&1 && continue
+    am__tar='tar chf - "$$tardir"'
+    am__tar_='tar chf - "$tardir"'
+    am__untar='tar xf -'
+    ;;
+  pax)
+    am__tar='pax -L -x $1 -w "$$tardir"'
+    am__tar_='pax -L -x $1 -w "$tardir"'
+    am__untar='pax -r'
+    ;;
+  cpio)
+    am__tar='find "$$tardir" -print | cpio -o -H $1 -L'
+    am__tar_='find "$tardir" -print | cpio -o -H $1 -L'
+    am__untar='cpio -i -H $1 -d'
+    ;;
+  none)
+    am__tar=false
+    am__tar_=false
+    am__untar=false
+    ;;
+  esac
+
+  # If the value was cached, stop now.  We just wanted to have am__tar
+  # and am__untar set.
+  test -n "${am_cv_prog_tar_$1}" && break
+
+  # tar/untar a dummy directory, and stop if the command works
+  rm -rf conftest.dir
+  mkdir conftest.dir
+  echo GrepMe > conftest.dir/file
+  AM_RUN_LOG([tardir=conftest.dir && eval $am__tar_ >conftest.tar])
+  rm -rf conftest.dir
+  if test -s conftest.tar; then
+    AM_RUN_LOG([$am__untar <conftest.tar])
+    grep GrepMe conftest.dir/file >/dev/null 2>&1 && break
+  fi
+done
+rm -rf conftest.dir
+
+AC_CACHE_VAL([am_cv_prog_tar_$1], [am_cv_prog_tar_$1=$_am_tool])
+AC_MSG_RESULT([$am_cv_prog_tar_$1])])
+AC_SUBST([am__tar])
+AC_SUBST([am__untar])
+]) # _AM_PROG_TAR
+
diff --git a/commit.d/10vcs-test b/commit.d/10vcs-test
deleted file mode 100755
index e33d734..0000000
--- a/commit.d/10vcs-test
+++ /dev/null
@@ -1,17 +0,0 @@
-#!/bin/sh
-set -e
-	
-not_enabled_warning() {
-	echo "etckeeper warning: etckeeper is not yet enabled for $(pwd)" >&2
-	echo "etckeeper warning: run etckeeper init to enable it" >&2
-}
-
-if [ "$VCS" = git ] && [ ! -d .git ]; then
-	not_enabled_warning
-elif [ "$VCS" = hg ] && [ ! -d .hg ]; then
-	not_enabled_warning
-elif [ "$VCS" = bzr ] && [ ! -d .bzr ]; then
-	not_enabled_warning
-elif [ "$VCS" = darcs ] && [ ! -d _darcs ]; then
-	not_enabled_warning
-fi
diff --git a/commit.d/10vcs-test.in b/commit.d/10vcs-test.in
new file mode 100644
index 0000000..5aa6b52
--- /dev/null
+++ b/commit.d/10vcs-test.in
@@ -0,0 +1,17 @@
+#!@SHELLPATH@
+set -e
+	
+not_enabled_warning() {
+	echo "etckeeper warning: etckeeper is not yet enabled for $(pwd)" >&2
+	echo "etckeeper warning: run etckeeper init to enable it" >&2
+}
+
+if [ "$VCS" = git ] && [ ! -d .git ]; then
+	not_enabled_warning
+elif [ "$VCS" = hg ] && [ ! -d .hg ]; then
+	not_enabled_warning
+elif [ "$VCS" = bzr ] && [ ! -d .bzr ]; then
+	not_enabled_warning
+elif [ "$VCS" = darcs ] && [ ! -d _darcs ]; then
+	not_enabled_warning
+fi
diff --git a/commit.d/30bzr-add b/commit.d/30bzr-add
deleted file mode 100755
index 3e7e95d..0000000
--- a/commit.d/30bzr-add
+++ /dev/null
@@ -1,8 +0,0 @@
-#!/bin/sh
-set -e
-
-if [ "$VCS" = bzr ] && [ -d .bzr ]; then
-	if ! bzr add -q .; then
-		echo "etckeeper warning: bzr add failed" >&2
-	fi
-fi
diff --git a/commit.d/30bzr-add.in b/commit.d/30bzr-add.in
new file mode 100644
index 0000000..e9012c7
--- /dev/null
+++ b/commit.d/30bzr-add.in
@@ -0,0 +1,8 @@
+#!@SHELLPATH@
+set -e
+
+if [ "$VCS" = bzr ] && [ -d .bzr ]; then
+	if ! bzr add -q .; then
+		echo "etckeeper warning: bzr add failed" >&2
+	fi
+fi
diff --git a/commit.d/30darcs-add b/commit.d/30darcs-add
deleted file mode 100755
index 98be4bf..0000000
--- a/commit.d/30darcs-add
+++ /dev/null
@@ -1,14 +0,0 @@
-#!/bin/sh
-set -e
-
-if [ "$VCS" = darcs ] && [ -d _darcs ]; then
-	rc=0
-	res=$( darcs add -qr . 2>&1 ) || rc=$?
-	if test $rc -ne 0; then
-		if ! test $rc -eq 2 -a "${res%No files were added}" != "$res"; then
-			printf "%s" "$res"
-			echo "etckeeper warning: darcs add failed" >&2
-		fi
-	fi
-	unset rc res
-fi
diff --git a/commit.d/30darcs-add.in b/commit.d/30darcs-add.in
new file mode 100644
index 0000000..46b50f2
--- /dev/null
+++ b/commit.d/30darcs-add.in
@@ -0,0 +1,14 @@
+#!@SHELLPATH@
+set -e
+
+if [ "$VCS" = darcs ] && [ -d _darcs ]; then
+	rc=0
+	res=$( darcs add -qr . 2>&1 ) || rc=$?
+	if test $rc -ne 0; then
+		if ! test $rc -eq 2 -a "${res%No files were added}" != "$res"; then
+			printf "%s" "$res"
+			echo "etckeeper warning: darcs add failed" >&2
+		fi
+	fi
+	unset rc res
+fi
diff --git a/commit.d/30git-add b/commit.d/30git-add
deleted file mode 100755
index 66d96a9..0000000
--- a/commit.d/30git-add
+++ /dev/null
@@ -1,8 +0,0 @@
-#!/bin/sh
-set -e
-
-if [ "$VCS" = git ] && [ -d .git ]; then
-	if ! git add .; then
-		echo "etckeeper warning: git add failed" >&2
-	fi
-fi
diff --git a/commit.d/30git-add.in b/commit.d/30git-add.in
new file mode 100644
index 0000000..09b5a8b
--- /dev/null
+++ b/commit.d/30git-add.in
@@ -0,0 +1,8 @@
+#!@SHELLPATH@
+set -e
+
+if [ "$VCS" = git ] && [ -d .git ]; then
+	if ! git add .; then
+		echo "etckeeper warning: git add failed" >&2
+	fi
+fi
diff --git a/commit.d/30hg-addremove b/commit.d/30hg-addremove
deleted file mode 100755
index 1b999bb..0000000
--- a/commit.d/30hg-addremove
+++ /dev/null
@@ -1,8 +0,0 @@
-#!/bin/sh
-set -e
-
-if [ "$VCS" = hg ] && [ -d .hg ]; then
-	if ! hg addremove .; then
-		echo "etckeeper warning: hg addremove failed" >&2
-	fi
-fi
diff --git a/commit.d/30hg-addremove.in b/commit.d/30hg-addremove.in
new file mode 100644
index 0000000..25218cd
--- /dev/null
+++ b/commit.d/30hg-addremove.in
@@ -0,0 +1,8 @@
+#!@SHELLPATH@
+set -e
+
+if [ "$VCS" = hg ] && [ -d .hg ]; then
+	if ! hg addremove .; then
+		echo "etckeeper warning: hg addremove failed" >&2
+	fi
+fi
diff --git a/commit.d/40git-rm b/commit.d/40git-rm
deleted file mode 100755
index 26f492a..0000000
--- a/commit.d/40git-rm
+++ /dev/null
@@ -1,27 +0,0 @@
-#!/bin/sh
-set -e
-
-IFS='
-'
-
-if [ "$VCS" = git ] && [ -d .git ]; then
-	for file in $(git ls-files --deleted); do
-		if [ ! -d "$file" ]; then
-			# git removes directories when the last file
-			# in them is removed, but empty directories
-			# may be significant in /etc. Touch a flag file
-			# to prevent git from removing the directory.
-			dir="$(dirname "$file")"
-			flagfile=""
-			if [ -d "$dir" ] && 
-			   [ -n "$(find "$dir" -maxdepth 0 -empty)" ]; then
-				flagfile="$dir/.etckeeper-keep-empty"
-				touch "$flagfile"
-			fi
-			git rm --quiet "$file"
-			if [ -n "$flagfile" ]; then
-				rm -f "$flagfile"
-			fi
-		fi
-	done
-fi
diff --git a/commit.d/40git-rm.in b/commit.d/40git-rm.in
new file mode 100644
index 0000000..e7e41a8
--- /dev/null
+++ b/commit.d/40git-rm.in
@@ -0,0 +1,27 @@
+#!@SHELLPATH@
+set -e
+
+IFS='
+'
+
+if [ "$VCS" = git ] && [ -d .git ]; then
+	for file in $(git ls-files --deleted); do
+		if [ ! -d "$file" ]; then
+			# git removes directories when the last file
+			# in them is removed, but empty directories
+			# may be significant in /etc. Touch a flag file
+			# to prevent git from removing the directory.
+			dir="$(dirname "$file")"
+			flagfile=""
+			if [ -d "$dir" ] && 
+			   [ -n "$(find "$dir" -maxdepth 0 -empty)" ]; then
+				flagfile="$dir/.etckeeper-keep-empty"
+				touch "$flagfile"
+			fi
+			git rm --quiet "$file"
+			if [ -n "$flagfile" ]; then
+				rm -f "$flagfile"
+			fi
+		fi
+	done
+fi
diff --git a/commit.d/50vcs-commit b/commit.d/50vcs-commit
deleted file mode 100755
index 1f4ab03..0000000
--- a/commit.d/50vcs-commit
+++ /dev/null
@@ -1,41 +0,0 @@
-#!/bin/sh
-set -e
-
-message="$1"
-hostname=`hostname -f`
-
-if [ "$VCS" = git ] && [ -d .git ]; then
-	if [ -n "$SUDO_USER" ]; then
-		export GIT_COMMITTER_NAME="$SUDO_USER"
-		export GIT_COMMITTER_EMAIL="$SUDO_USER@$hostname"
-	fi
-	if [ -n "$message" ]; then
-		git commit $GIT_COMMIT_OPTIONS -m "$message"
-	else
-		git commit $GIT_COMMIT_OPTIONS
-	fi
-elif [ "$VCS" = hg ] && [ -d .hg ]; then
-	if [ -n "$SUDO_USER" ]; then
-		export LOGNAME="$SUDO_USER"
-	fi
-	if [ -n "$message" ]; then
-		hg commit $HG_COMMIT_OPTIONS -m "$message"
-	else
-		hg commit $HG_COMMIT_OPTIONS
-	fi
-elif [ "$VCS" = bzr ] && [ -d .bzr ]; then
-	if [ -n "$SUDO_USER" ]; then
-		export EMAIL="$SUDO_USER <$SUDO_USER@$hostname>"
-	fi
-	if [ -n "$message" ]; then
-		bzr commit $BZR_COMMIT_OPTIONS -m "$message"
-	else
-		bzr commit $BZR_COMMIT_OPTIONS
-	fi
-elif [ "$VCS" = darcs ] && [ -d _darcs ]; then
-	logfile="$( mktemp -t etckeeper-$VCS.XXXXXXXXXX )"
-	printf "%b" "$message" > "$logfile"
-	darcs record $DARCS_COMMIT_OPTIONS --logfile="$logfile"
-	rm -f "$logfile"
-	unset logfile
-fi
diff --git a/commit.d/50vcs-commit.in b/commit.d/50vcs-commit.in
new file mode 100644
index 0000000..067e55f
--- /dev/null
+++ b/commit.d/50vcs-commit.in
@@ -0,0 +1,41 @@
+#!@SHELLPATH@
+set -e
+
+message="$1"
+hostname=`hostname -f`
+
+if [ "$VCS" = git ] && [ -d .git ]; then
+	if [ -n "$SUDO_USER" ]; then
+		export GIT_COMMITTER_NAME="$SUDO_USER"
+		export GIT_COMMITTER_EMAIL="$SUDO_USER@$hostname"
+	fi
+	if [ -n "$message" ]; then
+		git commit $GIT_COMMIT_OPTIONS -m "$message"
+	else
+		git commit $GIT_COMMIT_OPTIONS
+	fi
+elif [ "$VCS" = hg ] && [ -d .hg ]; then
+	if [ -n "$SUDO_USER" ]; then
+		export LOGNAME="$SUDO_USER"
+	fi
+	if [ -n "$message" ]; then
+		hg commit $HG_COMMIT_OPTIONS -m "$message"
+	else
+		hg commit $HG_COMMIT_OPTIONS
+	fi
+elif [ "$VCS" = bzr ] && [ -d .bzr ]; then
+	if [ -n "$SUDO_USER" ]; then
+		export EMAIL="$SUDO_USER <$SUDO_USER@$hostname>"
+	fi
+	if [ -n "$message" ]; then
+		bzr commit $BZR_COMMIT_OPTIONS -m "$message"
+	else
+		bzr commit $BZR_COMMIT_OPTIONS
+	fi
+elif [ "$VCS" = darcs ] && [ -d _darcs ]; then
+	logfile="$( mktemp -t etckeeper-$VCS.XXXXXXXXXX )"
+	printf "%b" "$message" > "$logfile"
+	darcs record $DARCS_COMMIT_OPTIONS --logfile="$logfile"
+	rm -f "$logfile"
+	unset logfile
+fi
diff --git a/configure.ac b/configure.ac
new file mode 100644
index 0000000..39e742f
--- /dev/null
+++ b/configure.ac
@@ -0,0 +1,85 @@
+AC_INIT([etckeeper], [0.37])
+AM_INIT_AUTOMAKE
+
+dnl for MKDIR_P
+AC_PREREQ([2.60])
+
+AC_CONFIG_SRCDIR([apt.conf])
+
+AC_PROG_INSTALL
+AC_PROG_MKDIR_P
+
+dnl EK_WITH_OPT(optname, optvar, default, valid)
+dnl --------------------------------------------
+dnl Commodity --with options that map to stock behaviours
+dnl valid should be a | separated list of options
+AC_DEFUN([EK_WITH_OPT], [
+  AC_ARG_WITH([$1], [AS_HELP_STRING([--with-$1],
+              [select the $2 package/tool to use (default is $3) (valid: $4)])],
+	      [
+AC_MSG_CHECKING([whether '$withval' is a valid $2 selection])
+if test "$4" = "any"; then
+   $2=$withval
+else
+	case "$4" in
+	     *"$withval"*) $2=$withval;;
+	      *) $2=error;;
+	esac
+fi
+
+AS_IF([test "x$$2" != "xerror"],
+	    AC_MSG_RESULT([yes]),
+		AC_MSG_RESULT([no])
+		AC_MSG_ERROR(['$withvar' is an invalid $2 selection], [1]))
+	],
+	      [$2=$3])
+dnl if no default is supplied, we're not setting a value for etckeeper.conf
+AS_IF([test "$4" != "any"],
+	    AC_MSG_NOTICE([$2 in etckeeper.conf will be $$2])
+)
+AC_SUBST([$2])
+])
+
+dnl EK_DISABLE_ADDON(addon, var, name)
+dnl ----------------------------------
+dnl Disable the installation of various addon features (bash completion, etc)
+dnl $1 = add-on-option
+dnl $2 = AUTOCONF_VAR
+dnl $3 = english name
+AC_DEFUN([EK_DISABLE_ADDON], [
+  AC_ARG_ENABLE([$1], [AS_HELP_STRING([--disable-$1],
+  		        [Do not install $3 files.])],
+[
+			case "$enableval" in
+			     no)
+			         AC_MSG_NOTICE([disabling $3 installation])
+			     	 $2=
+				 ;;
+			      *)
+			         AC_MSG_NOTICE([enabling $3 installation])
+			      	 $2=yes
+				 ;;
+			esac
+]
+			,
+[
+			AC_MSG_NOTICE([enabling $3 installation])
+			$2=yes
+])
+
+  AM_CONDITIONAL([INST_$2], [ test x$$2 = xyes ])
+])
+
+
+EK_WITH_OPT(vcs, VCS, git, git|bzr|darcs|hg)
+EK_WITH_OPT(highlevel, HIGHLEVEL, apt, apt|yum|pacman-g2)
+EK_WITH_OPT(lowlevel, LOWLEVEL, dpkg, dpkg|rpm|pacman-g2)
+EK_WITH_OPT(shell, SHELLPATH, /bin/sh, any)
+
+EK_DISABLE_ADDON(bash-completion, BASH_COMPLETION, bash completion)
+EK_DISABLE_ADDON(cruft-filter, CRUFT_FILTER, cruft filter)
+
+
+AC_CONFIG_FILES([Makefile])
+
+AC_OUTPUT
diff --git a/etckeeper b/etckeeper
deleted file mode 100755
index 1b6c76c..0000000
--- a/etckeeper
+++ /dev/null
@@ -1,92 +0,0 @@
-#!/bin/sh
-set -e
-
-if [ -z "$ETCKEEPER_CONF_DIR" ]; then
-	ETCKEEPER_CONF_DIR=/etc/etckeeper
-fi
-
-conf="$ETCKEEPER_CONF_DIR/etckeeper.conf"
-
-usage() {
-	echo "usage: etckeeper command [-d directory]" >&2
-	exit 1
-}
-
-if [ -e $conf ]; then
-	. $conf
-fi
-
-if [ -z "$VCS" ]; then
-	echo "Please configure a VCS in $conf" >&2
-	exit 1
-fi
-export VCS
-
-if [ ! -z "$GIT_COMMIT_OPTIONS" ]; then
-	export GIT_COMMIT_OPTIONS
-fi
-if [ ! -z "$HG_COMMIT_OPTIONS" ]; then
-	export HG_COMMIT_OPTIONS
-fi
-if [ ! -z "$BZR_COMMIT_OPTIONS" ]; then
-	export BZR_COMMIT_OPTIONS
-fi
-if [ ! -z "$DARCS_COMMIT_OPTIONS" ]; then
-	export DARCS_COMMIT_OPTIONS
-fi
-
-if [ ! -z "$HIGHLEVEL_PACKAGE_MANAGER" ]; then
-	export HIGHLEVEL_PACKAGE_MANAGER
-fi
-if [ ! -z "$LOWLEVEL_PACKAGE_MANAGER" ]; then
-	export LOWLEVEL_PACKAGE_MANAGER
-fi
-if [ ! -z "$AVOID_COMMIT_BEFORE_INSTALL" ]; then
-	export AVOID_COMMIT_BEFORE_INSTALL
-fi
-
-if [ -z "$1" ]; then
-	usage
-fi
-command="$1"
-shift 1
-
-# compatability code
-if [ "$command" = "post-apt" ]; then
-	command=post-install
-elif [ "$command" = "pre-apt" ]; then
-	command=pre-install
-fi
-
-if [ ! -d "$ETCKEEPER_CONF_DIR/$command.d" ]; then
-	echo "etckeeper: $ETCKEEPER_CONF_DIR/$command.d does not exist" >&2
-	exit 1
-fi
-
-if [ "x$1" = "x-d" ]; then
-	if [ -n "$2" ]; then
-		ETCKEEPER_DIR="$2"
-		shift 2
-	else
-		usage
-	fi
-fi
-
-if [ -z "$ETCKEEPER_DIR" ]; then
-	ETCKEEPER_DIR=/etc
-fi
-cd "$ETCKEEPER_DIR"
-export ETCKEEPER_DIR
-
-lsscripts() {
-	perl -e '
-		$dir=shift;
-		print join "\n", grep { ! -d $_ && -x $_ }
-			grep /^\Q$dir\/\E[-a-zA-Z0-9]+$/,
-			glob "$dir/*";
-	' "$1"
-}
-
-for script in $(lsscripts "$ETCKEEPER_CONF_DIR/$command.d"); do
-	"$script" "$@"
-done
diff --git a/etckeeper.8 b/etckeeper.8
deleted file mode 100644
index 9070503..0000000
--- a/etckeeper.8
+++ /dev/null
@@ -1,62 +0,0 @@
-.\" -*- nroff -*-
-.TH ETCKEEPER 8 "" "" ""
-.SH NAME
-etckeeper \- store /etc in git, mercurial, bazaar, or darcs
-.SH SYNOPSIS
-.B etckeeper command [-d directory]
-.SH DESCRIPTION
-etckeeper manages /etc be stored in a git, mercurial, bazaar, or darcs
-repository. By default each of the commands operates on /etc, but a
-different directory can be specified to operate on a clone of the /etc
-repository located elsewhere.
-.SH COMMANDS
-.TP
-.B init
-This initialises and sets up a git, mercurial, bazaar, or darcs
-repository (depending on the VCS setting in
-/etc/etckeeper/etckeeper.conf). Typically this is run in /etc once
-when starting to use etckeeper on a machine. It can also be used to
-initialise a clone of the /etc repository located elsewhere.
-.TP
-.B commit [message]
-Commits all changes in /etc to the repository. A commit message can be
-specified. You may also use the underlying VCS to commit manually.
-.TP
-.B pre-commit
-This is called as a pre-commit hook. It stores metadata and does sanity
-checks.
-.TP
-.B pre-install
-This is called by apt's DPkg::Pre-Install-Pkgs hook, or by equivilant hooks
-of other package managers. It allows committing any uncommitted changes before
-packages are installed, upgraded, etc.
-.TP
-.B post-install
-This is called by apt's DPkg::Post-Invoke hook, or by equivilant hooks
-of other package managers. It commits changes made by packages into the
-repository. (You can also call this by hand after running dpkg by hand.)
-.TP
-.B unclean
-This returns true if the directory contains uncommitted changes.
-.TP
-.B update-ignore
-This updates the VCS ignore file. Content outside a "managed by etckeeper"
-block is not touched. This is generally run when upgrading to a new version
-of etckeeper.
-.TP
-.B uninit [-f]
-This command DESTROYS DATA! It is the inverse of the init command, removing
-VCS information and etckeeper's own bookkeeping information from the
-directory. Use with caution. A typical use case would be to run etckeeper
-uninit, then modify etckeeper.conf to use a different VCS, and then run
-etckeeper init. (The -f switch can be used to force uninit without
-prompting.)
-.SH FILES
-/etc/etckeeper/etckeeper.conf is the configuration file.
-
-/etc/etckeeper also contains directories containing the programs that are
-run for each of the above commands.
-.SH SEE ALSO
-/usr/share/doc/etckeeper/README.gz
-.SH AUTHOR 
-Joey Hess <joey@kitenet.net>
diff --git a/etckeeper.8.in b/etckeeper.8.in
new file mode 100644
index 0000000..528b44b
--- /dev/null
+++ b/etckeeper.8.in
@@ -0,0 +1,62 @@
+.\" -*- nroff -*-
+.TH ETCKEEPER 8 "" "" ""
+.SH NAME
+etckeeper \- store /etc in git, mercurial, bazaar, or darcs
+.SH SYNOPSIS
+.B etckeeper command [-d directory]
+.SH DESCRIPTION
+etckeeper manages /etc be stored in a git, mercurial, bazaar, or darcs
+repository. By default each of the commands operates on /etc, but a
+different directory can be specified to operate on a clone of the /etc
+repository located elsewhere.
+.SH COMMANDS
+.TP
+.B init
+This initialises and sets up a git, mercurial, bazaar, or darcs
+repository (depending on the VCS setting in
+@sysconfdir@/etckeeper/etckeeper.conf). Typically this is run in /etc once
+when starting to use etckeeper on a machine. It can also be used to
+initialise a clone of the /etc repository located elsewhere.
+.TP
+.B commit [message]
+Commits all changes in /etc to the repository. A commit message can be
+specified. You may also use the underlying VCS to commit manually.
+.TP
+.B pre-commit
+This is called as a pre-commit hook. It stores metadata and does sanity
+checks.
+.TP
+.B pre-install
+This is called by apt's DPkg::Pre-Install-Pkgs hook, or by equivilant hooks
+of other package managers. It allows committing any uncommitted changes before
+packages are installed, upgraded, etc.
+.TP
+.B post-install
+This is called by apt's DPkg::Post-Invoke hook, or by equivilant hooks
+of other package managers. It commits changes made by packages into the
+repository. (You can also call this by hand after running dpkg by hand.)
+.TP
+.B unclean
+This returns true if the directory contains uncommitted changes.
+.TP
+.B update-ignore
+This updates the VCS ignore file. Content outside a "managed by etckeeper"
+block is not touched. This is generally run when upgrading to a new version
+of etckeeper.
+.TP
+.B uninit [-f]
+This command DESTROYS DATA! It is the inverse of the init command, removing
+VCS information and etckeeper's own bookkeeping information from the
+directory. Use with caution. A typical use case would be to run etckeeper
+uninit, then modify etckeeper.conf to use a different VCS, and then run
+etckeeper init. (The -f switch can be used to force uninit without
+prompting.)
+.SH FILES
+@sysconfdir@/etckeeper/etckeeper.conf is the configuration file.
+
+@sysconfdir@/etckeeper also contains directories containing the programs that are
+run for each of the above commands.
+.SH SEE ALSO
+@docdir@/README.gz
+.SH AUTHOR 
+Joey Hess <joey@kitenet.net>
diff --git a/etckeeper.conf b/etckeeper.conf
deleted file mode 100644
index f810870..0000000
--- a/etckeeper.conf
+++ /dev/null
@@ -1,34 +0,0 @@
-# The VCS to use.
-# VCS="hg"
-VCS="git"
-# VCS="bzr"
-# VCS="darcs"
-
-# Options passed to git commit when run by etckeeper.
-#GIT_COMMIT_OPTIONS=""
-
-# Options passed to hg commit when run by etckeeper.
-#HG_COMMIT_OPTIONS=""
-
-# Options passed to bzr commit when run by etckeeper.
-#BZR_COMMIT_OPTIONS=""
-
-# Options passed to darcs commit when run by etckeeper.
-#DARCS_COMMIT_OPTIONS=""
-
-# Uncomment to avoid etckeeper committing existing changes
-# to /etc automatically once per day.
-#AVOID_DAILY_AUTOCOMMITS=1
-
-# Uncomment to avoid etckeeper committing existing changes to 
-# /etc before installation. It will cancel the installation,
-# so you can commit the changes by hand.
-#AVOID_COMMIT_BEFORE_INSTALL=1
-
-# The high-level package manager that's being used.
-# (apt, pacman-g2, yum etc)
-HIGHLEVEL_PACKAGE_MANAGER=apt
-
-# The low-level package manager that's being used.
-# (dpkg, rpm, pacman-g2, etc)
-LOWLEVEL_PACKAGE_MANAGER=dpkg
diff --git a/etckeeper.conf.in b/etckeeper.conf.in
new file mode 100644
index 0000000..980b52c
--- /dev/null
+++ b/etckeeper.conf.in
@@ -0,0 +1,31 @@
+# The VCS to use.  Valid options are: git, hg, bzr and darcs
+VCS="@VCS@"
+
+# Options passed to git commit when run by etckeeper.
+#GIT_COMMIT_OPTIONS=""
+
+# Options passed to hg commit when run by etckeeper.
+#HG_COMMIT_OPTIONS=""
+
+# Options passed to bzr commit when run by etckeeper.
+#BZR_COMMIT_OPTIONS=""
+
+# Options passed to darcs commit when run by etckeeper.
+#DARCS_COMMIT_OPTIONS=""
+
+# Uncomment to avoid etckeeper committing existing changes
+# to /etc automatically once per day.
+#AVOID_DAILY_AUTOCOMMITS=1
+
+# Uncomment to avoid etckeeper committing existing changes to 
+# /etc before installation. It will cancel the installation,
+# so you can commit the changes by hand.
+#AVOID_COMMIT_BEFORE_INSTALL=1
+
+# The high-level package manager that's being used.
+# (apt, pacman-g2, yum etc)
+HIGHLEVEL_PACKAGE_MANAGER=@HIGHLEVEL@
+
+# The low-level package manager that's being used.
+# (dpkg, rpm, pacman-g2, etc)
+LOWLEVEL_PACKAGE_MANAGER=@LOWLEVEL@
diff --git a/etckeeper.in b/etckeeper.in
new file mode 100644
index 0000000..bcea0b0
--- /dev/null
+++ b/etckeeper.in
@@ -0,0 +1,92 @@
+#!@SHELLPATH@
+set -e
+
+if [ -z "$ETCKEEPER_CONF_DIR" ]; then
+	ETCKEEPER_CONF_DIR=@sysconfdir@/etckeeper
+fi
+
+conf="$ETCKEEPER_CONF_DIR/etckeeper.conf"
+
+usage() {
+	echo "usage: etckeeper command [-d directory]" >&2
+	exit 1
+}
+
+if [ -e $conf ]; then
+	. $conf
+fi
+
+if [ -z "$VCS" ]; then
+	echo "Please configure a VCS in $conf" >&2
+	exit 1
+fi
+export VCS
+
+if [ ! -z "$GIT_COMMIT_OPTIONS" ]; then
+	export GIT_COMMIT_OPTIONS
+fi
+if [ ! -z "$HG_COMMIT_OPTIONS" ]; then
+	export HG_COMMIT_OPTIONS
+fi
+if [ ! -z "$BZR_COMMIT_OPTIONS" ]; then
+	export BZR_COMMIT_OPTIONS
+fi
+if [ ! -z "$DARCS_COMMIT_OPTIONS" ]; then
+	export DARCS_COMMIT_OPTIONS
+fi
+
+if [ ! -z "$HIGHLEVEL_PACKAGE_MANAGER" ]; then
+	export HIGHLEVEL_PACKAGE_MANAGER
+fi
+if [ ! -z "$LOWLEVEL_PACKAGE_MANAGER" ]; then
+	export LOWLEVEL_PACKAGE_MANAGER
+fi
+if [ ! -z "$AVOID_COMMIT_BEFORE_INSTALL" ]; then
+	export AVOID_COMMIT_BEFORE_INSTALL
+fi
+
+if [ -z "$1" ]; then
+	usage
+fi
+command="$1"
+shift 1
+
+# compatability code
+if [ "$command" = "post-apt" ]; then
+	command=post-install
+elif [ "$command" = "pre-apt" ]; then
+	command=pre-install
+fi
+
+if [ ! -d "$ETCKEEPER_CONF_DIR/$command.d" ]; then
+	echo "etckeeper: $ETCKEEPER_CONF_DIR/$command.d does not exist" >&2
+	exit 1
+fi
+
+if [ "x$1" = "x-d" ]; then
+	if [ -n "$2" ]; then
+		ETCKEEPER_DIR="$2"
+		shift 2
+	else
+		usage
+	fi
+fi
+
+if [ -z "$ETCKEEPER_DIR" ]; then
+	ETCKEEPER_DIR=/etc
+fi
+cd "$ETCKEEPER_DIR"
+export ETCKEEPER_DIR
+
+lsscripts() {
+	perl -e '
+		$dir=shift;
+		print join "\n", grep { ! -d $_ && -x $_ }
+			grep /^\Q$dir\/\E[-a-zA-Z0-9]+$/,
+			glob "$dir/*";
+	' "$1"
+}
+
+for script in $(lsscripts "$ETCKEEPER_CONF_DIR/$command.d"); do
+	"$script" "$@"
+done
diff --git a/init.d/10restore-metadata b/init.d/10restore-metadata
deleted file mode 100755
index 9c2bf65..0000000
--- a/init.d/10restore-metadata
+++ /dev/null
@@ -1,14 +0,0 @@
-#!/bin/sh
-set -e
-
-# Note that metastore doesn't check that the .metastore file only changes
-# perms of files in the current directory. It's ok to trust the .metastore
-# file won't do anything shady, because, as documented, etckeeper-init
-# should only be run on repositories you trust.
-if [ -e .metadata ]; then
-	if which metastore >/dev/null; then
-		metastore --apply --mtime
-	else
-		echo "etckeeper warning: legacy .metastore file is present but metastore is not installed" >&2
-	fi
-fi
diff --git a/init.d/10restore-metadata.in b/init.d/10restore-metadata.in
new file mode 100644
index 0000000..8aef5b5
--- /dev/null
+++ b/init.d/10restore-metadata.in
@@ -0,0 +1,14 @@
+#!@SHELLPATH@
+set -e
+
+# Note that metastore doesn't check that the .metastore file only changes
+# perms of files in the current directory. It's ok to trust the .metastore
+# file won't do anything shady, because, as documented, etckeeper-init
+# should only be run on repositories you trust.
+if [ -e .metadata ]; then
+	if which metastore >/dev/null; then
+		metastore --apply --mtime
+	else
+		echo "etckeeper warning: legacy .metastore file is present but metastore is not installed" >&2
+	fi
+fi
diff --git a/init.d/20restore-etckeeper b/init.d/20restore-etckeeper
deleted file mode 100755
index 5dc4425..0000000
--- a/init.d/20restore-etckeeper
+++ /dev/null
@@ -1,22 +0,0 @@
-#!/bin/sh
-set -e
-
-# Used by .etckeeper to run a command if the file it acts on
-# (the last parameter) exists.
-maybe () {
-	command="$1"
-	shift 1
-
-	if eval [ -e "\$$#" ]; then
-		"$command" "$@"
-	fi
-}
-
-# Yes, this runs code from the repository. As documented, etckeeper-init
-# should only be run on repositories you trust.
-if [ -e .etckeeper ]; then
-	. ./.etckeeper
-else
-	touch .etckeeper
-	chmod 600 .etckeeper
-fi
diff --git a/init.d/20restore-etckeeper.in b/init.d/20restore-etckeeper.in
new file mode 100644
index 0000000..8ffb7f1
--- /dev/null
+++ b/init.d/20restore-etckeeper.in
@@ -0,0 +1,22 @@
+#!@SHELLPATH@
+set -e
+
+# Used by .etckeeper to run a command if the file it acts on
+# (the last parameter) exists.
+maybe () {
+	command="$1"
+	shift 1
+
+	if eval [ -e "\$$#" ]; then
+		"$command" "$@"
+	fi
+}
+
+# Yes, this runs code from the repository. As documented, etckeeper-init
+# should only be run on repositories you trust.
+if [ -e .etckeeper ]; then
+	. ./.etckeeper
+else
+	touch .etckeeper
+	chmod 600 .etckeeper
+fi
diff --git a/init.d/40vcs-init b/init.d/40vcs-init
deleted file mode 100755
index 3c7a3bb..0000000
--- a/init.d/40vcs-init
+++ /dev/null
@@ -1,17 +0,0 @@
-#!/bin/sh
-set -e
-
-if [ "$VCS" = git ] && [ ! -e .git ]; then
-	git init
-	echo "$(hostname) /etc repository" > .git/description
-elif [ "$VCS" = hg ] && [ ! -e .hg ]; then
-	hg init
-	echo  "[web]" > .hg/hgrc
-	echo  "description = $(hostname) /etc repository" >> .hg/hgrc
-elif [ "$VCS" = bzr ] && [ ! -e .bzr ]; then
-	bzr init
-	bzr nick "$(hostname) /etc repository"
-elif [ "$VCS" = darcs ] && [ ! -e _darcs ]; then
-	darcs initialize
-	echo "$(hostname) /etc repository" > _darcs/prefs/motd
-fi
diff --git a/init.d/40vcs-init.in b/init.d/40vcs-init.in
new file mode 100644
index 0000000..1cf512f
--- /dev/null
+++ b/init.d/40vcs-init.in
@@ -0,0 +1,17 @@
+#!@SHELLPATH@
+set -e
+
+if [ "$VCS" = git ] && [ ! -e .git ]; then
+	git init
+	echo "$(hostname) /etc repository" > .git/description
+elif [ "$VCS" = hg ] && [ ! -e .hg ]; then
+	hg init
+	echo  "[web]" > .hg/hgrc
+	echo  "description = $(hostname) /etc repository" >> .hg/hgrc
+elif [ "$VCS" = bzr ] && [ ! -e .bzr ]; then
+	bzr init
+	bzr nick "$(hostname) /etc repository"
+elif [ "$VCS" = darcs ] && [ ! -e _darcs ]; then
+	darcs initialize
+	echo "$(hostname) /etc repository" > _darcs/prefs/motd
+fi
diff --git a/init.d/50vcs-ignore b/init.d/50vcs-ignore
deleted file mode 100755
index bcc88ba..0000000
--- a/init.d/50vcs-ignore
+++ /dev/null
@@ -1,4 +0,0 @@
-#!/bin/sh
-set -e
-
-etckeeper update-ignore || true
diff --git a/init.d/50vcs-ignore.in b/init.d/50vcs-ignore.in
new file mode 100644
index 0000000..0e703dc
--- /dev/null
+++ b/init.d/50vcs-ignore.in
@@ -0,0 +1,4 @@
+#!@SHELLPATH@
+set -e
+
+etckeeper update-ignore || true
diff --git a/init.d/50vcs-perm b/init.d/50vcs-perm
deleted file mode 100755
index 4dd080b..0000000
--- a/init.d/50vcs-perm
+++ /dev/null
@@ -1,12 +0,0 @@
-#!/bin/sh
-set -e
-
-if [ "$VCS" = git ]; then
-	chmod 700 .git
-elif [ "$VCS" = hg ]; then
-	chmod 700 .hg
-elif [ "$VCS" = bzr ]; then
-	chmod 700 .bzr
-elif [ "$VCS" = darcs ]; then
-	chmod 700 _darcs
-fi
diff --git a/init.d/50vcs-perm.in b/init.d/50vcs-perm.in
new file mode 100644
index 0000000..95b2a2e
--- /dev/null
+++ b/init.d/50vcs-perm.in
@@ -0,0 +1,12 @@
+#!@SHELLPATH@
+set -e
+
+if [ "$VCS" = git ]; then
+	chmod 700 .git
+elif [ "$VCS" = hg ]; then
+	chmod 700 .hg
+elif [ "$VCS" = bzr ]; then
+	chmod 700 .bzr
+elif [ "$VCS" = darcs ]; then
+	chmod 700 _darcs
+fi
diff --git a/init.d/50vcs-pre-commit-hook b/init.d/50vcs-pre-commit-hook
deleted file mode 100755
index 06d433b..0000000
--- a/init.d/50vcs-pre-commit-hook
+++ /dev/null
@@ -1,47 +0,0 @@
-#!/bin/sh
-set -e
-
-case "$VCS" in
-	git)
-		if [ -x .git/hooks/pre-commit ]; then
-			if ! grep -q "etckeeper pre-commit" .git/hooks/pre-commit; then
-				echo "etckeeper warning: .git/hooks/pre-commit needs to be manually modified to run: etckeeper pre-commit -d `pwd`" >&2
-			fi
-		else
-			cat >.git/hooks/pre-commit <<EOF
-#!/bin/sh
-# pre-commit hook for etckeeper, to store metadata and do sanity checks
-set -e
-etckeeper pre-commit -d `pwd`
-EOF
-		chmod +x .git/hooks/pre-commit
-		fi
-	;;
-	hg)
-		if [ -e .hg/hgrc ] && grep "^\[hooks\]" .hg/hgrc; then
-			echo "etckeeper warning: [hooks] section in .hg/hgrc needs to be manually modified to run: etckeeper pre-commit -d `pwd`" >&2
-		else
-		touch .hg/hgrc
-		cat >>.hg/hgrc <<EOF
-[hooks]
-# pre-commit hook for etckeeper, to store metadata and do sanity checks
-precommit = etckeeper pre-commit -d `pwd`
-EOF
-		fi
-	;;
-	darcs)
-		if [ -e _darcs/prefs/defaults ]; then
-			if ! ( grep -q "record prehook etckeeper pre-commit" _darcs/prefs/defaults &&
-				grep -q "whatsnew prehook etckeeper pre-commit" _darcs/prefs/defaults ); then
-				echo "etckeeper warning: _darcs/prefs/defaults needs to be manually modified to run: etckeeper pre-commit -d `pwd`" >&2
-			fi
-		else
-			cat >_darcs/prefs/defaults <<EOF
-record prehook etckeeper pre-commit -d `pwd`
-record run-prehook
-whatsnew prehook etckeeper pre-commit -d `pwd`
-whatsnew run-prehook
-EOF
-		fi
-	;;
-esac
diff --git a/init.d/50vcs-pre-commit-hook.in b/init.d/50vcs-pre-commit-hook.in
new file mode 100644
index 0000000..f0152c1
--- /dev/null
+++ b/init.d/50vcs-pre-commit-hook.in
@@ -0,0 +1,47 @@
+#!@SHELLPATH@
+set -e
+
+case "$VCS" in
+	git)
+		if [ -x .git/hooks/pre-commit ]; then
+			if ! grep -q "etckeeper pre-commit" .git/hooks/pre-commit; then
+				echo "etckeeper warning: .git/hooks/pre-commit needs to be manually modified to run: etckeeper pre-commit -d `pwd`" >&2
+			fi
+		else
+			cat >.git/hooks/pre-commit <<EOF
+#!@SHELLPATH@
+# pre-commit hook for etckeeper, to store metadata and do sanity checks
+set -e
+etckeeper pre-commit -d `pwd`
+EOF
+		chmod +x .git/hooks/pre-commit
+		fi
+	;;
+	hg)
+		if [ -e .hg/hgrc ] && grep "^\[hooks\]" .hg/hgrc; then
+			echo "etckeeper warning: [hooks] section in .hg/hgrc needs to be manually modified to run: etckeeper pre-commit -d `pwd`" >&2
+		else
+		touch .hg/hgrc
+		cat >>.hg/hgrc <<EOF
+[hooks]
+# pre-commit hook for etckeeper, to store metadata and do sanity checks
+precommit = etckeeper pre-commit -d `pwd`
+EOF
+		fi
+	;;
+	darcs)
+		if [ -e _darcs/prefs/defaults ]; then
+			if ! ( grep -q "record prehook etckeeper pre-commit" _darcs/prefs/defaults &&
+				grep -q "whatsnew prehook etckeeper pre-commit" _darcs/prefs/defaults ); then
+				echo "etckeeper warning: _darcs/prefs/defaults needs to be manually modified to run: etckeeper pre-commit -d `pwd`" >&2
+			fi
+		else
+			cat >_darcs/prefs/defaults <<EOF
+record prehook etckeeper pre-commit -d `pwd`
+record run-prehook
+whatsnew prehook etckeeper pre-commit -d `pwd`
+whatsnew run-prehook
+EOF
+		fi
+	;;
+esac
diff --git a/init.d/60darcs-deleted-symlinks b/init.d/60darcs-deleted-symlinks
deleted file mode 100755
index 8d10d56..0000000
--- a/init.d/60darcs-deleted-symlinks
+++ /dev/null
@@ -1,48 +0,0 @@
-#!/bin/sh
-set -e
-
-filter_ignore() {
-	if [ "$VCS" = darcs ]; then
-		ignorefile=.darcsignore
-	fi
-
-	if [ "$VCS" = darcs ] && [ -e "$ignorefile" ]; then
-		# Spaces embedded into patterns would break it.
-		# But really, why would anyone want to use ' ' instead of '\s' ?
-		#patterns=$( grep -v '^[[:space:]]*\(#\|$\)' "$ignorefile" | xargs -n 1 printf " -e %s" )
-		#grep -Ev $patterns
-		#unset patterns
-		# Alternative using a temp file
-		patternsfile="$( mktemp -t etckeeper-$VCS.XXXXXXXXXX )"
-		grep -v '^[[:space:]]*\(#\|$\)' "$ignorefile" > "$patternsfile" || true
-		grep -Evf "$patternsfile"
-		rm -f "$patternsfile"
-		unset patternsfile
-	else
-		cat -
-	fi
-}
-
-
-if [ "$VCS" = darcs ];then
-	NOVCS='. -wholename ./.git -prune -o -wholename ./.bzr -prune -o -wholename ./.hg -prune -o -wholename ./_darcs -prune -o'
-
-	# We assume that if .etckeeper is empty this is the first run
-	if [ -s .etckeeper ]; then
-		linksindex="$( mktemp -t etckeeper-$VCS.XXXXXXXXXX )"
-		grep '^ln -s' .etckeeper | while IFS="'" read n n n link n; do
-			printf "%s\n" "$link" >> "$linksindex"
-		done
-
-		# Warn about symbolic links that shouldn't exist
-		if links=$( find $NOVCS -type l -print | filter_ignore | grep -vFf "$linksindex" ); then
-			printf "%s\n%s\n" \
-				"The following symbolic links should not exist:" \
-				"$links" >&2
-		fi
-
-		rm -f "$linksindex"
-		unset links linksindex
-	fi
-
-fi
diff --git a/init.d/60darcs-deleted-symlinks.in b/init.d/60darcs-deleted-symlinks.in
new file mode 100644
index 0000000..f7ee17f
--- /dev/null
+++ b/init.d/60darcs-deleted-symlinks.in
@@ -0,0 +1,48 @@
+#!@SHELLPATH@
+set -e
+
+filter_ignore() {
+	if [ "$VCS" = darcs ]; then
+		ignorefile=.darcsignore
+	fi
+
+	if [ "$VCS" = darcs ] && [ -e "$ignorefile" ]; then
+		# Spaces embedded into patterns would break it.
+		# But really, why would anyone want to use ' ' instead of '\s' ?
+		#patterns=$( grep -v '^[[:space:]]*\(#\|$\)' "$ignorefile" | xargs -n 1 printf " -e %s" )
+		#grep -Ev $patterns
+		#unset patterns
+		# Alternative using a temp file
+		patternsfile="$( mktemp -t etckeeper-$VCS.XXXXXXXXXX )"
+		grep -v '^[[:space:]]*\(#\|$\)' "$ignorefile" > "$patternsfile" || true
+		grep -Evf "$patternsfile"
+		rm -f "$patternsfile"
+		unset patternsfile
+	else
+		cat -
+	fi
+}
+
+
+if [ "$VCS" = darcs ];then
+	NOVCS='. -wholename ./.git -prune -o -wholename ./.bzr -prune -o -wholename ./.hg -prune -o -wholename ./_darcs -prune -o'
+
+	# We assume that if .etckeeper is empty this is the first run
+	if [ -s .etckeeper ]; then
+		linksindex="$( mktemp -t etckeeper-$VCS.XXXXXXXXXX )"
+		grep '^ln -s' .etckeeper | while IFS="'" read n n n link n; do
+			printf "%s\n" "$link" >> "$linksindex"
+		done
+
+		# Warn about symbolic links that shouldn't exist
+		if links=$( find $NOVCS -type l -print | filter_ignore | grep -vFf "$linksindex" ); then
+			printf "%s\n%s\n" \
+				"The following symbolic links should not exist:" \
+				"$links" >&2
+		fi
+
+		rm -f "$linksindex"
+		unset links linksindex
+	fi
+
+fi
diff --git a/init.d/70vcs-add b/init.d/70vcs-add
deleted file mode 100755
index 9a9ec45..0000000
--- a/init.d/70vcs-add
+++ /dev/null
@@ -1,27 +0,0 @@
-#!/bin/sh
-set -e
-
-if [ "$VCS" = git ]; then
-	if ! git add .; then
-		echo "etckeeper warning: git add failed" >&2
-	fi
-elif [ "$VCS" = hg ]; then
-	if ! hg add .; then
-		echo "etckeeper warning: hg add failed" >&2
-	fi
-elif [ "$VCS" = bzr ]; then
-	if ! bzr add .; then
-		echo "etckeeper warning: bzr add failed" >&2
-	fi
-elif [ "$VCS" = darcs ]; then
-	# Don't warn if all the files were already added.
-	rc=0
-	res=$( darcs add -qr . 2>&1 ) || rc=$?
-	if test $rc -ne 0; then
-		if ! test $rc -eq 2 -a "${res%No files were added}" != "$res"; then
-			printf "%s" "$res"
-			echo "etckeeper warning: darcs add failed" >&2
-		fi
-	fi
-	unset rc res
-fi
diff --git a/init.d/70vcs-add.in b/init.d/70vcs-add.in
new file mode 100644
index 0000000..eb8a94c
--- /dev/null
+++ b/init.d/70vcs-add.in
@@ -0,0 +1,27 @@
+#!@SHELLPATH@
+set -e
+
+if [ "$VCS" = git ]; then
+	if ! git add .; then
+		echo "etckeeper warning: git add failed" >&2
+	fi
+elif [ "$VCS" = hg ]; then
+	if ! hg add .; then
+		echo "etckeeper warning: hg add failed" >&2
+	fi
+elif [ "$VCS" = bzr ]; then
+	if ! bzr add .; then
+		echo "etckeeper warning: bzr add failed" >&2
+	fi
+elif [ "$VCS" = darcs ]; then
+	# Don't warn if all the files were already added.
+	rc=0
+	res=$( darcs add -qr . 2>&1 ) || rc=$?
+	if test $rc -ne 0; then
+		if ! test $rc -eq 2 -a "${res%No files were added}" != "$res"; then
+			printf "%s" "$res"
+			echo "etckeeper warning: darcs add failed" >&2
+		fi
+	fi
+	unset rc res
+fi
diff --git a/install-sh b/install-sh
new file mode 100755
index 0000000..a5897de
--- /dev/null
+++ b/install-sh
@@ -0,0 +1,519 @@
+#!/bin/sh
+# install - install a program, script, or datafile
+
+scriptversion=2006-12-25.00
+
+# This originates from X11R5 (mit/util/scripts/install.sh), which was
+# later released in X11R6 (xc/config/util/install.sh) with the
+# following copyright and license.
+#
+# Copyright (C) 1994 X Consortium
+#
+# Permission is hereby granted, free of charge, to any person obtaining a copy
+# of this software and associated documentation files (the "Software"), to
+# deal in the Software without restriction, including without limitation the
+# rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
+# sell copies of the Software, and to permit persons to whom the Software is
+# furnished to do so, subject to the following conditions:
+#
+# The above copyright notice and this permission notice shall be included in
+# all copies or substantial portions of the Software.
+#
+# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
+# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
+# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL THE
+# X CONSORTIUM BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN
+# AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNEC-
+# TION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+#
+# Except as contained in this notice, the name of the X Consortium shall not
+# be used in advertising or otherwise to promote the sale, use or other deal-
+# ings in this Software without prior written authorization from the X Consor-
+# tium.
+#
+#
+# FSF changes to this file are in the public domain.
+#
+# Calling this script install-sh is preferred over install.sh, to prevent
+# `make' implicit rules from creating a file called install from it
+# when there is no Makefile.
+#
+# This script is compatible with the BSD install script, but was written
+# from scratch.
+
+nl='
+'
+IFS=" ""	$nl"
+
+# set DOITPROG to echo to test this script
+
+# Don't use :- since 4.3BSD and earlier shells don't like it.
+doit=${DOITPROG-}
+if test -z "$doit"; then
+  doit_exec=exec
+else
+  doit_exec=$doit
+fi
+
+# Put in absolute file names if you don't have them in your path;
+# or use environment vars.
+
+chgrpprog=${CHGRPPROG-chgrp}
+chmodprog=${CHMODPROG-chmod}
+chownprog=${CHOWNPROG-chown}
+cmpprog=${CMPPROG-cmp}
+cpprog=${CPPROG-cp}
+mkdirprog=${MKDIRPROG-mkdir}
+mvprog=${MVPROG-mv}
+rmprog=${RMPROG-rm}
+stripprog=${STRIPPROG-strip}
+
+posix_glob='?'
+initialize_posix_glob='
+  test "$posix_glob" != "?" || {
+    if (set -f) 2>/dev/null; then
+      posix_glob=
+    else
+      posix_glob=:
+    fi
+  }
+'
+
+posix_mkdir=
+
+# Desired mode of installed file.
+mode=0755
+
+chgrpcmd=
+chmodcmd=$chmodprog
+chowncmd=
+mvcmd=$mvprog
+rmcmd="$rmprog -f"
+stripcmd=
+
+src=
+dst=
+dir_arg=
+dst_arg=
+
+copy_on_change=false
+no_target_directory=
+
+usage="\
+Usage: $0 [OPTION]... [-T] SRCFILE DSTFILE
+   or: $0 [OPTION]... SRCFILES... DIRECTORY
+   or: $0 [OPTION]... -t DIRECTORY SRCFILES...
+   or: $0 [OPTION]... -d DIRECTORIES...
+
+In the 1st form, copy SRCFILE to DSTFILE.
+In the 2nd and 3rd, copy all SRCFILES to DIRECTORY.
+In the 4th, create DIRECTORIES.
+
+Options:
+     --help     display this help and exit.
+     --version  display version info and exit.
+
+  -c            (ignored)
+  -C            install only if different (preserve the last data modification time)
+  -d            create directories instead of installing files.
+  -g GROUP      $chgrpprog installed files to GROUP.
+  -m MODE       $chmodprog installed files to MODE.
+  -o USER       $chownprog installed files to USER.
+  -s            $stripprog installed files.
+  -t DIRECTORY  install into DIRECTORY.
+  -T            report an error if DSTFILE is a directory.
+
+Environment variables override the default commands:
+  CHGRPPROG CHMODPROG CHOWNPROG CMPPROG CPPROG MKDIRPROG MVPROG
+  RMPROG STRIPPROG
+"
+
+while test $# -ne 0; do
+  case $1 in
+    -c) ;;
+
+    -C) copy_on_change=true;;
+
+    -d) dir_arg=true;;
+
+    -g) chgrpcmd="$chgrpprog $2"
+	shift;;
+
+    --help) echo "$usage"; exit $?;;
+
+    -m) mode=$2
+	case $mode in
+	  *' '* | *'	'* | *'
+'*	  | *'*'* | *'?'* | *'['*)
+	    echo "$0: invalid mode: $mode" >&2
+	    exit 1;;
+	esac
+	shift;;
+
+    -o) chowncmd="$chownprog $2"
+	shift;;
+
+    -s) stripcmd=$stripprog;;
+
+    -t) dst_arg=$2
+	shift;;
+
+    -T) no_target_directory=true;;
+
+    --version) echo "$0 $scriptversion"; exit $?;;
+
+    --)	shift
+	break;;
+
+    -*)	echo "$0: invalid option: $1" >&2
+	exit 1;;
+
+    *)  break;;
+  esac
+  shift
+done
+
+if test $# -ne 0 && test -z "$dir_arg$dst_arg"; then
+  # When -d is used, all remaining arguments are directories to create.
+  # When -t is used, the destination is already specified.
+  # Otherwise, the last argument is the destination.  Remove it from $@.
+  for arg
+  do
+    if test -n "$dst_arg"; then
+      # $@ is not empty: it contains at least $arg.
+      set fnord "$@" "$dst_arg"
+      shift # fnord
+    fi
+    shift # arg
+    dst_arg=$arg
+  done
+fi
+
+if test $# -eq 0; then
+  if test -z "$dir_arg"; then
+    echo "$0: no input file specified." >&2
+    exit 1
+  fi
+  # It's OK to call `install-sh -d' without argument.
+  # This can happen when creating conditional directories.
+  exit 0
+fi
+
+if test -z "$dir_arg"; then
+  trap '(exit $?); exit' 1 2 13 15
+
+  # Set umask so as not to create temps with too-generous modes.
+  # However, 'strip' requires both read and write access to temps.
+  case $mode in
+    # Optimize common cases.
+    *644) cp_umask=133;;
+    *755) cp_umask=22;;
+
+    *[0-7])
+      if test -z "$stripcmd"; then
+	u_plus_rw=
+      else
+	u_plus_rw='% 200'
+      fi
+      cp_umask=`expr '(' 777 - $mode % 1000 ')' $u_plus_rw`;;
+    *)
+      if test -z "$stripcmd"; then
+	u_plus_rw=
+      else
+	u_plus_rw=,u+rw
+      fi
+      cp_umask=$mode$u_plus_rw;;
+  esac
+fi
+
+for src
+do
+  # Protect names starting with `-'.
+  case $src in
+    -*) src=./$src;;
+  esac
+
+  if test -n "$dir_arg"; then
+    dst=$src
+    dstdir=$dst
+    test -d "$dstdir"
+    dstdir_status=$?
+  else
+
+    # Waiting for this to be detected by the "$cpprog $src $dsttmp" command
+    # might cause directories to be created, which would be especially bad
+    # if $src (and thus $dsttmp) contains '*'.
+    if test ! -f "$src" && test ! -d "$src"; then
+      echo "$0: $src does not exist." >&2
+      exit 1
+    fi
+
+    if test -z "$dst_arg"; then
+      echo "$0: no destination specified." >&2
+      exit 1
+    fi
+
+    dst=$dst_arg
+    # Protect names starting with `-'.
+    case $dst in
+      -*) dst=./$dst;;
+    esac
+
+    # If destination is a directory, append the input filename; won't work
+    # if double slashes aren't ignored.
+    if test -d "$dst"; then
+      if test -n "$no_target_directory"; then
+	echo "$0: $dst_arg: Is a directory" >&2
+	exit 1
+      fi
+      dstdir=$dst
+      dst=$dstdir/`basename "$src"`
+      dstdir_status=0
+    else
+      # Prefer dirname, but fall back on a substitute if dirname fails.
+      dstdir=`
+	(dirname "$dst") 2>/dev/null ||
+	expr X"$dst" : 'X\(.*[^/]\)//*[^/][^/]*/*$' \| \
+	     X"$dst" : 'X\(//\)[^/]' \| \
+	     X"$dst" : 'X\(//\)$' \| \
+	     X"$dst" : 'X\(/\)' \| . 2>/dev/null ||
+	echo X"$dst" |
+	    sed '/^X\(.*[^/]\)\/\/*[^/][^/]*\/*$/{
+		   s//\1/
+		   q
+		 }
+		 /^X\(\/\/\)[^/].*/{
+		   s//\1/
+		   q
+		 }
+		 /^X\(\/\/\)$/{
+		   s//\1/
+		   q
+		 }
+		 /^X\(\/\).*/{
+		   s//\1/
+		   q
+		 }
+		 s/.*/./; q'
+      `
+
+      test -d "$dstdir"
+      dstdir_status=$?
+    fi
+  fi
+
+  obsolete_mkdir_used=false
+
+  if test $dstdir_status != 0; then
+    case $posix_mkdir in
+      '')
+	# Create intermediate dirs using mode 755 as modified by the umask.
+	# This is like FreeBSD 'install' as of 1997-10-28.
+	umask=`umask`
+	case $stripcmd.$umask in
+	  # Optimize common cases.
+	  *[2367][2367]) mkdir_umask=$umask;;
+	  .*0[02][02] | .[02][02] | .[02]) mkdir_umask=22;;
+
+	  *[0-7])
+	    mkdir_umask=`expr $umask + 22 \
+	      - $umask % 100 % 40 + $umask % 20 \
+	      - $umask % 10 % 4 + $umask % 2
+	    `;;
+	  *) mkdir_umask=$umask,go-w;;
+	esac
+
+	# With -d, create the new directory with the user-specified mode.
+	# Otherwise, rely on $mkdir_umask.
+	if test -n "$dir_arg"; then
+	  mkdir_mode=-m$mode
+	else
+	  mkdir_mode=
+	fi
+
+	posix_mkdir=false
+	case $umask in
+	  *[123567][0-7][0-7])
+	    # POSIX mkdir -p sets u+wx bits regardless of umask, which
+	    # is incompatible with FreeBSD 'install' when (umask & 300) != 0.
+	    ;;
+	  *)
+	    tmpdir=${TMPDIR-/tmp}/ins$RANDOM-$$
+	    trap 'ret=$?; rmdir "$tmpdir/d" "$tmpdir" 2>/dev/null; exit $ret' 0
+
+	    if (umask $mkdir_umask &&
+		exec $mkdirprog $mkdir_mode -p -- "$tmpdir/d") >/dev/null 2>&1
+	    then
+	      if test -z "$dir_arg" || {
+		   # Check for POSIX incompatibilities with -m.
+		   # HP-UX 11.23 and IRIX 6.5 mkdir -m -p sets group- or
+		   # other-writeable bit of parent directory when it shouldn't.
+		   # FreeBSD 6.1 mkdir -m -p sets mode of existing directory.
+		   ls_ld_tmpdir=`ls -ld "$tmpdir"`
+		   case $ls_ld_tmpdir in
+		     d????-?r-*) different_mode=700;;
+		     d????-?--*) different_mode=755;;
+		     *) false;;
+		   esac &&
+		   $mkdirprog -m$different_mode -p -- "$tmpdir" && {
+		     ls_ld_tmpdir_1=`ls -ld "$tmpdir"`
+		     test "$ls_ld_tmpdir" = "$ls_ld_tmpdir_1"
+		   }
+		 }
+	      then posix_mkdir=:
+	      fi
+	      rmdir "$tmpdir/d" "$tmpdir"
+	    else
+	      # Remove any dirs left behind by ancient mkdir implementations.
+	      rmdir ./$mkdir_mode ./-p ./-- 2>/dev/null
+	    fi
+	    trap '' 0;;
+	esac;;
+    esac
+
+    if
+      $posix_mkdir && (
+	umask $mkdir_umask &&
+	$doit_exec $mkdirprog $mkdir_mode -p -- "$dstdir"
+      )
+    then :
+    else
+
+      # The umask is ridiculous, or mkdir does not conform to POSIX,
+      # or it failed possibly due to a race condition.  Create the
+      # directory the slow way, step by step, checking for races as we go.
+
+      case $dstdir in
+	/*) prefix='/';;
+	-*) prefix='./';;
+	*)  prefix='';;
+      esac
+
+      eval "$initialize_posix_glob"
+
+      oIFS=$IFS
+      IFS=/
+      $posix_glob set -f
+      set fnord $dstdir
+      shift
+      $posix_glob set +f
+      IFS=$oIFS
+
+      prefixes=
+
+      for d
+      do
+	test -z "$d" && continue
+
+	prefix=$prefix$d
+	if test -d "$prefix"; then
+	  prefixes=
+	else
+	  if $posix_mkdir; then
+	    (umask=$mkdir_umask &&
+	     $doit_exec $mkdirprog $mkdir_mode -p -- "$dstdir") && break
+	    # Don't fail if two instances are running concurrently.
+	    test -d "$prefix" || exit 1
+	  else
+	    case $prefix in
+	      *\'*) qprefix=`echo "$prefix" | sed "s/'/'\\\\\\\\''/g"`;;
+	      *) qprefix=$prefix;;
+	    esac
+	    prefixes="$prefixes '$qprefix'"
+	  fi
+	fi
+	prefix=$prefix/
+      done
+
+      if test -n "$prefixes"; then
+	# Don't fail if two instances are running concurrently.
+	(umask $mkdir_umask &&
+	 eval "\$doit_exec \$mkdirprog $prefixes") ||
+	  test -d "$dstdir" || exit 1
+	obsolete_mkdir_used=true
+      fi
+    fi
+  fi
+
+  if test -n "$dir_arg"; then
+    { test -z "$chowncmd" || $doit $chowncmd "$dst"; } &&
+    { test -z "$chgrpcmd" || $doit $chgrpcmd "$dst"; } &&
+    { test "$obsolete_mkdir_used$chowncmd$chgrpcmd" = false ||
+      test -z "$chmodcmd" || $doit $chmodcmd $mode "$dst"; } || exit 1
+  else
+
+    # Make a couple of temp file names in the proper directory.
+    dsttmp=$dstdir/_inst.$$_
+    rmtmp=$dstdir/_rm.$$_
+
+    # Trap to clean up those temp files at exit.
+    trap 'ret=$?; rm -f "$dsttmp" "$rmtmp" && exit $ret' 0
+
+    # Copy the file name to the temp name.
+    (umask $cp_umask && $doit_exec $cpprog "$src" "$dsttmp") &&
+
+    # and set any options; do chmod last to preserve setuid bits.
+    #
+    # If any of these fail, we abort the whole thing.  If we want to
+    # ignore errors from any of these, just make sure not to ignore
+    # errors from the above "$doit $cpprog $src $dsttmp" command.
+    #
+    { test -z "$chowncmd" || $doit $chowncmd "$dsttmp"; } &&
+    { test -z "$chgrpcmd" || $doit $chgrpcmd "$dsttmp"; } &&
+    { test -z "$stripcmd" || $doit $stripcmd "$dsttmp"; } &&
+    { test -z "$chmodcmd" || $doit $chmodcmd $mode "$dsttmp"; } &&
+
+    # If -C, don't bother to copy if it wouldn't change the file.
+    if $copy_on_change &&
+       old=`LC_ALL=C ls -dlL "$dst"	2>/dev/null` &&
+       new=`LC_ALL=C ls -dlL "$dsttmp"	2>/dev/null` &&
+
+       eval "$initialize_posix_glob" &&
+       $posix_glob set -f &&
+       set X $old && old=:$2:$4:$5:$6 &&
+       set X $new && new=:$2:$4:$5:$6 &&
+       $posix_glob set +f &&
+
+       test "$old" = "$new" &&
+       $cmpprog "$dst" "$dsttmp" >/dev/null 2>&1
+    then
+      rm -f "$dsttmp"
+    else
+      # Rename the file to the real destination.
+      $doit $mvcmd -f "$dsttmp" "$dst" 2>/dev/null ||
+
+      # The rename failed, perhaps because mv can't rename something else
+      # to itself, or perhaps because mv is so ancient that it does not
+      # support -f.
+      {
+	# Now remove or move aside any old file at destination location.
+	# We try this two ways since rm can't unlink itself on some
+	# systems and the destination file might be busy for other
+	# reasons.  In this case, the final cleanup might fail but the new
+	# file should still install successfully.
+	{
+	  test ! -f "$dst" ||
+	  $doit $rmcmd -f "$dst" 2>/dev/null ||
+	  { $doit $mvcmd -f "$dst" "$rmtmp" 2>/dev/null &&
+	    { $doit $rmcmd -f "$rmtmp" 2>/dev/null; :; }
+	  } ||
+	  { echo "$0: cannot unlink or rename $dst" >&2
+	    (exit 1); exit 1
+	  }
+	} &&
+
+	# Now rename the file to the real destination.
+	$doit $mvcmd "$dsttmp" "$dst"
+      }
+    fi || exit 1
+
+    trap '' 0
+  fi
+done
+
+# Local variables:
+# eval: (add-hook 'write-file-hooks 'time-stamp)
+# time-stamp-start: "scriptversion="
+# time-stamp-format: "%:y-%02m-%02d.%02H"
+# time-stamp-end: "$"
+# End:
diff --git a/list-installed.d/50list-installed b/list-installed.d/50list-installed
deleted file mode 100755
index 177a6c2..0000000
--- a/list-installed.d/50list-installed
+++ /dev/null
@@ -1,10 +0,0 @@
-#!/bin/sh
-# Output to stdout a *sorted* list of all currently installed 
-# (or removed but still with config-files) packages, in the
-# format "package version\n" (or something similar).
-if [ "$LOWLEVEL_PACKAGE_MANAGER" = dpkg ]; then
-	dpkg-query -W -f '${Status}\t${Package} ${Version}\n' | \
-		egrep '(ok installed|ok config-files)' | cut -f2,3
-elif [ "$LOWLEVEL_PACKAGE_MANAGER" = rpm ]; then
-	rpm -qa --queryformat "%{name} %{version} %{arch}\n" | sort
-fi
diff --git a/list-installed.d/50list-installed.in b/list-installed.d/50list-installed.in
new file mode 100644
index 0000000..dcee3a1
--- /dev/null
+++ b/list-installed.d/50list-installed.in
@@ -0,0 +1,10 @@
+#!@SHELLPATH@
+# Output to stdout a *sorted* list of all currently installed 
+# (or removed but still with config-files) packages, in the
+# format "package version\n" (or something similar).
+if [ "$LOWLEVEL_PACKAGE_MANAGER" = dpkg ]; then
+	dpkg-query -W -f '${Status}\t${Package} ${Version}\n' | \
+		egrep '(ok installed|ok config-files)' | cut -f2,3
+elif [ "$LOWLEVEL_PACKAGE_MANAGER" = rpm ]; then
+	rpm -qa --queryformat "%{name} %{version} %{arch}\n" | sort
+fi
diff --git a/missing b/missing
new file mode 100755
index 0000000..1c8ff70
--- /dev/null
+++ b/missing
@@ -0,0 +1,367 @@
+#! /bin/sh
+# Common stub for a few missing GNU programs while installing.
+
+scriptversion=2006-05-10.23
+
+# Copyright (C) 1996, 1997, 1999, 2000, 2002, 2003, 2004, 2005, 2006
+#   Free Software Foundation, Inc.
+# Originally by Fran,cois Pinard <pinard@iro.umontreal.ca>, 1996.
+
+# This program is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 2, or (at your option)
+# any later version.
+
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+
+# You should have received a copy of the GNU General Public License
+# along with this program; if not, write to the Free Software
+# Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA
+# 02110-1301, USA.
+
+# As a special exception to the GNU General Public License, if you
+# distribute this file as part of a program that contains a
+# configuration script generated by Autoconf, you may include it under
+# the same distribution terms that you use for the rest of that program.
+
+if test $# -eq 0; then
+  echo 1>&2 "Try \`$0 --help' for more information"
+  exit 1
+fi
+
+run=:
+sed_output='s/.* --output[ =]\([^ ]*\).*/\1/p'
+sed_minuso='s/.* -o \([^ ]*\).*/\1/p'
+
+# In the cases where this matters, `missing' is being run in the
+# srcdir already.
+if test -f configure.ac; then
+  configure_ac=configure.ac
+else
+  configure_ac=configure.in
+fi
+
+msg="missing on your system"
+
+case $1 in
+--run)
+  # Try to run requested program, and just exit if it succeeds.
+  run=
+  shift
+  "$@" && exit 0
+  # Exit code 63 means version mismatch.  This often happens
+  # when the user try to use an ancient version of a tool on
+  # a file that requires a minimum version.  In this case we
+  # we should proceed has if the program had been absent, or
+  # if --run hadn't been passed.
+  if test $? = 63; then
+    run=:
+    msg="probably too old"
+  fi
+  ;;
+
+  -h|--h|--he|--hel|--help)
+    echo "\
+$0 [OPTION]... PROGRAM [ARGUMENT]...
+
+Handle \`PROGRAM [ARGUMENT]...' for when PROGRAM is missing, or return an
+error status if there is no known handling for PROGRAM.
+
+Options:
+  -h, --help      display this help and exit
+  -v, --version   output version information and exit
+  --run           try to run the given command, and emulate it if it fails
+
+Supported PROGRAM values:
+  aclocal      touch file \`aclocal.m4'
+  autoconf     touch file \`configure'
+  autoheader   touch file \`config.h.in'
+  autom4te     touch the output file, or create a stub one
+  automake     touch all \`Makefile.in' files
+  bison        create \`y.tab.[ch]', if possible, from existing .[ch]
+  flex         create \`lex.yy.c', if possible, from existing .c
+  help2man     touch the output file
+  lex          create \`lex.yy.c', if possible, from existing .c
+  makeinfo     touch the output file
+  tar          try tar, gnutar, gtar, then tar without non-portable flags
+  yacc         create \`y.tab.[ch]', if possible, from existing .[ch]
+
+Send bug reports to <bug-automake@gnu.org>."
+    exit $?
+    ;;
+
+  -v|--v|--ve|--ver|--vers|--versi|--versio|--version)
+    echo "missing $scriptversion (GNU Automake)"
+    exit $?
+    ;;
+
+  -*)
+    echo 1>&2 "$0: Unknown \`$1' option"
+    echo 1>&2 "Try \`$0 --help' for more information"
+    exit 1
+    ;;
+
+esac
+
+# Now exit if we have it, but it failed.  Also exit now if we
+# don't have it and --version was passed (most likely to detect
+# the program).
+case $1 in
+  lex|yacc)
+    # Not GNU programs, they don't have --version.
+    ;;
+
+  tar)
+    if test -n "$run"; then
+       echo 1>&2 "ERROR: \`tar' requires --run"
+       exit 1
+    elif test "x$2" = "x--version" || test "x$2" = "x--help"; then
+       exit 1
+    fi
+    ;;
+
+  *)
+    if test -z "$run" && ($1 --version) > /dev/null 2>&1; then
+       # We have it, but it failed.
+       exit 1
+    elif test "x$2" = "x--version" || test "x$2" = "x--help"; then
+       # Could not run --version or --help.  This is probably someone
+       # running `$TOOL --version' or `$TOOL --help' to check whether
+       # $TOOL exists and not knowing $TOOL uses missing.
+       exit 1
+    fi
+    ;;
+esac
+
+# If it does not exist, or fails to run (possibly an outdated version),
+# try to emulate it.
+case $1 in
+  aclocal*)
+    echo 1>&2 "\
+WARNING: \`$1' is $msg.  You should only need it if
+         you modified \`acinclude.m4' or \`${configure_ac}'.  You might want
+         to install the \`Automake' and \`Perl' packages.  Grab them from
+         any GNU archive site."
+    touch aclocal.m4
+    ;;
+
+  autoconf)
+    echo 1>&2 "\
+WARNING: \`$1' is $msg.  You should only need it if
+         you modified \`${configure_ac}'.  You might want to install the
+         \`Autoconf' and \`GNU m4' packages.  Grab them from any GNU
+         archive site."
+    touch configure
+    ;;
+
+  autoheader)
+    echo 1>&2 "\
+WARNING: \`$1' is $msg.  You should only need it if
+         you modified \`acconfig.h' or \`${configure_ac}'.  You might want
+         to install the \`Autoconf' and \`GNU m4' packages.  Grab them
+         from any GNU archive site."
+    files=`sed -n 's/^[ ]*A[CM]_CONFIG_HEADER(\([^)]*\)).*/\1/p' ${configure_ac}`
+    test -z "$files" && files="config.h"
+    touch_files=
+    for f in $files; do
+      case $f in
+      *:*) touch_files="$touch_files "`echo "$f" |
+				       sed -e 's/^[^:]*://' -e 's/:.*//'`;;
+      *) touch_files="$touch_files $f.in";;
+      esac
+    done
+    touch $touch_files
+    ;;
+
+  automake*)
+    echo 1>&2 "\
+WARNING: \`$1' is $msg.  You should only need it if
+         you modified \`Makefile.am', \`acinclude.m4' or \`${configure_ac}'.
+         You might want to install the \`Automake' and \`Perl' packages.
+         Grab them from any GNU archive site."
+    find . -type f -name Makefile.am -print |
+	   sed 's/\.am$/.in/' |
+	   while read f; do touch "$f"; done
+    ;;
+
+  autom4te)
+    echo 1>&2 "\
+WARNING: \`$1' is needed, but is $msg.
+         You might have modified some files without having the
+         proper tools for further handling them.
+         You can get \`$1' as part of \`Autoconf' from any GNU
+         archive site."
+
+    file=`echo "$*" | sed -n "$sed_output"`
+    test -z "$file" && file=`echo "$*" | sed -n "$sed_minuso"`
+    if test -f "$file"; then
+	touch $file
+    else
+	test -z "$file" || exec >$file
+	echo "#! /bin/sh"
+	echo "# Created by GNU Automake missing as a replacement of"
+	echo "#  $ $@"
+	echo "exit 0"
+	chmod +x $file
+	exit 1
+    fi
+    ;;
+
+  bison|yacc)
+    echo 1>&2 "\
+WARNING: \`$1' $msg.  You should only need it if
+         you modified a \`.y' file.  You may need the \`Bison' package
+         in order for those modifications to take effect.  You can get
+         \`Bison' from any GNU archive site."
+    rm -f y.tab.c y.tab.h
+    if test $# -ne 1; then
+        eval LASTARG="\${$#}"
+	case $LASTARG in
+	*.y)
+	    SRCFILE=`echo "$LASTARG" | sed 's/y$/c/'`
+	    if test -f "$SRCFILE"; then
+	         cp "$SRCFILE" y.tab.c
+	    fi
+	    SRCFILE=`echo "$LASTARG" | sed 's/y$/h/'`
+	    if test -f "$SRCFILE"; then
+	         cp "$SRCFILE" y.tab.h
+	    fi
+	  ;;
+	esac
+    fi
+    if test ! -f y.tab.h; then
+	echo >y.tab.h
+    fi
+    if test ! -f y.tab.c; then
+	echo 'main() { return 0; }' >y.tab.c
+    fi
+    ;;
+
+  lex|flex)
+    echo 1>&2 "\
+WARNING: \`$1' is $msg.  You should only need it if
+         you modified a \`.l' file.  You may need the \`Flex' package
+         in order for those modifications to take effect.  You can get
+         \`Flex' from any GNU archive site."
+    rm -f lex.yy.c
+    if test $# -ne 1; then
+        eval LASTARG="\${$#}"
+	case $LASTARG in
+	*.l)
+	    SRCFILE=`echo "$LASTARG" | sed 's/l$/c/'`
+	    if test -f "$SRCFILE"; then
+	         cp "$SRCFILE" lex.yy.c
+	    fi
+	  ;;
+	esac
+    fi
+    if test ! -f lex.yy.c; then
+	echo 'main() { return 0; }' >lex.yy.c
+    fi
+    ;;
+
+  help2man)
+    echo 1>&2 "\
+WARNING: \`$1' is $msg.  You should only need it if
+	 you modified a dependency of a manual page.  You may need the
+	 \`Help2man' package in order for those modifications to take
+	 effect.  You can get \`Help2man' from any GNU archive site."
+
+    file=`echo "$*" | sed -n "$sed_output"`
+    test -z "$file" && file=`echo "$*" | sed -n "$sed_minuso"`
+    if test -f "$file"; then
+	touch $file
+    else
+	test -z "$file" || exec >$file
+	echo ".ab help2man is required to generate this page"
+	exit 1
+    fi
+    ;;
+
+  makeinfo)
+    echo 1>&2 "\
+WARNING: \`$1' is $msg.  You should only need it if
+         you modified a \`.texi' or \`.texinfo' file, or any other file
+         indirectly affecting the aspect of the manual.  The spurious
+         call might also be the consequence of using a buggy \`make' (AIX,
+         DU, IRIX).  You might want to install the \`Texinfo' package or
+         the \`GNU make' package.  Grab either from any GNU archive site."
+    # The file to touch is that specified with -o ...
+    file=`echo "$*" | sed -n "$sed_output"`
+    test -z "$file" && file=`echo "$*" | sed -n "$sed_minuso"`
+    if test -z "$file"; then
+      # ... or it is the one specified with @setfilename ...
+      infile=`echo "$*" | sed 's/.* \([^ ]*\) *$/\1/'`
+      file=`sed -n '
+	/^@setfilename/{
+	  s/.* \([^ ]*\) *$/\1/
+	  p
+	  q
+	}' $infile`
+      # ... or it is derived from the source name (dir/f.texi becomes f.info)
+      test -z "$file" && file=`echo "$infile" | sed 's,.*/,,;s,.[^.]*$,,'`.info
+    fi
+    # If the file does not exist, the user really needs makeinfo;
+    # let's fail without touching anything.
+    test -f $file || exit 1
+    touch $file
+    ;;
+
+  tar)
+    shift
+
+    # We have already tried tar in the generic part.
+    # Look for gnutar/gtar before invocation to avoid ugly error
+    # messages.
+    if (gnutar --version > /dev/null 2>&1); then
+       gnutar "$@" && exit 0
+    fi
+    if (gtar --version > /dev/null 2>&1); then
+       gtar "$@" && exit 0
+    fi
+    firstarg="$1"
+    if shift; then
+	case $firstarg in
+	*o*)
+	    firstarg=`echo "$firstarg" | sed s/o//`
+	    tar "$firstarg" "$@" && exit 0
+	    ;;
+	esac
+	case $firstarg in
+	*h*)
+	    firstarg=`echo "$firstarg" | sed s/h//`
+	    tar "$firstarg" "$@" && exit 0
+	    ;;
+	esac
+    fi
+
+    echo 1>&2 "\
+WARNING: I can't seem to be able to run \`tar' with the given arguments.
+         You may want to install GNU tar or Free paxutils, or check the
+         command line arguments."
+    exit 1
+    ;;
+
+  *)
+    echo 1>&2 "\
+WARNING: \`$1' is needed, and is $msg.
+         You might have modified some files without having the
+         proper tools for further handling them.  Check the \`README' file,
+         it often tells you about the needed prerequisites for installing
+         this package.  You may also peek at any GNU archive site, in case
+         some other package would contain this missing \`$1' program."
+    exit 1
+    ;;
+esac
+
+exit 0
+
+# Local variables:
+# eval: (add-hook 'write-file-hooks 'time-stamp)
+# time-stamp-start: "scriptversion="
+# time-stamp-format: "%:y-%02m-%02d.%02H"
+# time-stamp-end: "$"
+# End:
diff --git a/post-install.d/50vcs-commit b/post-install.d/50vcs-commit
deleted file mode 100755
index 12fd187..0000000
--- a/post-install.d/50vcs-commit
+++ /dev/null
@@ -1,20 +0,0 @@
-#!/bin/sh
-set -e
-		
-pl="/var/cache/etckeeper/packagelist"
-NL="
-"
-
-if etckeeper unclean; then
-	message="committing changes in /etc after $HIGHLEVEL_PACKAGE_MANAGER run"
-
-	if [ -e $pl.pre-install ]; then
-		diff="$(etckeeper list-installed | diff -U0 $pl.pre-install - | tail -n+4 | egrep '^[-+]')" || true
-		if [ -n "$diff" ]; then
-			message="$message$NL${NL}Package changes:$NL$diff"
-		fi
-		rm -f $pl.pre-install
-	fi
-
-	etckeeper commit "$(printf "$message")"
-fi
diff --git a/post-install.d/50vcs-commit.in b/post-install.d/50vcs-commit.in
new file mode 100644
index 0000000..d0cf86d
--- /dev/null
+++ b/post-install.d/50vcs-commit.in
@@ -0,0 +1,20 @@
+#!@SHELLPATH@
+set -e
+		
+pl="/var/cache/etckeeper/packagelist"
+NL="
+"
+
+if etckeeper unclean; then
+	message="committing changes in /etc after $HIGHLEVEL_PACKAGE_MANAGER run"
+
+	if [ -e $pl.pre-install ]; then
+		diff="$(etckeeper list-installed | diff -U0 $pl.pre-install - | tail -n+4 | egrep '^[-+]')" || true
+		if [ -n "$diff" ]; then
+			message="$message$NL${NL}Package changes:$NL$diff"
+		fi
+		rm -f $pl.pre-install
+	fi
+
+	etckeeper commit "$(printf "$message")"
+fi
diff --git a/pre-commit.d/20warn-hardlinks b/pre-commit.d/20warn-hardlinks
deleted file mode 100755
index 008e2f1..0000000
--- a/pre-commit.d/20warn-hardlinks
+++ /dev/null
@@ -1,10 +0,0 @@
-#!/bin/sh
-set -e
-
-if [ "$VCS" = git ] || [ "$VCS" = hg ] || [ "$VCS" = bzr ] || [ "$VCS" = darcs ]; then
-	hardlinks=$(find -type f -not -links 1 | grep -v '/\(.git\|.hg\|.bzr\|_darcs\)/' ) || true
-	if [ -n "$hardlinks" ]; then
-		echo "etckeeper warning: hardlinked files could cause problems with $VCS:" >&2
-		echo "$hardlinks" >&2
-	fi
-fi
diff --git a/pre-commit.d/20warn-hardlinks.in b/pre-commit.d/20warn-hardlinks.in
new file mode 100644
index 0000000..479b0e5
--- /dev/null
+++ b/pre-commit.d/20warn-hardlinks.in
@@ -0,0 +1,10 @@
+#!@SHELLPATH@
+set -e
+
+if [ "$VCS" = git ] || [ "$VCS" = hg ] || [ "$VCS" = bzr ] || [ "$VCS" = darcs ]; then
+	hardlinks=$(find -type f -not -links 1 | grep -v '/\(.git\|.hg\|.bzr\|_darcs\)/' ) || true
+	if [ -n "$hardlinks" ]; then
+		echo "etckeeper warning: hardlinked files could cause problems with $VCS:" >&2
+		echo "$hardlinks" >&2
+	fi
+fi
diff --git a/pre-commit.d/20warn-special-file b/pre-commit.d/20warn-special-file
deleted file mode 100755
index 665a3ce..0000000
--- a/pre-commit.d/20warn-special-file
+++ /dev/null
@@ -1,12 +0,0 @@
-#!/bin/sh
-set -e
-
-if [ "$VCS" = git ] || [ "$VCS" = hg ] || [ "$VCS" = bzr ] || [ "$VCS" = darcs ]; then
-	special=$(find -not -type d -not -type f -not -type l | grep -v '/\(.git\|.hg\|.bzr\|_darcs\)/') || true
-	if [ -n "$special" ]; then
-		echo "etckeeper warning: special files could cause problems with $VCS:" >&2
-		echo "$special" >&2
-	fi
-fi
-
-true
diff --git a/pre-commit.d/20warn-special-file.in b/pre-commit.d/20warn-special-file.in
new file mode 100644
index 0000000..4921abe
--- /dev/null
+++ b/pre-commit.d/20warn-special-file.in
@@ -0,0 +1,12 @@
+#!@SHELLPATH@
+set -e
+
+if [ "$VCS" = git ] || [ "$VCS" = hg ] || [ "$VCS" = bzr ] || [ "$VCS" = darcs ]; then
+	special=$(find -not -type d -not -type f -not -type l | grep -v '/\(.git\|.hg\|.bzr\|_darcs\)/') || true
+	if [ -n "$special" ]; then
+		echo "etckeeper warning: special files could cause problems with $VCS:" >&2
+		echo "$special" >&2
+	fi
+fi
+
+true
diff --git a/pre-commit.d/30store-metadata b/pre-commit.d/30store-metadata
deleted file mode 100755
index f4125f6..0000000
--- a/pre-commit.d/30store-metadata
+++ /dev/null
@@ -1,130 +0,0 @@
-#!/bin/sh
-set -e
-
-# Filters out UNKNOWN users and groups, prints a warning on stderr.
-filter_unknown() {
-	CMD=$1
-	while read line; do
-		# if the first n chars of $line equal "$CMD UNKNOWN "...
-		if [ "$(printf %.$((9+${#CMD}))s "$line")" = "$CMD UNKNOWN " ]; then
-			echo Bad "$2" for "$line" >&2
-		else
-			echo "$line"
-		fi
-	done
-}
-
-filter_ignore() {
-	if [ "$VCS" = darcs ]; then
-		ignorefile=.darcsignore
-	fi
-
-	if [ "$VCS" = darcs ] && [ -e "$ignorefile" ]; then
-		# Spaces embedded into patterns would break it.
-		# But really, why would anyone want to use ' ' instead of '\s' ?
-		#patterns=$( grep -v '^[[:space:]]*\(#\|$\)' "$ignorefile" | xargs -n 1 printf " -e %s" )
-		#grep -Ev $patterns
-		#unset patterns
-		# Alternative using a temp file
-		patternsfile="$( mktemp -t etckeeper-$VCS.XXXXXXXXXX )"
-		grep -v '^[[:space:]]*\(#\|$\)' "$ignorefile" > "$patternsfile" || true
-		grep -Evf "$patternsfile"
-		rm -f "$patternsfile"
-		unset patternsfile
-	else
-		cat -
-	fi
-}
-
-generate_metadata() {
-	# This function generates the script commands to fix any files
-	# that aren't owner=root, group=root, or mode=0644 or 0755.
-	# The script is produced on stdout.  Errors go to stderr.
-	# 
-	# The script can use a 'maybe' function, which only runs a command
-	# if the file in its last argument exists.
-
-	# We maintain the permissions on the directory containing VCS data
-	# but we want find to ignore the VCS files themselves.
-	# 
-	# (Note that when using this, the find expression must end with 
-	# -print or -exec, else the excluded directories will actually be
-	# printed!)
-	NOVCS='. -wholename ./.git -prune -o -wholename ./.bzr -prune -o -wholename ./.hg -prune -o -wholename ./_darcs -prune -o'
-
-	# Keep the sort order the same at all times.
-	LC_COLLATE=C
-	export LC_COLLATE
-
-	if [ "$VCS" = git ] || [ "$VCS" = hg ]; then
-		# These version control systems do not track directories,
-		# so empty directories must be stored specially.
-		find $NOVCS -type d -empty -print |
-			sort | sed -e "s/^/mkdir -p '/" -e "s/\$/'/"
-	fi
-
-	if [ "$VCS" = darcs ]; then
-		# This version control system does not track symlinks,
-		# so they must be stored specially.
-		find $NOVCS -type l -print | sort | filter_ignore | while read link; do
-			dest=$( readlink "$link" )
-			printf "ln -sf '%s' '%s'\n" "$dest" "$link"
-		done
-	fi
-
-	# Find all files and directories that don't have the current user as the owner
-	find $NOVCS \! -user "$(id -u)" -exec stat --format="maybe chown %U '{}'" {} \; \
-		| sort | filter_unknown 'maybe chown' owner
-	# Find all files and directories that don't have root as the group
-	find $NOVCS \! -group $(id -g) -exec stat --format="maybe chgrp %G '{}'" {} \; \
-		| sort | filter_unknown 'maybe chgrp' group
-
-	# Find all directories that aren't 0755
-	find $NOVCS -type d \! -perm 0755 \
-		-exec stat --format="maybe chmod %a '{}'" {} \; | sort
-
-	if [ "$VCS" = darcs ]; then
-		# Find all files that aren't 0644 (darcs doesn't maintain
-		# the executable bit).
-		find $NOVCS -type f \! -perm 0644 \
-			-exec stat --format="maybe chmod %a '{}'" {} \; | sort
-	else
-		# Find all files that aren't 0644 or 0755 (we can assume the VCS will
-		# maintain the executable bit).
-		find $NOVCS -type f \! -perm 0644 \! -perm 0755 \
-			-exec stat --format="maybe chmod %a '{}'" {} \; | sort
-	fi
-
-	# We don't handle xattrs.
-	# Maybe check for getfattr/setfattr and use them if they're available?
-}
-
-if [ "$VCS" = git ] || [ "$VCS" = hg ] || [ "$VCS" = bzr ] || [ "$VCS" = darcs ]; then
-	if [ -f .metadata ]; then
-		# remove obsolete .metadata file
-		# git allows fully deleting it at this point, other VCS
-		# may not (the repo is locked for hg).
-		if [ "$VCS" = git ]; then
-			$VCS rm .metadata
-		else
-			rm -f .metadata
-		fi
-	fi
-
-	echo "# Generated by etckeeper.  Do not edit." > .etckeeper
-	echo >> .etckeeper
-
-	# Make sure the file is not readable by others, since it can leak
-	# information about contents of non-readable directories in /etc.
-	chmod 700 .etckeeper
-
-	generate_metadata >> .etckeeper
-
-	# stage the file as part of the current commit
-	if [ "$VCS" = git ]; then
-		# this will do nothing if the metadata file is unchanged.
-		git add .etckeeper
-	fi
-	# hg, bzr and darcs add not done, they will automatically
-	# include the file in the current commit
-fi
diff --git a/pre-commit.d/30store-metadata.in b/pre-commit.d/30store-metadata.in
new file mode 100644
index 0000000..9fb2162
--- /dev/null
+++ b/pre-commit.d/30store-metadata.in
@@ -0,0 +1,130 @@
+#!@SHELLPATH@
+set -e
+
+# Filters out UNKNOWN users and groups, prints a warning on stderr.
+filter_unknown() {
+	CMD=$1
+	while read line; do
+		# if the first n chars of $line equal "$CMD UNKNOWN "...
+		if [ "$(printf %.$((9+${#CMD}))s "$line")" = "$CMD UNKNOWN " ]; then
+			echo Bad "$2" for "$line" >&2
+		else
+			echo "$line"
+		fi
+	done
+}
+
+filter_ignore() {
+	if [ "$VCS" = darcs ]; then
+		ignorefile=.darcsignore
+	fi
+
+	if [ "$VCS" = darcs ] && [ -e "$ignorefile" ]; then
+		# Spaces embedded into patterns would break it.
+		# But really, why would anyone want to use ' ' instead of '\s' ?
+		#patterns=$( grep -v '^[[:space:]]*\(#\|$\)' "$ignorefile" | xargs -n 1 printf " -e %s" )
+		#grep -Ev $patterns
+		#unset patterns
+		# Alternative using a temp file
+		patternsfile="$( mktemp -t etckeeper-$VCS.XXXXXXXXXX )"
+		grep -v '^[[:space:]]*\(#\|$\)' "$ignorefile" > "$patternsfile" || true
+		grep -Evf "$patternsfile"
+		rm -f "$patternsfile"
+		unset patternsfile
+	else
+		cat -
+	fi
+}
+
+generate_metadata() {
+	# This function generates the script commands to fix any files
+	# that aren't owner=root, group=root, or mode=0644 or 0755.
+	# The script is produced on stdout.  Errors go to stderr.
+	# 
+	# The script can use a 'maybe' function, which only runs a command
+	# if the file in its last argument exists.
+
+	# We maintain the permissions on the directory containing VCS data
+	# but we want find to ignore the VCS files themselves.
+	# 
+	# (Note that when using this, the find expression must end with 
+	# -print or -exec, else the excluded directories will actually be
+	# printed!)
+	NOVCS='. -wholename ./.git -prune -o -wholename ./.bzr -prune -o -wholename ./.hg -prune -o -wholename ./_darcs -prune -o'
+
+	# Keep the sort order the same at all times.
+	LC_COLLATE=C
+	export LC_COLLATE
+
+	if [ "$VCS" = git ] || [ "$VCS" = hg ]; then
+		# These version control systems do not track directories,
+		# so empty directories must be stored specially.
+		find $NOVCS -type d -empty -print |
+			sort | sed -e "s/^/mkdir -p '/" -e "s/\$/'/"
+	fi
+
+	if [ "$VCS" = darcs ]; then
+		# This version control system does not track symlinks,
+		# so they must be stored specially.
+		find $NOVCS -type l -print | sort | filter_ignore | while read link; do
+			dest=$( readlink "$link" )
+			printf "ln -sf '%s' '%s'\n" "$dest" "$link"
+		done
+	fi
+
+	# Find all files and directories that don't have the current user as the owner
+	find $NOVCS \! -user "$(id -u)" -exec stat --format="maybe chown %U '{}'" {} \; \
+		| sort | filter_unknown 'maybe chown' owner
+	# Find all files and directories that don't have root as the group
+	find $NOVCS \! -group $(id -g) -exec stat --format="maybe chgrp %G '{}'" {} \; \
+		| sort | filter_unknown 'maybe chgrp' group
+
+	# Find all directories that aren't 0755
+	find $NOVCS -type d \! -perm 0755 \
+		-exec stat --format="maybe chmod %a '{}'" {} \; | sort
+
+	if [ "$VCS" = darcs ]; then
+		# Find all files that aren't 0644 (darcs doesn't maintain
+		# the executable bit).
+		find $NOVCS -type f \! -perm 0644 \
+			-exec stat --format="maybe chmod %a '{}'" {} \; | sort
+	else
+		# Find all files that aren't 0644 or 0755 (we can assume the VCS will
+		# maintain the executable bit).
+		find $NOVCS -type f \! -perm 0644 \! -perm 0755 \
+			-exec stat --format="maybe chmod %a '{}'" {} \; | sort
+	fi
+
+	# We don't handle xattrs.
+	# Maybe check for getfattr/setfattr and use them if they're available?
+}
+
+if [ "$VCS" = git ] || [ "$VCS" = hg ] || [ "$VCS" = bzr ] || [ "$VCS" = darcs ]; then
+	if [ -f .metadata ]; then
+		# remove obsolete .metadata file
+		# git allows fully deleting it at this point, other VCS
+		# may not (the repo is locked for hg).
+		if [ "$VCS" = git ]; then
+			$VCS rm .metadata
+		else
+			rm -f .metadata
+		fi
+	fi
+
+	echo "# Generated by etckeeper.  Do not edit." > .etckeeper
+	echo >> .etckeeper
+
+	# Make sure the file is not readable by others, since it can leak
+	# information about contents of non-readable directories in /etc.
+	chmod 700 .etckeeper
+
+	generate_metadata >> .etckeeper
+
+	# stage the file as part of the current commit
+	if [ "$VCS" = git ]; then
+		# this will do nothing if the metadata file is unchanged.
+		git add .etckeeper
+	fi
+	# hg, bzr and darcs add not done, they will automatically
+	# include the file in the current commit
+fi
diff --git a/pre-install.d/10packagelist b/pre-install.d/10packagelist
deleted file mode 100755
index f83acee..0000000
--- a/pre-install.d/10packagelist
+++ /dev/null
@@ -1,3 +0,0 @@
-#!/bin/sh
-# This list will be later used when committing.
-etckeeper list-installed > /var/cache/etckeeper/packagelist.pre-install
diff --git a/pre-install.d/10packagelist.in b/pre-install.d/10packagelist.in
new file mode 100644
index 0000000..4d0f79d
--- /dev/null
+++ b/pre-install.d/10packagelist.in
@@ -0,0 +1,3 @@
+#!@SHELLPATH@
+# This list will be later used when committing.
+etckeeper list-installed > /var/cache/etckeeper/packagelist.pre-install
diff --git a/pre-install.d/50uncommitted-changes b/pre-install.d/50uncommitted-changes
deleted file mode 100755
index 47750ac..0000000
--- a/pre-install.d/50uncommitted-changes
+++ /dev/null
@@ -1,28 +0,0 @@
-#!/bin/sh
-set -e
-
-if [ "$1" = "fail-debconf" ]; then
-	. /usr/share/debconf/confmodule
-	db_subst etckeeper/commit_failed VCS "$VCS"
-	db_input critical etckeeper/commit_failed || true
-	db_go || true
-	db_reset etckeeper/commit_failed || true
-fi
-
-if etckeeper unclean; then
-	if [ "$AVOID_COMMIT_BEFORE_INSTALL" = 1 ]; then
-		echo "" >&2
-		echo "** etckeeper detected uncommitted changes in /etc prior to $HIGHLEVEL_PACKAGE_MANAGER run" >&2 
-		echo "** Aborting $HIGHLEVEL_PACKAGE_MANAGER run. Manually commit and restart." >&2
-		echo "" >&2
-		exit 1
-	fi
-	if ! etckeeper commit "saving uncommitted changes in /etc prior to $HIGHLEVEL_PACKAGE_MANAGER run"; then
-		if [ -e /usr/share/debconf/confmodule ]; then
-			$0 fail-debconf
-		else
-			echo "error: etckeeper failed to commit changes in /etc using $VCS"
-			exit 1
-		fi
-	fi
-fi
diff --git a/pre-install.d/50uncommitted-changes.in b/pre-install.d/50uncommitted-changes.in
new file mode 100644
index 0000000..bf01ac0
--- /dev/null
+++ b/pre-install.d/50uncommitted-changes.in
@@ -0,0 +1,28 @@
+#!@SHELLPATH@
+set -e
+
+if [ "$1" = "fail-debconf" ]; then
+	. /usr/share/debconf/confmodule
+	db_subst etckeeper/commit_failed VCS "$VCS"
+	db_input critical etckeeper/commit_failed || true
+	db_go || true
+	db_reset etckeeper/commit_failed || true
+fi
+
+if etckeeper unclean; then
+	if [ "$AVOID_COMMIT_BEFORE_INSTALL" = 1 ]; then
+		echo "" >&2
+		echo "** etckeeper detected uncommitted changes in /etc prior to $HIGHLEVEL_PACKAGE_MANAGER run" >&2 
+		echo "** Aborting $HIGHLEVEL_PACKAGE_MANAGER run. Manually commit and restart." >&2
+		echo "" >&2
+		exit 1
+	fi
+	if ! etckeeper commit "saving uncommitted changes in /etc prior to $HIGHLEVEL_PACKAGE_MANAGER run"; then
+		if [ -e /usr/share/debconf/confmodule ]; then
+			$0 fail-debconf
+		else
+			echo "error: etckeeper failed to commit changes in /etc using $VCS"
+			exit 1
+		fi
+	fi
+fi
diff --git a/unclean.d/50test b/unclean.d/50test
deleted file mode 100755
index 84e6be7..0000000
--- a/unclean.d/50test
+++ /dev/null
@@ -1,12 +0,0 @@
-#!/bin/sh
-set -e
-
-if [ "$VCS" = git ]; then
-	[ -d .git ] && [ -n "`git ls-files --modified --deleted --others --exclude-standard`" ]
-elif [ "$VCS" = hg ]; then
-	[ -d .hg ] && ! hg status 2>&1 | wc -l | grep -q "^0$"
-elif [ "$VCS" = bzr ]; then
-	[ -d .bzr ] && ! bzr status 2>/dev/null | wc -l | grep -q "^0$"
-elif [ "$VCS" = darcs ]; then
-	[ -d _darcs ] && darcs whatsnew -l >/dev/null
-fi
diff --git a/unclean.d/50test.in b/unclean.d/50test.in
new file mode 100644
index 0000000..41dda67
--- /dev/null
+++ b/unclean.d/50test.in
@@ -0,0 +1,12 @@
+#!@SHELLPATH@
+set -e
+
+if [ "$VCS" = git ]; then
+	[ -d .git ] && [ -n "`git ls-files --modified --deleted --others --exclude-standard`" ]
+elif [ "$VCS" = hg ]; then
+	[ -d .hg ] && ! hg status 2>&1 | wc -l | grep -q "^0$"
+elif [ "$VCS" = bzr ]; then
+	[ -d .bzr ] && ! bzr status 2>/dev/null | wc -l | grep -q "^0$"
+elif [ "$VCS" = darcs ]; then
+	[ -d _darcs ] && darcs whatsnew -l >/dev/null
+fi
diff --git a/uninit.d/01prompt b/uninit.d/01prompt
deleted file mode 100755
index 07f2e41..0000000
--- a/uninit.d/01prompt
+++ /dev/null
@@ -1,20 +0,0 @@
-#!/bin/sh
-set -e
-
-if [ "$1" != "-f" ]; then
-	echo "** Warning: This will DESTROY all recorded history for $ETCKEEPER_DIR,"
-	echo "** including the $VCS repository and ignore file."
-	echo ""
-	printf "Are you sure you want to do this? [yN] "
-	read answer
-	case "$answer" in 
-		[Yy]*)
-			echo "Proceeding.."
-			exit 0
-		;;
-		*)
-			echo "Aborting etckeeper uninit."
-			exit 1
-		;;
-	esac
-fi
diff --git a/uninit.d/01prompt.in b/uninit.d/01prompt.in
new file mode 100644
index 0000000..6b64a39
--- /dev/null
+++ b/uninit.d/01prompt.in
@@ -0,0 +1,20 @@
+#!@SHELLPATH@
+set -e
+
+if [ "$1" != "-f" ]; then
+	echo "** Warning: This will DESTROY all recorded history for $ETCKEEPER_DIR,"
+	echo "** including the $VCS repository and ignore file."
+	echo ""
+	printf "Are you sure you want to do this? [yN] "
+	read answer
+	case "$answer" in 
+		[Yy]*)
+			echo "Proceeding.."
+			exit 0
+		;;
+		*)
+			echo "Aborting etckeeper uninit."
+			exit 1
+		;;
+	esac
+fi
diff --git a/uninit.d/50remove-metadata b/uninit.d/50remove-metadata
deleted file mode 100755
index 0be8d36..0000000
--- a/uninit.d/50remove-metadata
+++ /dev/null
@@ -1,6 +0,0 @@
-#!/bin/sh
-set -e
-
-# Files generated by etckeeper to store metadata the VCS cannot preserve.
-rm -f .etckeeper
-rm -f .metadata # only generated by old versions
diff --git a/uninit.d/50remove-metadata.in b/uninit.d/50remove-metadata.in
new file mode 100644
index 0000000..29332a1
--- /dev/null
+++ b/uninit.d/50remove-metadata.in
@@ -0,0 +1,6 @@
+#!@SHELLPATH@
+set -e
+
+# Files generated by etckeeper to store metadata the VCS cannot preserve.
+rm -f .etckeeper
+rm -f .metadata # only generated by old versions
diff --git a/uninit.d/50vcs-uninit b/uninit.d/50vcs-uninit
deleted file mode 100755
index c9896ed..0000000
--- a/uninit.d/50vcs-uninit
+++ /dev/null
@@ -1,12 +0,0 @@
-#!/bin/sh
-set -e
-
-if [ "$VCS" = git ]; then
-	rm -rf .git .gitignore
-elif [ "$VCS" = hg ]; then
-	rm -rf .hg .hgignore
-elif [ "$VCS" = bzr ]; then
-	rm -rf .bzr .bzrignore
-elif [ "$VCS" = darcs ]; then
-	rm -rf _darcs .darcsignore
-fi
diff --git a/uninit.d/50vcs-uninit.in b/uninit.d/50vcs-uninit.in
new file mode 100644
index 0000000..df23a2b
--- /dev/null
+++ b/uninit.d/50vcs-uninit.in
@@ -0,0 +1,12 @@
+#!@SHELLPATH@
+set -e
+
+if [ "$VCS" = git ]; then
+	rm -rf .git .gitignore
+elif [ "$VCS" = hg ]; then
+	rm -rf .hg .hgignore
+elif [ "$VCS" = bzr ]; then
+	rm -rf .bzr .bzrignore
+elif [ "$VCS" = darcs ]; then
+	rm -rf _darcs .darcsignore
+fi
diff --git a/update-ignore.d/01update-ignore b/update-ignore.d/01update-ignore
deleted file mode 100755
index 510e13f..0000000
--- a/update-ignore.d/01update-ignore
+++ /dev/null
@@ -1,160 +0,0 @@
-#!/bin/sh
-set -e
-
-if [ "$VCS" = git ]; then
-	dir=.git
-	file=.gitignore
-elif [ "$VCS" = hg ]; then
-	dir=.hg
-	file=.hgignore
-elif [ "$VCS" = bzr ]; then
-	dir=.bzr
-	file=.bzrignore
-elif [ "$VCS" = darcs ]; then
-	dir=_darcs
-	file=.darcsignore
-else
-	echo "etckeeper: unsupported VCS $VCS" >&2
-	exit 1
-fi
-
-if [ ! -d "$dir" ]; then
-	exit 0
-fi
-
-managed_by_etckeeper="managed by etckeeper"
-
-nl() {
-	echo >>"$file"
-}
-
-comment() {
-	comment="$1"
-	echo "# $comment" >>"$file"
-}
-
-ignore() {
-	glob="$1"
-	
-	case "$VCS" in
-		git|bzr)
-			echo "$glob" >>"$file"
-		;;
-		hg)
-			# rather than converting the glob to a regexp, just
-			# configure hg to use globs
-			if [ -z "$hg_syntax_printed" ]; then
-				comment "use glob syntax"
-				echo "syntax: glob" >>"$file"
-				nl
-				hg_syntax_printed=1
-			fi
-			echo "$glob" >>"$file"
-		;;
-		darcs)
-			# darcs doesn't understand globs, so we need to translate
-			# them into regexs. Not a complete converter, but suitable
-			# for given globs.
-			if [ "${glob%\*}" != "$glob" ]; then
-				glob="${glob%\*}"
-			else
-				glob="$glob"'($|/)'
-			fi
-			if [ "${glob#\*}" != "$glob" ]; then
-				glob="${glob#\*}"
-			else
-				glob='(^|/)'"$glob"
-			fi
-			glob="$( printf %s $glob | sed -e 's/\./\\./g;s/\*/[^\/]*/g;s/\?/[^\/]/g' )"
-			echo "$glob" >>"$file"
-	esac
-}
-
-writefile () {
-	comment "begin section $managed_by_etckeeper (do not edit this section by hand)"
-	nl
-
-	if [ "$VCS" = darcs ]; then
-		darcs setpref boringfile .darcsignore
-	fi
-
-	if [ "$LOWLEVEL_PACKAGE_MANAGER" = dpkg ]; then
-		comment "new and old versions of conffiles, stored by dpkg"
-		ignore "*.dpkg-*"
-		nl
-	elif [ "$LOWLEVEL_PACKAGE_MANAGER" = "rpm" ]; then
-		comment "new and old versions of conffiles, stored by apt/rpm"
-		ignore "*.rpm*"
-		nl
-	elif [ "$LOWLEVEL_PACKAGE_MANAGER" = "pacman-g2" ]; then
-		comment "new and old versions of conffiles, stored by pacman"
-		ignore "*.pacnew"
-		ignore "*.pacorig"
-		ignore "*.pacsave"
-		nl
-	fi
-	
-	comment "mount(8) records system state here, no need to store these"
-	ignore blkid.tab
-	ignore blkid.tab.old
-	nl
-	
-	comment "some other files in /etc that typically do not need to be tracked"
-	ignore nologin
-	ignore ld.so.cache
-	ignore mtab
-	ignore .pwd.lock
-	ignore network/run
-	ignore adjtime
-	ignore lvm/cache
-	nl
-	
-	comment "editor temp files"
-	ignore "*~"
-	ignore ".*.sw?"
-	ignore ".sw?"
-	ignore "#*#"
-	ignore DEADJOE
-
-	nl
-	comment "end section $managed_by_etckeeper"
-}
-
-if [ -e "$file" ]; then
-	if ! grep -q "$managed_by_etckeeper" "$file"; then
-		echo "etckeeper: "$file" does not contain \"$managed_by_etckeeper\" comment; not updating"
-		exit 1
-	fi
-	realfile="$file"
-	if [ -n "`type -p tempfile`" ]; then
-		tempfile="tempfile"
-	elif [ -n "`type -p mktemp`" ]; then
-		tempfile="mktemp"
-	else
-		echo "etckeeper warning: can't find tempfile or mktemp" >&2
-	fi
-	file=$($tempfile)
-	(
-		skipping=
-		while read line; do
-			if echo "$line" | grep -q "$managed_by_etckeeper"; then
-				if [ ! "$skipping" ]; then
-					skipping=1
-				else
-					skipping=
-					writefile
-				fi
-			elif [ ! "$skipping" ]; then
-				echo "$line" >> "$file"
-			fi
-		done
-		if [ "$skipping" ]; then
-			# reached end of file w/o ending block
-			writefile
-		fi
-	) <"$realfile"
-
-	mv -f "$file" "$realfile"
-else
-	writefile
-fi
diff --git a/update-ignore.d/01update-ignore.in b/update-ignore.d/01update-ignore.in
new file mode 100644
index 0000000..2de6e61
--- /dev/null
+++ b/update-ignore.d/01update-ignore.in
@@ -0,0 +1,160 @@
+#!@SHELLPATH@
+set -e
+
+if [ "$VCS" = git ]; then
+	dir=.git
+	file=.gitignore
+elif [ "$VCS" = hg ]; then
+	dir=.hg
+	file=.hgignore
+elif [ "$VCS" = bzr ]; then
+	dir=.bzr
+	file=.bzrignore
+elif [ "$VCS" = darcs ]; then
+	dir=_darcs
+	file=.darcsignore
+else
+	echo "etckeeper: unsupported VCS $VCS" >&2
+	exit 1
+fi
+
+if [ ! -d "$dir" ]; then
+	exit 0
+fi
+
+managed_by_etckeeper="managed by etckeeper"
+
+nl() {
+	echo >>"$file"
+}
+
+comment() {
+	comment="$1"
+	echo "# $comment" >>"$file"
+}
+
+ignore() {
+	glob="$1"
+	
+	case "$VCS" in
+		git|bzr)
+			echo "$glob" >>"$file"
+		;;
+		hg)
+			# rather than converting the glob to a regexp, just
+			# configure hg to use globs
+			if [ -z "$hg_syntax_printed" ]; then
+				comment "use glob syntax"
+				echo "syntax: glob" >>"$file"
+				nl
+				hg_syntax_printed=1
+			fi
+			echo "$glob" >>"$file"
+		;;
+		darcs)
+			# darcs doesn't understand globs, so we need to translate
+			# them into regexs. Not a complete converter, but suitable
+			# for given globs.
+			if [ "${glob%\*}" != "$glob" ]; then
+				glob="${glob%\*}"
+			else
+				glob="$glob"'($|/)'
+			fi
+			if [ "${glob#\*}" != "$glob" ]; then
+				glob="${glob#\*}"
+			else
+				glob='(^|/)'"$glob"
+			fi
+			glob="$( printf %s $glob | sed -e 's/\./\\./g;s/\*/[^\/]*/g;s/\?/[^\/]/g' )"
+			echo "$glob" >>"$file"
+	esac
+}
+
+writefile () {
+	comment "begin section $managed_by_etckeeper (do not edit this section by hand)"
+	nl
+
+	if [ "$VCS" = darcs ]; then
+		darcs setpref boringfile .darcsignore
+	fi
+
+	if [ "$LOWLEVEL_PACKAGE_MANAGER" = dpkg ]; then
+		comment "new and old versions of conffiles, stored by dpkg"
+		ignore "*.dpkg-*"
+		nl
+	elif [ "$LOWLEVEL_PACKAGE_MANAGER" = "rpm" ]; then
+		comment "new and old versions of conffiles, stored by apt/rpm"
+		ignore "*.rpm*"
+		nl
+	elif [ "$LOWLEVEL_PACKAGE_MANAGER" = "pacman-g2" ]; then
+		comment "new and old versions of conffiles, stored by pacman"
+		ignore "*.pacnew"
+		ignore "*.pacorig"
+		ignore "*.pacsave"
+		nl
+	fi
+	
+	comment "mount(8) records system state here, no need to store these"
+	ignore blkid.tab
+	ignore blkid.tab.old
+	nl
+	
+	comment "some other files in /etc that typically do not need to be tracked"
+	ignore nologin
+	ignore ld.so.cache
+	ignore mtab
+	ignore .pwd.lock
+	ignore network/run
+	ignore adjtime
+	ignore lvm/cache
+	nl
+	
+	comment "editor temp files"
+	ignore "*~"
+	ignore ".*.sw?"
+	ignore ".sw?"
+	ignore "#*#"
+	ignore DEADJOE
+
+	nl
+	comment "end section $managed_by_etckeeper"
+}
+
+if [ -e "$file" ]; then
+	if ! grep -q "$managed_by_etckeeper" "$file"; then
+		echo "etckeeper: "$file" does not contain \"$managed_by_etckeeper\" comment; not updating"
+		exit 1
+	fi
+	realfile="$file"
+	if [ -n "`type -p tempfile`" ]; then
+		tempfile="tempfile"
+	elif [ -n "`type -p mktemp`" ]; then
+		tempfile="mktemp"
+	else
+		echo "etckeeper warning: can't find tempfile or mktemp" >&2
+	fi
+	file=$($tempfile)
+	(
+		skipping=
+		while read line; do
+			if echo "$line" | grep -q "$managed_by_etckeeper"; then
+				if [ ! "$skipping" ]; then
+					skipping=1
+				else
+					skipping=
+					writefile
+				fi
+			elif [ ! "$skipping" ]; then
+				echo "$line" >> "$file"
+			fi
+		done
+		if [ "$skipping" ]; then
+			# reached end of file w/o ending block
+			writefile
+		fi
+	) <"$realfile"
+
+	mv -f "$file" "$realfile"
+else
+	writefile
+fi
