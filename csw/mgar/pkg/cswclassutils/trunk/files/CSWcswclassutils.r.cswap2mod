#!/bin/sh
#
# r.cswap2mod - Class action script for removing apache2 modules
#
# $Id$
#
# Written by Ben Walton
#
# 2010-09-29 First Release
#

AP2_PREFIX=/opt/csw/apache2
AP2_BINDIR=$AP2_PREFIX/sbin
AP2_LIBEXEC=$AP2_PREFIX/libexec
AP2_CONFDIR=$AP2_PREFIX/etc
AP2_CONFIG=$AP2_CONFDIR/httpd.conf
AP2_APXS=$AP2_BINDIR/apxs

PKG_INSTALL_ROOT=${PKG_INSTALL_ROOT:-'/'}

while read dest; do
      echo $dest
      
      CONF=$PKG_INSTALL_ROOT/$AP2_CONFIG
      APXS=$PKG_INSTALL_ROOT/$AP2_APXS
      MODFILE=`basename $dest`
      MODNAME=`echo $MODFILE | sed 's/mod_//; s/\.so$//'`

      # This check ensures we have an httpd.conf where we expect it
      # and that apxs is available.  This (hopefully) prevents us from
      # doing anything if the local system has completely reworked the
      # etc/ file structure
      if [ -f "$CONF" -a -x "$APXS" ]; then
	  # Disable the module
	  chroot $PKG_INSTALL_ROOT \
	      $APXS -e -A -n $MODNAME $MODFILE
	  cat <<END


NOTICE: The $MODNAME module was disabled in httpd.conf but the server
was not restarted.  Please modify httpd.conf as appropriate and
restart apache.


END
      fi

      # Now actually remove the file.
      /usr/bin/rm -f $dest || exit 2

done

exit 0
