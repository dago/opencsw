NAME = imagemagick
VERSION = 6.7.0
GARSUBREV = 4
CATEGORIES = lib

DESCRIPTION = A comprehensive package supporting automated and interative manipulation of images
define BLURB
  ImageMagick is a robust collection of tools and libraries offered under a
  usage license to read, write, and manipulate an image in many image formats
  (over 89 major formats) including popular formats like TIFF, JPEG, PNG, PDF,
  PhotoCD, and GIF.
endef

MASTER_SITES = ftp://ftp.imagemagick.org/pub/ImageMagick/
DISTNAME = ImageMagick-$(VERSION)-$(GARSUBREV)
DISTFILES  = $(DISTNAME).tar.xz

VENDOR_URL = http://www.imagemagick.org

LICENSE = LICENSE

# Shared library suffix .10 has been used to mean "1.0"

#PACKAGES += CSWlibmagick++10
#PKGFILES_CSWlibmagick++10 += $(call pkgfiles_lib,libMagick++.so.10)
#SPKG_DESC_CSWlibmagick++10 += Library from ImageMagick, libMagick++.so.10
#RUNTIME_DEP_PKGS_CSWlibmagick++10 += CSWlibwand10
#RUNTIME_DEP_PKGS_CSWlibmagick++10 += CSWftype2
#RUNTIME_DEP_PKGS_CSWlibmagick++10 += CSWlibmagick10
#RUNTIME_DEP_PKGS_CSWlibmagick++10 += CSWsunmath
#RUNTIME_DEP_PKGS_CSWlibmagick++10 += CSWzlib

#PACKAGES += CSWlibmagick++2
#PKGFILES_CSWlibmagick++2 += $(call pkgfiles_lib,libMagick++.so.2)
#SPKG_DESC_CSWlibmagick++2 += Library from ImageMagick, libMagick++.so.2
#RUNTIME_DEP_PKGS_CSWlibmagick++2 += CSWlibmagickwand2
#RUNTIME_DEP_PKGS_CSWlibmagick++2 += CSWjpeg
#RUNTIME_DEP_PKGS_CSWlibmagick++2 += CSWlcmsrt
#RUNTIME_DEP_PKGS_CSWlibmagick++2 += CSWtiff
#RUNTIME_DEP_PKGS_CSWlibmagick++2 += CSWzlib
#RUNTIME_DEP_PKGS_CSWlibmagick++2 += CSWftype2
#RUNTIME_DEP_PKGS_CSWlibmagick++2 += CSWlibmagickcore2
#RUNTIME_DEP_PKGS_CSWlibmagick++2 += CSWfconfig

PACKAGES += CSWlibmagick++4
PKGFILES_CSWlibmagick++4 += $(call pkgfiles_lib,libMagick++.so.4)
SPKG_DESC_CSWlibmagick++4 += Library from ImageMagick, libMagick++.so.4
RUNTIME_DEP_PKGS_CSWlibmagick++4 += CSWlibltdl7
RUNTIME_DEP_PKGS_CSWlibmagick++4 += CSWjpeg
RUNTIME_DEP_PKGS_CSWlibmagick++4 += CSWlcmsrt
RUNTIME_DEP_PKGS_CSWlibmagick++4 += CSWliblqr
RUNTIME_DEP_PKGS_CSWlibmagick++4 += CSWlibintl8
RUNTIME_DEP_PKGS_CSWlibmagick++4 += CSWtiff
RUNTIME_DEP_PKGS_CSWlibmagick++4 += CSWlibmagickcore4
RUNTIME_DEP_PKGS_CSWlibmagick++4 += CSWzlib
RUNTIME_DEP_PKGS_CSWlibmagick++4 += CSWftype2
RUNTIME_DEP_PKGS_CSWlibmagick++4 += CSWbzip2
RUNTIME_DEP_PKGS_CSWlibmagick++4 += CSWlibmagickwand4
RUNTIME_DEP_PKGS_CSWlibmagick++4 += CSWfconfig
RUNTIME_DEP_PKGS_CSWlibmagick++4 += CSWglib2
RUNTIME_DEP_PKGS_CSWlibmagick++4 += CSWlibfftw3-3
RUNTIME_DEP_PKGS_CSWlibmagick++4 += CSWliblzma5


#PACKAGES += CSWlibmagick10
#PKGFILES_CSWlibmagick10 += $(call pkgfiles_lib,libMagick.so.10)
#SPKG_DESC_CSWlibmagick10 += Library from ImageMagick, libMagick.so.10
#RUNTIME_DEP_PKGS_CSWlibmagick10 += CSWjpeg
#RUNTIME_DEP_PKGS_CSWlibmagick10 += CSWsunmath
#RUNTIME_DEP_PKGS_CSWlibmagick10 += CSWtiff
#RUNTIME_DEP_PKGS_CSWlibmagick10 += CSWzlib
#RUNTIME_DEP_PKGS_CSWlibmagick10 += CSWftype2
#RUNTIME_DEP_PKGS_CSWlibmagick10 += CSWlcmsrt
#RUNTIME_DEP_PKGS_CSWlibmagick10 += CSWbzip2
#RUNTIME_DEP_PKGS_CSWlibmagick10 += CSWfconfig

#PACKAGES += CSWlibmagickcore2
#PKGFILES_CSWlibmagickcore2 += $(call pkgfiles_lib,libMagickCore.so.2)
#SPKG_DESC_CSWlibmagickcore2 += Library from ImageMagick, libMagickCore.so.2
#RUNTIME_DEP_PKGS_CSWlibmagickcore2 += CSWjpeg
#RUNTIME_DEP_PKGS_CSWlibmagickcore2 += CSWlcmsrt
#RUNTIME_DEP_PKGS_CSWlibmagickcore2 += CSWtiff
#RUNTIME_DEP_PKGS_CSWlibmagickcore2 += CSWzlib
#RUNTIME_DEP_PKGS_CSWlibmagickcore2 += CSWftype2
#RUNTIME_DEP_PKGS_CSWlibmagickcore2 += CSWfconfig

PACKAGES += CSWlibmagickcore4
PKGFILES_CSWlibmagickcore4 += $(call pkgfiles_lib,libMagickCore.so.4)
SPKG_DESC_CSWlibmagickcore4 += Library from ImageMagick, libMagickCore.so.4
RUNTIME_DEP_PKGS_CSWlibmagickcore4 += CSWlibltdl7
RUNTIME_DEP_PKGS_CSWlibmagickcore4 += CSWjpeg
RUNTIME_DEP_PKGS_CSWlibmagickcore4 += CSWlcmsrt
RUNTIME_DEP_PKGS_CSWlibmagickcore4 += CSWliblqr
RUNTIME_DEP_PKGS_CSWlibmagickcore4 += CSWlibintl8
RUNTIME_DEP_PKGS_CSWlibmagickcore4 += CSWtiff
RUNTIME_DEP_PKGS_CSWlibmagickcore4 += CSWzlib
RUNTIME_DEP_PKGS_CSWlibmagickcore4 += CSWftype2
RUNTIME_DEP_PKGS_CSWlibmagickcore4 += CSWbzip2
RUNTIME_DEP_PKGS_CSWlibmagickcore4 += CSWfconfig
RUNTIME_DEP_PKGS_CSWlibmagickcore4 += CSWglib2
RUNTIME_DEP_PKGS_CSWlibmagickcore4 += CSWlibfftw3-3
RUNTIME_DEP_PKGS_CSWlibmagickcore4 += CSWliblzma5
# Gnuplot is detected by the magic cookie #!/usr/local/bin/gnuplot
# XXX: Is this correct?
CHECKPKG_OVERRIDES_CSWlibmagickcore4 += file-with-bad-content|/usr/local|root/opt/csw/lib/libMagickCore.so.4.0.1

#PACKAGES += CSWlibmagickwand2
#PKGFILES_CSWlibmagickwand2 += $(call pkgfiles_lib,libMagickWand.so.2)
#SPKG_DESC_CSWlibmagickwand2 += Library from ImageMagick, libMagickWand.so.2
#RUNTIME_DEP_PKGS_CSWlibmagickwand2 += CSWjpeg
#RUNTIME_DEP_PKGS_CSWlibmagickwand2 += CSWlcmsrt
#RUNTIME_DEP_PKGS_CSWlibmagickwand2 += CSWtiff
#RUNTIME_DEP_PKGS_CSWlibmagickwand2 += CSWzlib
#RUNTIME_DEP_PKGS_CSWlibmagickwand2 += CSWftype2
#RUNTIME_DEP_PKGS_CSWlibmagickwand2 += CSWlibmagickcore2
#RUNTIME_DEP_PKGS_CSWlibmagickwand2 += CSWfconfig

PACKAGES += CSWlibmagickwand4
PKGFILES_CSWlibmagickwand4 += $(call pkgfiles_lib,libMagickWand.so.4)
SPKG_DESC_CSWlibmagickwand4 += Library from ImageMagick, libMagickWand.so.4
RUNTIME_DEP_PKGS_CSWlibmagickwand4 += CSWlibltdl7
RUNTIME_DEP_PKGS_CSWlibmagickwand4 += CSWjpeg
RUNTIME_DEP_PKGS_CSWlibmagickwand4 += CSWlcmsrt
RUNTIME_DEP_PKGS_CSWlibmagickwand4 += CSWliblqr
RUNTIME_DEP_PKGS_CSWlibmagickwand4 += CSWlibintl8
RUNTIME_DEP_PKGS_CSWlibmagickwand4 += CSWtiff
RUNTIME_DEP_PKGS_CSWlibmagickwand4 += CSWlibmagickcore4
RUNTIME_DEP_PKGS_CSWlibmagickwand4 += CSWzlib
RUNTIME_DEP_PKGS_CSWlibmagickwand4 += CSWftype2
RUNTIME_DEP_PKGS_CSWlibmagickwand4 += CSWbzip2
RUNTIME_DEP_PKGS_CSWlibmagickwand4 += CSWfconfig
RUNTIME_DEP_PKGS_CSWlibmagickwand4 += CSWglib2
RUNTIME_DEP_PKGS_CSWlibmagickwand4 += CSWlibfftw3-3
RUNTIME_DEP_PKGS_CSWlibmagickwand4 += CSWliblzma5

#PACKAGES += CSWlibwand10
#PKGFILES_CSWlibwand10 += $(call pkgfiles_lib,libWand.so.10)
#SPKG_DESC_CSWlibwand10 += Library from ImageMagick, libWand.so.10
#RUNTIME_DEP_PKGS_CSWlibwand10 += CSWftype2
#RUNTIME_DEP_PKGS_CSWlibwand10 += CSWsunmath
#RUNTIME_DEP_PKGS_CSWlibwand10 += CSWlibmagick10
#RUNTIME_DEP_PKGS_CSWlibwand10 += CSWzlib

PACKAGES += CSWimagemagick-dev
SPKG_DESC_CSWimagemagick-dev = Development files for ImageMagick libraries
PKGFILES_CSWimagemagick-dev += $(PKGFILES_DEVEL)
PKGFILES_CSWimagemagick-dev += $(docdir)/.*
RUNTIME_DEP_PKGS_CSWimagemagick-dev += CSWlibmagick++4
RUNTIME_DEP_PKGS_CSWimagemagick-dev += CSWlibmagickcore4
RUNTIME_DEP_PKGS_CSWimagemagick-dev += CSWlibmagickwand4
RUNTIME_DEP_PKGS_CSWimagemagick-dev += CSWperl
# This is all in /opt/csw/share/doc
CHECKPKG_OVERRIDES_CSWimagemagick-dev += file-with-bad-content

PACKAGES += CSWimagemagick
SPKG_DESC_CSWimagemagick = A comprehensive package supporting automated and interative manipulation of images
# PKGFILES is catchall
RUNTIME_DEP_PKGS_CSWimagemagick += CSWlibmagickcore4
RUNTIME_DEP_PKGS_CSWimagemagick += CSWlibmagickwand4
RUNTIME_DEP_PKGS_CSWimagemagick += CSWlcmsrt
RUNTIME_DEP_PKGS_CSWimagemagick += CSWbzip2
RUNTIME_DEP_PKGS_CSWimagemagick += CSWilmbase
RUNTIME_DEP_PKGS_CSWimagemagick += CSWpng
RUNTIME_DEP_PKGS_CSWimagemagick += CSWgtk2
RUNTIME_DEP_PKGS_CSWimagemagick += CSWglib2
RUNTIME_DEP_PKGS_CSWimagemagick += CSWlibltdl7
RUNTIME_DEP_PKGS_CSWimagemagick += CSWjpeg
RUNTIME_DEP_PKGS_CSWimagemagick += CSWlibfpx
RUNTIME_DEP_PKGS_CSWimagemagick += CSWjasper
RUNTIME_DEP_PKGS_CSWimagemagick += CSWlibintl8
RUNTIME_DEP_PKGS_CSWimagemagick += CSWtiff
RUNTIME_DEP_PKGS_CSWimagemagick += CSWlibxml2-2
RUNTIME_DEP_PKGS_CSWimagemagick += CSWfconfig
RUNTIME_DEP_PKGS_CSWimagemagick += CSWjbigkit
RUNTIME_DEP_PKGS_CSWimagemagick += CSWliblqr
RUNTIME_DEP_PKGS_CSWimagemagick += CSWlibcdt5
RUNTIME_DEP_PKGS_CSWimagemagick += CSWzlib
RUNTIME_DEP_PKGS_CSWimagemagick += CSWftype2
RUNTIME_DEP_PKGS_CSWimagemagick += CSWlibrsvg
RUNTIME_DEP_PKGS_CSWimagemagick += CSWopenexrrt
RUNTIME_DEP_PKGS_CSWimagemagick += CSWdjvulibrert
RUNTIME_DEP_PKGS_CSWimagemagick += CSWlibgraph5
RUNTIME_DEP_PKGS_CSWimagemagick += CSWlibcairo
RUNTIME_DEP_PKGS_CSWimagemagick += CSWlibgvc6
RUNTIME_DEP_PKGS_CSWimagemagick += CSWgcc3g++rt
RUNTIME_DEP_PKGS_CSWimagemagick += CSWlibfftw3-3
RUNTIME_DEP_PKGS_CSWimagemagick += CSWlibwmf0-2-7
RUNTIME_DEP_PKGS_CSWimagemagick += CSWlibwmflite0-2-7
RUNTIME_DEP_PKGS_CSWimagemagick += CSWliblzma5

PACKAGES += CSWpm-imagemagick
SPKG_DESC_CSWpm-imagemagick = Image::Magick: Perl binding for Imagemagick
PKGFILES_CSWpm-imagemagick += $(libdir)/perl/.*
RUNTIME_DEP_PKGS_CSWpm-imagemagick += CSWperl
RUNTIME_DEP_PKGS_CSWpm-imagemagick += CSWlibmagickcore4

BUILD_DEP_PKGS += CSWdjvulibredevel
BUILD_DEP_PKGS += CSWgraphvizdevel
BUILD_DEP_PKGS += CSWilmbasedevel
BUILD_DEP_PKGS += CSWlcmsdevel
BUILD_DEP_PKGS += CSWlibcairodevel
BUILD_DEP_PKGS += CSWliblqrdevel
BUILD_DEP_PKGS += CSWlibwmf-dev
BUILD_DEP_PKGS += CSWliblzma-dev
BUILD_DEP_PKGS += CSWopenexrdevel

EXTRA_LINKER_FLAGS = -norunpath

# Somehow the above flag does not make it to the linker
CHECKPKG_OVERRIDES_CSWlibmagick++4 += bad-rpath-entry|/lib|opt/csw/lib/libMagick++.so.4.0.1
CHECKPKG_OVERRIDES_CSWlibmagick++4 += bad-rpath-entry|/opt/SUNWspro/lib|opt/csw/lib/libMagick++.so.4.0.1
CHECKPKG_OVERRIDES_CSWlibmagick++4 += bad-rpath-entry|/opt/SUNWspro/lib/rw7|opt/csw/lib/libMagick++.so.4.0.1
CHECKPKG_OVERRIDES_CSWlibmagick++4 += bad-rpath-entry|/opt/SUNWspro/lib/v8|opt/csw/lib/libMagick++.so.4.0.1

CONFIGURE_ARGS  = $(DIRPATHS)
CONFIGURE_ARGS += --with-perl=$(bindir)/perl
CONFIGURE_ARGS += --enable-shared --disable-static
CONFIGURE_ARGS += --with-dps=yes
# Ghostscript lib is linked to Sun X11
# CONFIGURE_ARGS += --with-gslib=no
# Solaris 8 and 9 doesn't have complex.h
# CONFIGURE_ARGS += --without-fftw
CONFIGURE_ARGS += --with-modules=yes
# Let's try to use openmp and see what it does for performance
#CONFIGURE_ARGS += --disable-openmp
CONFIGURE_ARGS += --disable-silent-rules

# Until librsvg,graphviz and perl is 64bit
CONFIGURE_ARGS-64 += --without-gvc
CONFIGURE_ARGS-64 += --without-rsvg
CONFIGURE_ARGS-64 += --without-perl
CONFIGURE_ARGS-64 += --without-gvc
CONFIGURE_ARGS-64 += --without-rsvg
CONFIGURE_ARGS-64 += --without-perl
CONFIGURE_ARGS += $(CONFIGURE_ARGS-$(MEMORYMODEL))

# One test is failing:
#   FAIL: Magick++/tests/attributes.sh
# This has been reported upstream at
#   http://www.imagemagick.org/discourse-server/viewtopic.php?f=3&t=18889
SKIPTEST ?= 1

# Dependencies not 64-bit yet
#BUILD64 = 1

# This is for coders/dps.so to find libdps.so.5 and libdpstk.so.5
# EXTRA_LIB = /usr/openwin/lib
# Is this really a problem?
CHECKPKG_OVERRIDES_CSWimagemagick += soname-not-found|libdps.so.5|is|needed|by|opt/csw/lib/ImageMagick-6.7.0/modules-Q16/coders/dps.so
CHECKPKG_OVERRIDES_CSWimagemagick += soname-not-found|libdpstk.so.5|is|needed|by|opt/csw/lib/ImageMagick-6.7.0/modules-Q16/coders/dps.so

# Only remove libtool files from the public lib directory, keep the private ones for libtool dlopn
MERGE_EXCLUDE_LIBTOOL ?= $(libdir)/lib.*\.la

EXTRA_MERGE_EXCLUDE_FILES += .*/perllocal.pod
EXTRA_MERGE_EXCLUDE_FILES += .*/\.packlist

STRIP_LIBTOOL = 1


include gar/category.mk

SPKG_REVSTAMP := $(SPKG_REVSTAMP)_rev=$(GARSUBREV)

#post-install-isa-sparcv8:
#	@( cd $(INSTALLISADIR)$(libdir) ; bzip2 -dc $(CURDIR)/$(FILEDIR)/6.2.9.s.tar.bz2 |tar xf -)
#	@( cd $(INSTALLISADIR)$(libdir) ; bzip2 -dc $(CURDIR)/$(FILEDIR)/6.5.2.s.tar.bz2 |tar xf -)
#	@mv $(INSTALLISADIR)$(mandir)/man1/compare.1 $(INSTALLISADIR)$(mandir)/man1/compare2.1
#	@mv $(INSTALLISADIR)$(bindir)/compare $(INSTALLISADIR)$(bindir)/compare2
#	@$(MAKECOOKIE)
#
#post-install-isa-i386:
#	@( cd $(INSTALLISADIR)$(libdir) ; bzip2 -dc $(CURDIR)/$(FILEDIR)/6.2.9.i.tar.bz2 |tar xf -)
#	@( cd $(INSTALLISADIR)$(libdir) ; bzip2 -dc $(CURDIR)/$(FILEDIR)/6.5.2.i.tar.bz2 |tar xf -)
#	@mv $(INSTALLISADIR)$(mandir)/man1/compare.1 $(INSTALLISADIR)$(mandir)/man1/compare2.1
#	@mv $(INSTALLISADIR)$(bindir)/compare $(INSTALLISADIR)$(bindir)/compare2
#	@$(MAKECOOKIE)

post-install-modulated:
	perl -pi \
		-e 's,/usr/local/bin,$(bindir),g' \
		$(DESTDIR)$(sysconfdir)/ImageMagick/mime.xml
