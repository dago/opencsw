From 81663042c3a5a11c500891f6cc733aca2737e0e0 Mon Sep 17 00:00:00 2001
From: Dagobert Michelsen <dam@opencsw.org>
Date: Tue, 12 Jul 2011 15:36:50 +0200
Subject: [PATCH 01/10] Shield ptrace defines

---
 libexplain/buffer/errno/ptrace.c |   14 ++++++++++++--
 libexplain/ptrace.h              |    2 ++
 2 files changed, 14 insertions(+), 2 deletions(-)

diff --git a/libexplain/buffer/errno/ptrace.c b/libexplain/buffer/errno/ptrace.c
index daaed40..574e168 100644
--- a/libexplain/buffer/errno/ptrace.c
+++ b/libexplain/buffer/errno/ptrace.c
@@ -454,18 +454,27 @@ explain_buffer_errno_ptrace_explanation(explain_string_buffer_t *sb, int errnum,
             explain_buffer_efault(sb, "data");
             break;
         }
+#if defined(PT_CONTINUE) || defined(PT_SYSCALL) || defined(PR_STEP) || defined(PT_SYSEMU) || defined(PT_SYSEMU_SINGLESTEP) || defined(PT_SYSEMU_SINGLESTEP)
         switch (request)
         {
+#ifdef PT_CONTINUE
         case PT_CONTINUE:
+#endif
+#ifdef PT_SYSCALL
         case PT_SYSCALL:
+#endif
+#ifdef PT_STEP
         case PT_STEP:
+#endif
 #ifdef PT_SYSEMU
         case PT_SYSEMU:
 #endif
 #ifdef PT_SYSEMU_SINGLESTEP
         case PT_SYSEMU_SINGLESTEP:
 #endif
+#ifdef PT_SYSEMU_SINGLESTEP
         case PT_DETACH:
+#endif
             explain_buffer_gettext
             (
                 sb,
@@ -482,6 +491,7 @@ explain_buffer_errno_ptrace_explanation(explain_string_buffer_t *sb, int errnum,
         default:
             break;
         }
+#endif
         explain_buffer_gettext
         (
             sb,
@@ -493,7 +503,6 @@ explain_buffer_errno_ptrace_explanation(explain_string_buffer_t *sb, int errnum,
             i18n("there was a word-alignment violation")
         );
         break;
-
     case EPERM:
         if (!explain_process_exists(pid))
         {
@@ -546,7 +555,7 @@ explain_buffer_errno_ptrace_explanation(explain_string_buffer_t *sb, int errnum,
     }
 }
 
-
+#ifdef HAVE_SYS_PTRACE_H
 void
 explain_buffer_errno_ptrace(explain_string_buffer_t *sb, int errnum, int
     request, pid_t pid, void *addr, void *data)
@@ -560,6 +569,7 @@ explain_buffer_errno_ptrace(explain_string_buffer_t *sb, int errnum, int
         "ptrace", request, pid, addr, data);
     explain_explanation_assemble(&exp, sb);
 }
+#endif
 
 
 /* vim: set ts=8 sw=4 et */
diff --git a/libexplain/ptrace.h b/libexplain/ptrace.h
index cd17e40..88b1dc9 100644
--- a/libexplain/ptrace.h
+++ b/libexplain/ptrace.h
@@ -30,7 +30,9 @@
 #include <libexplain/warn_unused_result.h>
 #include <libexplain/large_file_support.h>
 
+#ifdef HAVE_SYS_PTRACE_H
 #include <sys/ptrace.h>
+#endif
 
 #ifdef __cplusplus
 extern "C" {
-- 
1.7.6

