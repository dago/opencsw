#!/bin/bash

ROOT=$1

AP2_ROOT=/opt/csw/apache2
AP2_CONF=$AP2_ROOT/etc

cd $ROOT/$AP2_CONF;

for f in $(find . -type f | grep -v original/ ); do
    echo "...processing $f"
    template=$f.CSW

    cat <<EOF > $template
PIR=\${PKG_INSTALL_ROOT:-/}
AP2_ROOT=\$PIR/$AP2_ROOT
AP2_CONF=\$AP2_ROOT/etc
TEMPLATE=\$AP2_CONF/$template

if [ "\$1" = install ]; then
  cat <<EOS > \$TEMPLATE
EOF

perl -pi -e 's/\$/\\\$/g' $f
cat $f >> $template

cat <<EOF >> $template
EOS

if [ ! -f \$AP2_CONF/$f ]; then
  cp -p \$TEMPLATE \$AP2_CONF/$f
fi

else
  rm \$TEMPLATE
fi

EOF

rm $f
done
