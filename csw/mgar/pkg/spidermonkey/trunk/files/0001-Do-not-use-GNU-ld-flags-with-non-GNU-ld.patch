From e89d165866a9877b708fc853136d3125aa1e17a7 Mon Sep 17 00:00:00 2001
From: Maciej Blizinski <maciej@opencsw.org>
Date: Sat, 10 Mar 2012 10:28:33 +0100
Subject: [PATCH 1/2] Do not use GNU ld flags with non-GNU ld

Fails on Solaris:

rm -f libmozjs185.so 
/opt/csw/bin/g++  -fno-rtti -fno-exceptions -fshort-enums 
-DJS_C_STRINGS_ARE_UTF8 -fno-strict-aliasing -pthread  -DNDEBUG -DTRIMMED 
-O3 -fstrict-aliasing -fomit-frame-pointer -mcpu=v9 -DUSE_SYSTEM_MALLOC=1 
-DENABLE_ASSEMBLER=1 -DENABLE_JIT=1 -fPIC -shared -Wl,-h,libmozjs185.so -o 
libmozjs185.so  jsanalyze.o jsapi.o jsarena.o jsarray.o jsatom.o jsbool.o 
jsclone.o jscntxt.o jscompartment.o jsdate.o jsdbgapi.o jsdhash.o jsdtoa.o 
jsemit.o jsexn.o jsfriendapi.o jsfun.o jsgc.o jsgcchunk.o jsgcstats.o 
jshash.o jsinterp.o jsinvoke.o jsiter.o jslock.o jslog2.o jsmath.o 
jsnativestack.o jsnum.o jsobj.o json.o jsopcode.o jsparse.o jsproxy.o 
jsprf.o jsprobes.o jspropertycache.o jspropertytree.o jsreflect.o 
jsregexp.o jsscan.o jsscope.o jsscript.o jsstr.o jstypedarray.o jsutil.o 
jswrapper.o jsxdrapi.o jsxml.o prmjtime.o sharkctl.o jstracer.o Assembler.o 
Allocator.o CodeAlloc.o Containers.o Fragmento.o LIR.o njconfig.o 
RegAlloc.o avmplus.o NativeSparc.o jsbuiltins.o VMPI.o Writer.o checks.o 
conversions.o diy-fp.o v8-dtoa.o fast-dtoa.o platform.o utils.o 
pcre_compile.o pcre_exec.o pcre_tables.o pcre_xclass.o 
pcre_ucp_searchfuncs.o jsperf.o pm_stub.o     -lpthread  -Wl,-z,ignore 
-Wl,-R,'$ORIGIN:$ORIGIN/..' -Wl,-z,lazyload -Wl,-z,combreloc -Wl,-z,muldefs 
   -Wl,-R/opt/csw/lib -L/opt/csw/lib -lplds4 -lplc4 -lnspr4 -L/opt/csw/lib 
-lpthread -ldl -lposix4 -Wl,-soname,libmozjs185.so.1.0 -lsocket -lc  -lm 
-lpos 
ix4 -ldl -lnsl -lsocket 
ld: warning: option -o appears more than once, first setting taken 
ld: fatal: file libmozjs185.so.1.0: open failed: No such file or directory 
ld: fatal: File processing errors. No output written to libmozjs185.so 
gmake[3]: *** [libmozjs185.so] Error 1 
gmake[3]: Leaving directory 
`/home/maciej/src/opencsw/pkg/spidermonkey/trunk/work/solaris10-sparc/build-isa-sparcv8plus/js-1.8.5/js/objdir' 

The workaround is to remove the "-Wl,-soname,libmozjs185.so.1.0" bit, since 
the soname is already defined by -Wl,-h,libmozjs185.so. 

After removing the "-Wl,-soname,libmozjs185.so.1.0" options, linking 
succeeds and the library is there: 

/usr/ccs/bin/dump -Lv libmozjs185.so | grep SONAME 
[11]    SONAME          libmozjs185.so 

Perhaps the "-Wl,-soname,libmozjs185.so.1.0" flag needs to be only added 
conditionally, when using GNU ld. Also, the soname passed by the -h flag is 
out of sync with the one passed by -Wl 

---
 js/src/Makefile.in           |    2 ++
 js/src/config/autoconf.mk.in |    1 +
 js/src/configure.in          |    1 +
 3 files changed, 4 insertions(+), 0 deletions(-)

diff --git a/js/src/Makefile.in b/js/src/Makefile.in
index a85e055..2ca1ebe 100644
--- a/js/src/Makefile.in
+++ b/js/src/Makefile.in
@@ -871,9 +871,11 @@ else
 SHLIB_ANY_VER   := $(DESTDIR)$(libdir)/$(SHARED_LIBRARY)
 SHLIB_ABI_VER   := $(DESTDIR)$(libdir)/$(SHARED_LIBRARY).$(SRCREL_ABI_VERSION)
 SHLIB_EXACT_VER := $(DESTDIR)$(libdir)/$(SHARED_LIBRARY).$(SRCREL_VERSION)
+ifeq (1,$(GCC_USE_GNU_LD))
 $(SHARED_LIBRARY): EXTRA_DSO_LDOPTS += -Wl,-soname,$(notdir $(SHLIB_ABI_VER))
 endif
 endif
+endif
 
 install:: $(LIBRARY) $(SHARED_LIBRARY) $(IMPORT_LIBRARY)
 ifneq (,$(LIBRARY))
diff --git a/js/src/config/autoconf.mk.in b/js/src/config/autoconf.mk.in
index f4c8150..9ecccf6 100644
--- a/js/src/config/autoconf.mk.in
+++ b/js/src/config/autoconf.mk.in
@@ -202,6 +202,7 @@ CXX_VERSION	= @CXX_VERSION@
 
 GNU_AS		= @GNU_AS@
 GNU_LD		= @GNU_LD@
+GCC_USE_GNU_LD  = @GCC_USE_GNU_LD@
 GNU_CC		= @GNU_CC@
 GNU_CXX		= @GNU_CXX@
 HAVE_GCC3_ABI	= @HAVE_GCC3_ABI@
diff --git a/js/src/configure.in b/js/src/configure.in
index 5d5365b..a96b2ff 100644
--- a/js/src/configure.in
+++ b/js/src/configure.in
@@ -549,6 +549,7 @@ fi
 if test "$GNU_CC"; then
     if `$CC -print-prog-name=ld` -v 2>&1 | grep -c GNU >/dev/null; then
         GCC_USE_GNU_LD=1
+        AC_SUBST(GCC_USE_GNU_LD)
     fi
 fi
 
-- 
1.7.9

