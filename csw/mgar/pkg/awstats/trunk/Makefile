NAME = awstats
VERSION = 6.9
CATEGORIES = apps

DESCRIPTION = Featureful tool for web, ftp and mail server statistics
define BLURB
  AWStats is a free powerful and featureful tool that generates advanced web,
  streaming, ftp or mail server statistics, graphically. This log analyzer works
  as a CGI or from command line and shows you all possible information your log
  contains, in few graphical web pages. It uses a partial information file to be
  able to process large log files, often and quickly. It can analyze log files
  from all major server tools like Apache log files (NCSA combined/XLF/ELF log
  format or common/CLF log format), WebStar, IIS (W3C log format) and a lot of
  other web, proxy, wap, streaming servers, mail servers and some ftp servers.
endef

MASTER_SITES = $(SF_MIRRORS)
DISTFILES  = $(NAME)-$(VERSION).tar.gz
DISTFILES += CSWawstats.postinstall

PATCHFILES = patch-configdir.diff

# We define upstream file regex so we can be notifed of new upstream software release
UFILES_REGEX = $(NAME)-(\d+(?:\.\d+)*).tar.gz

# If the url used to check for software update is different of MASTER_SITES, then 
# uncomment the next line. Otherwise it is set by default to the value of MASTER_SITES
# UPSTREAM_MASTER_SITES = 

SPKG_SOURCEURL = http://awstats.sourceforge.net

RUNTIME_DEP_PKGS = CSWapache2 CSWperl

LICENSE = docs/LICENSE.TXT

CONFIGURE_SCRIPTS =
BUILD_SCRIPTS =
TEST_SCRIPTS =
INSTALL_SCRIPTS = custom

PRESERVECONF  = $(prefix)/apache2/etc/extra/httpd-awstats.conf.CSW
PRESERVECONF += $(sysconfdir)/awstats.conf.CSW

ARCHALL = 1

include gar/category.mk

install-custom:
	ginstall -d $(DESTDIR)$(docdir)/awstats/
	cp -R $(WORKSRC)/docs/* $(DESTDIR)$(docdir)/awstats/
	ginstall -d $(DESTDIR)$(sharedstatedir)/awstats/
	cp -R $(WORKSRC)/tools/* $(DESTDIR)$(sharedstatedir)/awstats/
	ginstall -d $(DESTDIR)$(sharedstatedir)/www/awstats/htdocs/
	cp -R $(WORKSRC)/wwwroot/classes \
			$(WORKSRC)/wwwroot/css \
			$(WORKSRC)/wwwroot/icon \
			$(WORKSRC)/wwwroot/js \
		$(DESTDIR)$(sharedstatedir)/www/awstats/htdocs/
	ginstall -d $(DESTDIR)$(sharedstatedir)/www/awstats/cgi-bin/
	cp -R $(WORKSRC)/wwwroot/cgi-bin/* \
		$(DESTDIR)$(sharedstatedir)/www/awstats/cgi-bin/

	ginstall -d $(DESTDIR)$(sysconfdir)/awstats/
	cat $(WORKSRC)/tools/wwwroot/cgi-bin/awstats.model.conf | perl -p -e '\
		s!/var/log/httpd/mylog.log!/var/opt/csw/awstats!;
		'> $(DESTDIR)$(sysconfdir)/awstats.conf.CSW
	rm -f $(DESTDIR)$(sharedstatedir)/www/awstats/cgi-bin/awstats.model.conf

	ginstall -d $(DESTDIR)$(prefix)/apache2/etc/extra/
	cat $(WORKSRC)/tools/httpd_conf | perl -p -e '\
		s!/usr/local/awstats/wwwroot/cgi-bin/!$(sharedstatedir)/www/awstats/cgi-bin/!; \
		s!/usr/local/awstats/wwwroot/!$(sharedstatedir)/www/awstats/htdocs/!; \
		s!/usr/local/awstats/wwwroot!$(sharedstatedir)/www/awstats/htdocs!; \
		'> $(DESTDIR)$(prefix)/apache2/etc/extra/httpd-awstats.conf.CSW
	rm -f $(DESTDIR)$(sharedstatedir)/awstats/httpd_conf

	@$(MAKECOOKIE)

# ./awstats_updateall.pl now -awstatsprog=/opt/csw/share/www/awstats/cgi-bin/awstats.pl -configdir=/opt/csw/etc

