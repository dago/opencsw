# $Id$
#
# TODO (release-critical prefixed with !, non release-critical with *)
#
# ! Install does not work as there is no contrib any more. Where is this stuff?
#
# * How about shipping a changelog.CSW (example in files/)?
# * The language binding packages all have a whole stack of dependencies
#   (mostly the same libs that the main svn package has). Are those really
#   required? The shared objects generated by SWIG have them in their NEEDED
#   list, but they also link against the main libsvn_client-1.so which in
#   turn pulls in the rest. Can this be tweaked?
#    
# Known build facts/issues:
#
# * The complete build (gmake platforms) takes 4 hours. Build takes about 50
#   mins on build8x, 25 mins on build8s. This is only the build, the tests take
#   about 5 times as much (see TEST_TARGET).
# * Our package is listed on Subversion's binary packages page.  If this
#   package is being taken over, the new maintainer needs to be listed on
#   Subversion's page.  To update their page, one needs to check out this
#   repository: http://svn.apache.org/repos/asf/subversion/site/
#   ...and send the patch to the subversion dev mailing list.
#   http://subversion.apache.org/mailing-lists.html

NAME = subversion
VERSION = 1.7.0-alpha3
CATEGORIES = utils

DESCRIPTION = Version control rethought
define BLURB
    The goal of the Subversion project is to build a version control system 
    that is a compelling replacement for CVS in the open source community.
endef

VENDOR_URL   = http://subversion.apache.org/
MASTER_SITES = http://archive.apache.org/dist/subversion/
#MASTER_SITES = http://orac.ece.utexas.edu/pub/svn/1.6.7/yuletide-eggnog/
DISTFILES    = $(NAME)-$(VERSION).tar.bz2

BUILD_DEP_PKGS += CSWlibexpat-dev
BUILD_DEP_PKGS += CSWlibserf-dev
BUILD_DEP_PKGS += CSWlibsqlite3-dev

PACKAGES  = CSWsvn
SPKG_DESC_CSWsvn           = Version control rethought
CATALOGNAME_CSWsvn         = subversion
RUNTIME_DEP_PKGS_CSWsvn      = CSWbdb48
RUNTIME_DEP_PKGS_CSWsvn      += CSWexpat
RUNTIME_DEP_PKGS_CSWsvn      += CSWggettextrt
RUNTIME_DEP_PKGS_CSWsvn      += CSWiconv
RUNTIME_DEP_PKGS_CSWsvn      += CSWneon
RUNTIME_DEP_PKGS_CSWsvn      += CSWlibserf0-0
RUNTIME_DEP_PKGS_CSWsvn      += CSWoldaprt
RUNTIME_DEP_PKGS_CSWsvn      += CSWsasl
RUNTIME_DEP_PKGS_CSWsvn      += CSWsqlite3rt
RUNTIME_DEP_PKGS_CSWsvn      += CSWzlib
RUNTIME_DEP_PKGS_CSWsvn      += CSWapr
RUNTIME_DEP_PKGS_CSWsvn      += CSWapr-util


PACKAGES += CSWsvn-devel
SPKG_DESC_CSWsvn-devel     = Subversion Development Support
CATALOGNAME_CSWsvn-devel   = subversion_devel
ARCHALL_CSWsvn-devel       = 1
PKGFILES_CSWsvn-devel      = $(PKGFILES_DEVEL)
PKGFILES_CSWsvn-devel     += $(docdir)/$(CATALOGNAME_CSWsvn-devel)/changelog.CSW
CHECKPKG_OVERRIDES_CSWsvn-devel += archall-devel-package

PACKAGES += CSWsvn-contrib
SPKG_DESC_CSWsvn-contrib   = Contributed subversion scripts
CATALOGNAME_CSWsvn-contrib = subversion_contrib
PKGFILES_CSWsvn-contrib    = $(docdir)/subversion/contrib.*
ARCHALL_CSWsvn-contrib     = 1
CHECKPKG_OVERRIDES_CSWsvn-contrib += missing-dependency|CSWperl
CHECKPKG_OVERRIDES_CSWsvn-contrib += missing-dependency|CSWpython
CHECKPKG_OVERRIDES_CSWsvn-contrib += missing-dependency|CSWemacscommon

PACKAGES += CSWsvn-tools
SPKG_DESC_CSWsvn-tools     = Additional subversion tools
CATALOGNAME_CSWsvn-tools   = subversion_tools
PKGFILES_CSWsvn-tools      = $(docdir)/subversion/tools.*
ARCHALL_CSWsvn-tools       = 1
CHECKPKG_OVERRIDES_CSWsvn-tools += missing-dependency|CSWperl
CHECKPKG_OVERRIDES_CSWsvn-tools += missing-dependency|CSWruby
CHECKPKG_OVERRIDES_CSWsvn-tools += missing-dependency|CSWpython
CHECKPKG_OVERRIDES_CSWsvn-tools += missing-dependency|CSWemacscommon

PACKAGES += CSWap2svn
SPKG_DESC_CSWap2svn           = Subversion Modules for Apache 2.2
CATALOGNAME_CSWap2svn         = ap2_subversion
RUNTIME_DEP_PKGS_CSWap2svn    = CSWsvn
RUNTIME_DEP_PKGS_CSWap2svn   += CSWapache2
RUNTIME_DEP_PKGS_CSWap2svn   += CSWggettextrt
RUNTIME_DEP_PKGS_CSWap2svn   += CSWiconv
PKGFILES_CSWap2svn            = $(prefix)/apache2.*
PKGFILES_CSWap2svn           += $(docdir)/$(CATALOGNAME_CSWap2svn)/changelog.CSW

PACKAGES += CSWjavasvn
SPKG_DESC_CSWjavasvn           = Subversion Java Language Binding
CATALOGNAME_CSWjavasvn         = javasvn
PKGFILES_CSWjavasvn            = $(SVNLIB)/.*java.*
PKGFILES_CSWjavasvn           += $(docdir)/$(CATALOGNAME_CSWjavasvn)/changelog.CSW
RUNTIME_DEP_PKGS_CSWjavasvn   += CSWexpat
RUNTIME_DEP_PKGS_CSWjavasvn   += CSWsvn
RUNTIME_DEP_PKGS_CSWjavasvn   += CSWiconv
RUNTIME_DEP_PKGS_CSWjavasvn   += CSWggettextrt
RUNTIME_DEP_PKGS_CSWjavasvn   += CSWneon
RUNTIME_DEP_PKGS_CSWjavasvn   += CSWoldaprt
RUNTIME_DEP_PKGS_CSWjavasvn   += CSWapr-util
RUNTIME_DEP_PKGS_CSWjavasvn   += CSWbdb48
RUNTIME_DEP_PKGS_CSWjavasvn   += CSWapr
#CHECKPKG_OVERRIDES_CSWjavasvn += bad-rpath-entry|/lib|opt/csw/lib/svn/libsvnjavahl-1.so.0.0.0
#CHECKPKG_OVERRIDES_CSWjavasvn += bad-rpath-entry|/opt/SUNWspro/lib|opt/csw/lib/svn/libsvnjavahl-1.so.0.0.0
#CHECKPKG_OVERRIDES_CSWjavasvn += bad-rpath-entry|/opt/SUNWspro/lib/v8|opt/csw/lib/svn/libsvnjavahl-1.so.0.0.0
#CHECKPKG_OVERRIDES_CSWjavasvn += bad-rpath-entry|/opt/SUNWspro/lib/rw7|opt/csw/lib/svn/libsvnjavahl-1.so.0.0.0

PACKAGES += CSWpmsvn
SPKG_DESC_CSWpmsvn         = Subversion Perl Language Binding
CATALOGNAME_CSWpmsvn       = pm_subversion
PKGFILES_CSWpmsvn          = $(libdir)/perl.*
PKGFILES_CSWpmsvn         += $(SVNLIB)/.*perl.*
PKGFILES_CSWpmsvn         += $(mandir)/.*swig_perl.*
PKGFILES_CSWpmsvn         += $(docdir)/$(CATALOGNAME_CSWpmsvn)/changelog.CSW
RUNTIME_DEP_PKGS_CSWpmsvn += CSWperl
RUNTIME_DEP_PKGS_CSWpmsvn += CSWexpat
RUNTIME_DEP_PKGS_CSWpmsvn += CSWsvn
RUNTIME_DEP_PKGS_CSWpmsvn += CSWiconv
RUNTIME_DEP_PKGS_CSWpmsvn += CSWggettextrt
RUNTIME_DEP_PKGS_CSWpmsvn += CSWoldaprt
RUNTIME_DEP_PKGS_CSWpmsvn += CSWapr-util
RUNTIME_DEP_PKGS_CSWpmsvn += CSWbdb48
RUNTIME_DEP_PKGS_CSWpmsvn += CSWapr

PACKAGES += CSWrbsvn
SPKG_DESC_CSWrbsvn         = Subversion Ruby Language Binding
CATALOGNAME_CSWrbsvn       = rbsvn
PKGFILES_CSWrbsvn          = $(libdir)/ruby.*
PKGFILES_CSWrbsvn         += $(SVNLIB)/.*swig_ruby.*
PKGFILES_CSWrbsvn         += $(docdir)/$(CATALOGNAME_CSWrbsvn)/changelog.CSW
RUNTIME_DEP_PKGS_CSWrbsvn += CSWggettextrt
RUNTIME_DEP_PKGS_CSWrbsvn += CSWsvn
RUNTIME_DEP_PKGS_CSWrbsvn += CSWiconv
RUNTIME_DEP_PKGS_CSWrbsvn += CSWruby
RUNTIME_DEP_PKGS_CSWrbsvn += CSWoldaprt
RUNTIME_DEP_PKGS_CSWrbsvn += CSWexpat
RUNTIME_DEP_PKGS_CSWrbsvn += CSWapr-util
RUNTIME_DEP_PKGS_CSWrbsvn += CSWbdb48
RUNTIME_DEP_PKGS_CSWrbsvn += CSWapr
RUNTIME_DEP_PKGS_CSWrbsvn += CSWlibruby1


PACKAGES += CSWpythonsvn
SPKG_DESC_CSWpythonsvn           = Subversion Python Language Binding
CATALOGNAME_CSWpythonsvn         = pythonsvn
PKGFILES_CSWpythonsvn            = $(libdir)/python.*
PKGFILES_CSWpythonsvn           += $(SVNLIB)/.*swig_py.*
PKGFILES_CSWpythonsvn           += $(docdir)/$(CATALOGNAME_CSWpythonsvn)/changelog.CSW
RUNTIME_DEP_PKGS_CSWpythonsvn   += CSWexpat
RUNTIME_DEP_PKGS_CSWpythonsvn   += CSWpython
RUNTIME_DEP_PKGS_CSWpythonsvn   += CSWsvn
RUNTIME_DEP_PKGS_CSWpythonsvn   += CSWiconv
RUNTIME_DEP_PKGS_CSWpythonsvn   += CSWggettextrt
RUNTIME_DEP_PKGS_CSWpythonsvn   += CSWoldaprt
RUNTIME_DEP_PKGS_CSWpythonsvn   += CSWapr-util
RUNTIME_DEP_PKGS_CSWpythonsvn   += CSWbdb48
RUNTIME_DEP_PKGS_CSWpythonsvn   += CSWapr
CHECKPKG_OVERRIDES_CSWpythonsvn += pkgname-does-not-start-with-CSWpy-
CHECKPKG_OVERRIDES_CSWpythonsvn += catalogname-does-not-start-with-py_



DISTFILES += CSWsvn.checkinstall
DISTFILES += CSWap2svn.postinstall CSWap2svn.preremove
DISTFILES += httpd-svn.conf.CSW svn_access.conf.CSW

# Fix: Add java headers for nested classes
# https://lists.ubuntu.com/archives/ubuntu-devel-discuss/2008-June/004633.html
PATCHFILES += javahl_headers_for_nested_classes.diff

# Hardcode location of system wide configuration to /etc/opt/csw/subversion
PATCHFILES += 0001-make-subversion-sysconfigdir-as-it-should-be-for-csw.patch

# Relocate locations of foreign language bindings
PATCHFILES += 0002-Fix-location-of-bindings.patch

SVNLIB     = $(prefix)/lib/svn
JAVA_HOME  = /usr/jdk1.6.0_20

#EXTRA_INC += $(prefix)/apache2/include

#EXTRA_LIB += /opt/csw/apache2/lib
EXTRA_LIB += /opt/csw/bdb48/lib
EXTRA_LIB += $(SVNLIB)
EXTRA_LINKER_FLAGS = -lintl -liconv

# Only add $ISALIST to dirs which ship optimized versions (done by explicitly
# excluding those lib dirs which are known not to ship optimized versions).
RUNPATH_ISALIST  = $(libdir)
#RUNPATH_ISALIST += $(filter-out /opt/csw/apache2/lib $(SVNLIB),$(EXTRA_LIB)) 

#EXTRA_MERGE_EXCLUDE_FILES += .*\.pyo .*\.pyc
#PROTOTYPE_MODIFIERS += cswpycompile
#PROTOTYPE_FILES_cswpycompile = $(libdir)/python/.*\.py
#PROTOTYPE_CLASS_cswpycompile = cswpycompile
PYCOMPILE = 1

# All of the perl modules go to $(libdir)/perl/site_perl. We are not interested
# in the version specific perl directory which only contains a perllocal.pod.
# Can this be re-done as a version agnostic regex? Couldn't get this to work :/
# EXTRA_MERGE_EXCLUDE_FILES += $(libdir)/perl/(?!site_perl)
EXTRA_MERGE_EXCLUDE_FILES += $(libdir)/perl/5.*

STRIP_LIBTOOL = 1

NODIRPATHS      = --libdir --libexecdir
CONFIGURE_ARGS  = $(DIRPATHS) --libdir=$(SVNLIB) --libexecdir=$(SVNLIB)
CONFIGURE_ARGS += --disable-mod-activation
CONFIGURE_ARGS += --with-jdk=/usr/jdk/j2sdk1.4.2_02/j2se
CONFIGURE_ARGS += --enable-javahl
CONFIGURE_ARGS += --with-apr=$(bindir)/apr-1-config
CONFIGURE_ARGS += --with-apr-util=$(bindir)/apu-1-config
CONFIGURE_ARGS += --with-apxs=$(prefix)/apache2/sbin/apxs
CONFIGURE_ARGS += --with-jdk=$(JAVA_HOME)
CONFIGURE_ARGS += --with-sasl=$(prefix)
CONFIGURE_ARGS += --with-ssl=$(prefix)
CONFIGURE_ARGS += --with-zlib=$(prefix)
CONFIGURE_ARGS += --with-serf=$(prefix)

# Once you have verified that a new upstream release passes the tests, you can use
# "SKIPTEST=1 gmake <target>" to skip the tests for simple repackaging tasks.
#
# Tests that fail with XFAIL (eXpected FAILs) are not actual FAILs, see 	
#   http://svn.collab.net/repos/svn/trunk/subversion/tests/README
#
# Tests take about 4hrs on build8x, 2hrs+ on build8s
#   merge_tests.py sub-suite takes most of the time. For a list of its tests see
#     $(WORKSRC)/subversion/tests/cmdline/merge_tests.py --list
#   and for progress information you could compare this with
#     tail -f $(WORKSRC)/tests.log | grep merge_tests.py
TEST_TARGET  = check

include gar/category.mk

BINDING_LANGS   = java perl python ruby
BINDING_TARGETS = $(addprefix svn-,$(BINDING_LANGS))

PI_DEPENDS += copy-templates
PI_DEPENDS += create-ra_dav-symlinks
# TBD: There is no contrib/ in 1.7.0 any more, how to proceed? Other tarball? Or just drop in the future?
# PI_DEPENDS += install-extras
PI_DEPENDS += $(BINDING_TARGETS)

post-install-modulated: $(PI_DEPENDS)
	$(MAKECOOKIE)

# The whole subversion build is done with Sun's cc. Ruby language bindings
# need to be built with gcc. Hack (!) together Makefile.gcc/libtool.gcc which
# are then used in the "svn-ruby" target.
# See http://lists.opencsw.org/pipermail/maintainers/2009-May/002325.html
post-configure-modulated:
	@echo "~~~ Creating GCC Makefile and libtool for ruby ~~~"

	gcp $(WORKSRC)/Makefile $(WORKSRC)/Makefile.gcc
	gcp $(WORKSRC)/libtool $(WORKSRC)/libtool.gcc

	@# -mt\|* effectively strips any occasion of -mt or -mt| out of
	@# libtool.gcc, but what for? -mt is recognized by both Sun's cc
	@# and gcc and is responsible for adding multi-threading support.
	gsed -i \
		-e 's,-mt|*,,' \
		-e 's,-xO3,-pipe -O2,' \
		-e 's,KPIC,fPIC,' \
		-e 's,/opt/SUNWspro/bin/cc,/opt/csw/gcc4/bin/gcc,' \
		-e 's,/opt/SUNWspro/bin/CC,/opt/csw/gcc4/bin/g++,' \
		 $(WORKSRC)/*.gcc
	gsed -i -e 's,libtool,libtool.gcc,' $(WORKSRC)/Makefile.gcc
	gsed -i -e 's,postdeps=.*,postdeps="",' $(WORKSRC)/libtool.gcc
	( if [ "$(GARCH)" = "sparc" ]; then \
    	perl -i -pe 's,-xarch=v8,-mcpu=v8,' $(WORKSRC)/*.gcc; \
	else \
	    perl -i -pe 's,-xarch=386,-march=i386,' $(WORKSRC)/*.gcc; \
	fi )
	@$(MAKECOOKIE)

PI_DEPENDS  = $(BINDING_TARGETS)
PI_DEPENDS += contrib
PI_DEPENDS += rbsvn-prototype
PI_DEPENDS += copy-templates
PI_DEPENDS += install-man

# libsvn_ra_dav-1* has been renamed to libsvn_ra_neon-1* in the new versions
# of subversion (starting with?), we need to link for backward compatability
create-ra_dav-symlinks:
	( cd $(DESTDIR)$(SVNLIB); \
		ln -s libsvn_ra_neon-1.so.0.0.0 libsvn_ra_dav-1.so.0; \
		ln -s libsvn_ra_neon-1.so.0.0.0 libsvn_ra_dav-1.so; )
	@$(MAKECOOKIE)

install-extras:
	@echo "~~~ patching contributions with csw paths ~~~"
	gfind $(WORKSRC)/contrib -type f -print0 | gxargs -0 gsed -i -e 's,/usr/bin/svn,/opt/csw/bin/svn,' 
	gsed -i -e 's,/usr/bin/perl,/opt/csw/bin/perl,' $(WORKSRC)/contrib/*/*.pl
	gsed -i -e 's,/usr/bin/perl,/opt/csw/bin/perl,' $(WORKSRC)/contrib/*/*.cgi
	gsed -i -e 's,/usr/bin/,/opt/csw/bin/,' $(WORKSRC)/contrib/*/svnmirror.sh
	@echo "~~~ install tools and contrib ~~~"
	ginstall -d $(DESTDIR)$(docdir)/subversion/tools
	ginstall -d $(DESTDIR)$(docdir)/subversion/contrib
	gcp -R $(WORKSRC)/tools/* $(DESTDIR)$(docdir)/subversion/tools/
	gcp -R $(WORKSRC)/contrib/* $(DESTDIR)$(docdir)/subversion/contrib/
	$(BUILD_ENV) $(INSTALL_ENV) gmake -C $(WORKSRC) install-tools
	$(BUILD_ENV) $(INSTALL_ENV) gmake -C $(WORKSRC) install-contrib
	@$(MAKECOOKIE)

svn-python:
	@echo " ==> Building Python bindings"
	touch \
		$(WORKSRC)/subversion/bindings/swig/python/*.c \
		$(WORKSRC)/subversion/bindings/swig/python/*.py
	@$(BUILD_ENV)   gmake -C $(WORKSRC) swig-py
	@$(INSTALL_ENV) gmake -C $(WORKSRC) install-swig-py \
		swig_pydir=$(libdir)/python2.3/libsvn \
		swig_pydir_extra=$(libdir)/python2.3/svn
	#@$(TEST_ENV)    gmake -C $(WORKSRC) check-swig-py
	@$(MAKECOOKIE)

svn-perl:
	@echo " ==> Building Perl bindings"
	touch \
		$(WORKSRC)/subversion/bindings/swig/perl/native/*.c \
		$(WORKSRC)/subversion/bindings/swig/perl/native/*.pm
	$(BUILD_ENV)   gmake -C $(WORKSRC) swig-pl
	$(INSTALL_ENV) gmake DESTDIR=$(DESTDIR) -C $(WORKSRC) install-swig-pl
	@$(MAKECOOKIE)

svn-ruby:
	@echo " ==> Building Ruby bindings"
	touch $(WORKSRC)/subversion/bindings/swig/ruby/*.c
	$(BUILD_ENV) gmake -C $(WORKSRC) swig-rb
	$(INSTALL_ENV) gmake -C $(WORKSRC) install-swig-rb
	@$(MAKECOOKIE)

svn-java: EXTRA_LINKER_FLAGS += -norunpath
svn-java:
	@echo " ==> Building Java bindings"
	touch $(WORKSRC)/subversion/bindings/javahl/native/*.c
	$(BUILD_ENV)   gmake -C $(WORKSRC) javahl;
	$(INSTALL_ENV) gmake -C $(WORKSRC) install-javahl;
	@$(MAKECOOKIE)

post-merge: $(foreach P,$(_PKG_SPECS),install-changelog-$P)

$(DESTDIR)$(docdir):
	mkdir -p $@

svnbook: $(DESTDIR)$(docdir)
	@echo " ==> Installing svn book"
	( cd $(WORKSRC)/doc/book ; \
	  ginstall svn-book.html $(DESTDIR)$(docdir) ; \
	  ginstall svn-book.pdf $(DESTDIR)$(docdir) )
	@$(MAKECOOKIE)

contrib: $(DESTDIR)$(docdir)
	@echo " ==> Installing contrib scripts"
	@gcp -vr $(WORKSRC)/contrib $(DESTDIR)$(docdir)
	@$(MAKECOOKIE)

copy-templates:
	ginstall -d $(DESTDIR)$(prefix)/apache2/etc/extra
	ginstall -m 0644 \
		$(WORKDIR)/httpd-svn.conf.CSW \
		$(DESTDIR)$(prefix)/apache2/etc/extra
	ginstall -m 0644 \
		$(WORKDIR)/svn_access.conf.CSW \
		$(DESTDIR)$(prefix)/apache2/etc
	@$(MAKECOOKIE)

install-man:
	ginstall -m 0644 \
		$(WORKSRC)/subversion/svnsync/svnsync.1 \
		$(DESTDIR)$(mandir)/man1
	@$(MAKECOOKIE)

