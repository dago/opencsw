From 841091e29096c14caa93cfeea14248652fb53e23 Mon Sep 17 00:00:00 2001
From: Dagobert Michelsen <dam@opencsw.org>
Date: Sun, 21 Apr 2013 10:27:11 +0200
Subject: [PATCH 3/3] Provide replacement for cfmakeraw

---
 Makefile.am        |  3 +++
 compat.h           |  5 +++++
 compat/cfmakeraw.c | 32 ++++++++++++++++++++++++++++++++
 configure.ac       |  8 ++++++++
 4 files changed, 48 insertions(+)
 create mode 100644 compat/cfmakeraw.c

diff --git a/Makefile.am b/Makefile.am
index 2ce54b1..475ff48 100644
--- a/Makefile.am
+++ b/Makefile.am
@@ -231,6 +231,9 @@ endif
 if NO_B64_NTOP
 nodist_tmux_SOURCES += compat/b64_ntop.c
 endif
+if NO_CFMAKERAW
+nodist_tmux_SOURCES += compat/cfmakeraw.c
+endif
 
 # Update SF web site.
 upload-index.html: update-index.html
diff --git a/compat.h b/compat.h
index 622006e..d397379 100644
--- a/compat.h
+++ b/compat.h
@@ -236,6 +236,11 @@ int		 setenv(const char *, const char *, int);
 int		 unsetenv(const char *);
 #endif
 
+#ifndef HAVE_CFMAKERAW
+/* cfmakeraw.c */
+void		cfmakeraw(struct termios *tio);
+#endif
+
 #ifdef HAVE_GETOPT
 #include <getopt.h>
 #else
diff --git a/compat/cfmakeraw.c b/compat/cfmakeraw.c
new file mode 100644
index 0000000..3f8dc7e
--- /dev/null
+++ b/compat/cfmakeraw.c
@@ -0,0 +1,32 @@
+/* $Id$ */
+
+/*
+ * Copyright (c) 2013 Dagobert Michelsen
+ * Copyright (c) 2013 Nicholas Marriott <nicm@users.sourceforge.net>
+ *
+ * Permission to use, copy, modify, and distribute this software for any
+ * purpose with or without fee is hereby granted, provided that the above
+ * copyright notice and this permission notice appear in all copies.
+ *
+ * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
+ * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
+ * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
+ * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
+ * WHATSOEVER RESULTING FROM LOSS OF MIND, USE, DATA OR PROFITS, WHETHER
+ * IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING
+ * OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
+ */
+
+#include <string.h>
+
+#include "tmux.h"
+
+void
+cfmakeraw(struct termios *tio)
+{
+	tio->c_iflag &= ~(IGNBRK|BRKINT|PARMRK|ISTRIP|INLCR|IGNCR|ICRNL|IXON);
+	tio->c_oflag &= ~OPOST;
+	tio->c_lflag &= ~(ECHO|ECHONL|ICANON|ISIG|IEXTEN);
+	tio->c_cflag &= ~(CSIZE|PARENB);
+	tio->c_cflag |= CS8;
+}
diff --git a/configure.ac b/configure.ac
index f00937f..3a2514b 100644
--- a/configure.ac
+++ b/configure.ac
@@ -313,6 +313,13 @@ if test "x$found_strnvis" = xyes; then
 fi
 AM_CONDITIONAL(NO_VIS, [test "x$found_strnvis" = xno])
 
+# Look for cfmakeraw, compat/cfmakeraw.c used if missing.
+AC_CHECK_FUNC(cfmakeraw, found_cfmakeraw=yes, found_cfmakeraw=no)
+if test "x$found_cfmakeraw" = xyes; then
+	AC_DEFINE(HAVE_CFMAKERAW)
+fi
+AM_CONDITIONAL(NO_CFMAKERAW, [test "x$found_cfmakeraw" = xno])
+
 # Look for getopt. glibc's getopt does not enforce argument order and the ways
 # of making it do so are stupid, so just use our own instead.
 AC_CHECK_FUNC(getopt, found_getopt=yes, found_getopt=no)
@@ -345,6 +352,7 @@ AC_CHECK_FUNCS(
 		dirfd \
 		setproctitle \
 		sysconf \
+		cfmakeraw \
 	]
 )
 
-- 
1.8.1.4

