#
# Copyright 2006 Yann Rouillard <yann@pleiades.fr.eu.org>
# All rights reserved.  Use is subject to license terms.
#
# Redistribution and/or use, with or without modification, is
# permitted.  This code is without warranty of any kind.  The
# author(s) shall not be liable in the event that use of the
# software causes damage.
#
# preremove script which save the current state of 
# services (enabled/disabled/...)
#

# returns the list of frmi defined in a given manifest file
get_fmri_list ()
{
	chroot "$PKG_INSTALL_ROOT" /usr/sbin/svccfg inventory "$1" | awk -F: ' NF > 2 { print $0 }'
}


# returns the current state of the service for smf based launch scripts
read_smf_service_state ()
{
	PERMANENT_STATE=`/usr/sbin/svccfg -s "$1" listprop general/enabled | /usr/bin/awk '{ print $3 }'`
	if [ "$PERMANENT_STATE" != "true" ]; then
		PERMANENT_STATE="disabled"
	else
		PERMANENT_STATE="enabled"
	fi
}


# save the service state in the state file
save_service_state ()
{
	echo "$1 $PERMANENT_STATE" >> "$STATE_FILE"
}


if [ -z "$PKG_INSTALL_ROOT" ]; then 
	PKG_INSTALL_ROOT=/
fi

STATE_FILE="$PKG_INSTALL_ROOT/tmp/$PKG.smfinfo" 
rm -f "$STATE_FILE"

if [ -f "$PKG_INSTALL_ROOT/usr/sbin/svccfg" -a -f "$PKG_INSTALL_ROOT/usr/sbin/svcadm" ]; then

	for FILE in $MANIFEST_FILES; do
		for FMRI in `get_fmri_list "$FILE"`; do
			read_smf_service_state "$FMRI"
			save_service_state "$FMRI"
			chroot "$PKG_INSTALL_ROOT" /usr/sbin/svcadm disable "$FMRI"
		done
	done

else
	for FILE in $INIT_FILES; do
		chroot "$PKG_INSTALL_ROOT" "$FILE" stop
	done

fi

exit 0
