#!/bin/ksh
#
# build_pkgdb - create CSW package name database from makefiles/gspecs
#

GARROOT=${1:-'/export/home/comand/Documents/Work/csw'}

for makefile in `find $GARROOT -mindepth 3 -maxdepth 3 -name Makefile \
    | grep -v meta | sort`
do
    GARDIR=`dirname $makefile`
    GARPKG=`echo $GARDIR | sed -e s,$GARROOT/,,`
    PKGDIR=`basename $GARPKG`
    GARDESC=`nawk '/^DESCRIPTION/{gsub("DESCRIPTION = ","");print}' $makefile`

    [ ! -d $GARDIR/files ] && continue
    for gspec in `find $GARDIR/files -type f -name '*.gspec'`
    do
        unset _GARDESC
        eval `nawk '
            /var.+pkgname/{gsub(".*pkgname +","");print "PKGNAME=\""$0"\""}
            /var.+desc/{gsub(".*desc +","");print "_GARDESC=\""$0"\""}
            /var.+bitname/{gsub(".*bitname +","");print "BITNAME=\""$0"\""}' \
            $gspec`

        [ -z "$PKGNAME"  ] && continue
        [ -n "$_GARDESC" ] && GARDESC=$_GARDESC

        print "$GARPKG|$PKGNAME|$BITNAME - $GARDESC"
    done
done
