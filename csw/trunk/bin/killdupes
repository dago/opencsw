#!/bin/perl -lw

use strict;
use File::Basename;
use Getopt::Std;
use Data::Dumper;
use vars qw/$opt_n/;

getopts ":n";

my %packages;
foreach my $file (@ARGV) {
    my $bn = basename $file;
    my ($pkg,$ver) = split /-/, $bn, 3;
    push @{$packages{$pkg}}, $file;
}

foreach my $pkg (sort keys %packages) {
    if (scalar @{$packages{$pkg}} > 1) {

        # Write dupes out to a tempfile
        my $tfile = "/tmp/kd.$pkg.$$";
        open TFILE, ">>$tfile" or die "Cannot open file: $!";
        print TFILE foreach @{$packages{$pkg}};
        close TFILE;

        # Use ckitem for menu selection
        my @unlink;
        if ($opt_n) {
            my %finfo;
            foreach my $file (@{$packages{$pkg}}) {
                $finfo{$file} = (stat($file))[9];
            }
            @unlink = sort {$finfo{$a} <=> $finfo{$b}} keys %finfo;
            pop @unlink;
        }
        else {
            my ($rst) = `ckitem -p "Keep which file" -f $tfile`;
            unlink $tfile;
            chomp $rst; last if $rst eq 'q';
            @unlink = grep { !/$rst/ } @{$packages{$pkg}};
        }
        foreach (@unlink) { print "unlink: $_" ; unlink or die }

    }
}
